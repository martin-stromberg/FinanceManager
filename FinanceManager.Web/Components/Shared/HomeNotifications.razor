@using System.Net.Http.Json
@inject HttpClient Http
@inject FinanceManager.Shared.IApiClient Api
@inject FinanceManager.Application.ICurrentUserService CurrentUser
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> L
@inject NavigationManager Nav

@if (CurrentUser.IsAuthenticated && _items.Count > 0)
{
    <div class="notif-container" role="region" aria-label="@L["Notifications"]">
        <h4 class="notif-title">@L["Notifications"]</h4>
        @foreach (var n in _items)
        {
            var kind = GetKindClass(n.Type);
            <div class="notif-item @kind">
                <div class="notif-body">
                    <div class="notif-icon"><svg><use href="/icons/sprite.svg#info" /></svg></div>
                    <div class="notif-content">
                        @if (!string.IsNullOrWhiteSpace(n.Title))
                        {
                            <div class="notif-head">@n.Title</div>
                        }
                        <div class="notif-text">@n.Message</div>
                        <div class="notif-meta">@L["ScheduledOn"]: @n.ScheduledDateUtc.ToLocalTime().ToString("d")</div>
                        @if (!string.IsNullOrWhiteSpace(n.TriggerEventKey))
                        {
                            <div class="notif-actions">
                                <button class="icon-btn" @onclick="(() => NavigateToEventAsync(n.TriggerEventKey!))" title="@L["Open"]">
                                    <svg class="icon"><use href="/icons/sprite.svg#external" /></svg>
                                </button>
                            </div>
                        }
                    </div>
                </div>
                <button class="notif-dismiss" title="@L["Dismiss"]" @onclick="(() => DismissAsync(n.Id))">
                    <svg class="ico"><use href="/icons/sprite.svg#close" /></svg>
                </button>
            </div>
        }
    </div>
}

@code {
    private List<NotificationDto> _items = new();

    protected override async Task OnInitializedAsync()
    {
        if (CurrentUser.IsAuthenticated)
        {
            await ReloadAsync();
        }
    }

    private async Task ReloadAsync()
    {
        try
        {
            var result = await Api.Notifications_ListAsync();
            _items = result?.ToList() ?? new List<NotificationDto>();
            _items = _items.Where(n => n.Target == 0 /* HomePage */).ToList();
        }
        catch { }
    }

    private async Task DismissAsync(Guid id)
    {
        try
        {
            var ok = await Api.Notifications_DismissAsync(id);
            if (ok)
            {
                _items.RemoveAll(x => x.Id == id);
            }
        }
        catch { }
        StateHasChanged();
    }

    private static string GetKindClass(int type)
        => type switch
        {
            2 => "warn", // SystemAlert
            _ => "info"   // MonthlyReminder/EventDriven
        };

    private Task NavigateToEventAsync(string key)
    {
        // setup:<section>[?q=...]
        if (key.StartsWith("setup:", StringComparison.OrdinalIgnoreCase))
        {
            var rest = key["setup:".Length..];
            var sep = rest.IndexOf('?');
            var section = sep > 0 ? rest[..sep] : rest;
            var query = sep > 0 ? rest[sep..] : string.Empty;
            Nav.NavigateTo($"/setup{query}");
            return Task.CompletedTask;
        }

        // security:error:<securityId> -> öffnet die Wertpapier-Detailseite
        if (key.StartsWith("security:error:", StringComparison.OrdinalIgnoreCase))
        {
            var idPart = key["security:error:".Length..];
            if (Guid.TryParse(idPart, out var securityId))
            {
                var back = Uri.EscapeDataString(Nav.Uri);
                Nav.NavigateTo($"/securities/{securityId}?back={back}");
            }
            return Task.CompletedTask;
        }

        return Task.CompletedTask;
    }
}
