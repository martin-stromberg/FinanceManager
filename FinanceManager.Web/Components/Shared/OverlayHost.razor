@using FinanceManager.Web.Extensions
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@typeparam TKeyValue

@if (_spec != null && _visible)
{
    <div class="split-center" @onclick="(()=> CloseOverlay())">
        <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                <h3 style="margin:0;font-size:1rem;">@GetOverlayTitle()</h3>
                <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> CloseOverlay())"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
            </div>
            @{ 
                IDictionary<string, object?>? parms = null;
                if (_spec.Parameters != null)
                {
                    parms = _spec.Parameters.Where(kvp => !string.Equals(kvp.Key, "OverlayTitle", StringComparison.OrdinalIgnoreCase)
                                                        && !string.Equals(kvp.Key, "Visible", StringComparison.OrdinalIgnoreCase))
                                .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
                }

                Action overlayClose = CloseOverlay;
                Action<object> overlayOnFinished = obj =>
                {
                    CloseOverlay();
                    _ = NavigationManager.NavigateToModelCard(obj);
                };
            }
            <CascadingValue Name="OverlayClose" Value="@(overlayClose)">
                <CascadingValue Name="OverlayOnFinished" Value="@(overlayOnFinished)">
                    <DynamicComponent Type="_spec.ComponentType" Parameters="parms" />
                </CascadingValue>
            </CascadingValue>
        </div>
    </div>
}

@code {
    [Parameter] public BaseCardViewModel<TKeyValue>? Provider { get; set; }
    [Parameter] public Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages>? Localizer { get; set; }

    private BaseViewModel.UiOverlaySpec? _spec;
    private bool _visible;
    private BaseCardViewModel<TKeyValue>? _subscribed;

    protected override void OnParametersSet()
    {
        if (_subscribed != Provider)
        {
            if (_subscribed != null)
            {
                _subscribed.UiActionRequested -= OnUiActionRequested;
            }
            _subscribed = Provider;
            if (_subscribed != null)
            {
                _subscribed.UiActionRequested += OnUiActionRequested;
            }
        }
    }

    private void OnUiActionRequested(object? sender, BaseViewModel.UiActionEventArgs? e)
    {
        if (e?.PayloadObject is BaseViewModel.UiOverlaySpec spec)
        {
            _spec = spec;
            _visible = spec.Modal; // default visible
            InvokeAsync(StateHasChanged);
        }
    }

    private void CloseOverlay()
    {
        _visible = false;
        _spec = null;
        StateHasChanged();
    }

    private string GetOverlayTitle()
    {
        if (_spec == null) return string.Empty;
        if (_spec.Parameters != null && _spec.Parameters.TryGetValue("OverlayTitle", out var v) && v is string s && !string.IsNullOrWhiteSpace(s)) return s;
        var t = _spec.ComponentType;
        try
        {
            if (t == typeof(FinanceManager.Web.Components.Shared.AttachmentsPanel)) return Localizer?["Attachments_Title"] ?? "Attachments";
            if (t == typeof(FinanceManager.Web.Components.Shared.ContactMergePanel)) return Localizer?["Merge_Title"] ?? "Merge";
            if (t == typeof(FinanceManager.Web.Components.Shared.SecurityPricesBackfillPanel)) return Localizer?["SecurityPricesBackfill_Title"] ?? "Backfill";
        }
        catch { }
        return Localizer?["Attachments_Title"] ?? string.Empty;
    }

    public void Dispose()
    {
        if (_subscribed != null)
            _subscribed.UiActionRequested -= OnUiActionRequested;
    }
}
