@using System.Globalization
@using FinanceManager.Web.ViewModels.Common
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Shared.AggregateBarChart> Localizer

<div class="@($"aggregate-chart-wrapper{(ViewModel?.Compact == true ? " compact" : string.Empty)}")" aria-busy="@_loading">
    @if (!string.IsNullOrWhiteSpace(TitleToShow))
    {
        <h4 class="chart-title">@TitleToShow</h4>
    }
    @if (!(ViewModel?.HideIntervalSelector ?? false))
    {
        <div class="interval-selector">
            <label class="lbl-int">@Localizer["LabelInterval"]:</label>
            <select @bind="_period" @bind:after="LoadAsync" aria-label="@Localizer["Aria_SelectInterval"]">
                <option value="Month">@Localizer["Interval_Month"]</option>
                <option value="Quarter">@Localizer["Interval_Quarter"]</option>
                <option value="HalfYear">@Localizer["Interval_HalfYear"]</option>
                <option value="Year">@Localizer["Interval_Year"]</option>
                <option value="AllHistory">@Localizer["Interval_AllHistory"]</option>
            </select>
        </div>
    }

    <div class="chart" style="--bar-color:@(ViewModel?.PositiveColor ?? "#2d6cdf");--bar-neg:@(ViewModel?.NegativeColor ?? "#c94");--axis:@(ViewModel?.AxisColor ?? "#555");">
        @if (_loading && _data.Count == 0)
        {
            <div class="chart-skeleton" role="status" aria-live="polite" style="height:@(ViewModel?.BarsHeightPx ?? (ViewModel?.Compact == true ? 100 : 180))px;">
                @for (int i=0;i<10;i++)
                {
                    <div class="skeleton-bar" style="animation-delay:@(i*0.06)s"></div>
                }
                <div class="skeleton-labels">
                    @for (int i=0;i<10;i++)
                    {
                        <div class="skeleton-label"></div>
                    }
                </div>
                <span class="visually-hidden">@Localizer["Loading"]</span>
            </div>
        }
        else if (_data.Count == 0)
        {
            <div class="nodata">@Localizer["NoData"]</div>
        }
        else
        {
            var maxAbs = _data.Select(p => Math.Abs(p.Amount)).DefaultIfEmpty(0m).Max();
            var barsHeight = (ViewModel?.BarsHeightPx ?? (ViewModel?.Compact == true ? 100 : 180));
            var halfHeight = (decimal)barsHeight / 2m;
            var scale = maxAbs == 0 ? 0 : halfHeight / maxAbs;

            <div class="bars-wrapper" style="height:@(barsHeight)px;">
                <div class="bar-row pos">
                    @foreach (var p in _data)
                    {
                        var h = p.Amount > 0 ? (int)Math.Round((double)(p.Amount * scale)) : 0;
                        <div class="bar bar-pos"
                             role="img"
                             aria-label="@BuildAria(p)"
                             title="@BuildTooltip(p)"
                             style="height:@(h)px;"></div>
                    }
                </div>
                <div class="zero-line"></div>
                <div class="bar-row neg">
                    @foreach (var p in _data)
                    {
                        var h = p.Amount < 0 ? (int)Math.Round((double)(-p.Amount * scale)) : 0;
                        <div class="bar bar-neg"
                             role="img"
                             aria-label="@BuildAria(p)"
                             title="@BuildTooltip(p)"
                             style="height:@(h)px;"></div>
                    }
                </div>
            </div>

            <div class="labels-row">
                @{ int idx=0; foreach (var p in _data) { bool show = ShouldShowLabel(idx, _data.Count); <div class="lbl @(show?string.Empty:"skip")" aria-hidden="@(show? "false":"true")">@FormatLabel(p.PeriodStart)</div>; idx++; } }
            </div>

            @if (_loading)
            {
                <div class="chart-loading-overlay" role="status" aria-live="polite">
                    <div class="spinner">
                        <div class="seg a"></div>
                        <div class="seg b"></div>
                        <div class="seg c"></div>
                        <div class="seg d"></div>
                    </div>
                    <span class="loading-text">@Localizer["Loading"]</span>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter] public AggregateBarChartViewModel? ViewModel { get; set; }

    private string _period = "Month";
    private bool _loading;
    private bool _multipleYears;
    private readonly List<Point> _data = new();
    private string? TitleToShow => ViewModel?.Title;

    private sealed record Point(DateTime PeriodStart, decimal Amount);

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(ViewModel?.InitialPeriod))
        {
            _period = ViewModel!.InitialPeriod!;
        }
        if (ViewModel != null)
        {
            // initialize from VM
            MapFromViewModel();
            if ((_data.Count == 0) || ViewModel.Loading)
            {
                await ViewModel.LoadAsync(_period);
                MapFromViewModel();
            }
        }
    }

    private bool ShouldShowLabel(int index, int total)
    {
        var autoFit = ViewModel?.AutoFit ?? true;
        var maxLabels = ViewModel?.MaxVisibleLabels ?? 18;
        if (!autoFit) { return true; }
        if (total <= maxLabels) { return true; }
        int step = (int)Math.Ceiling(total / (double)maxLabels);
        return index % step == 0;
    }

    private void MapFromViewModel()
    {
        _data.Clear();
        if (ViewModel?.Data != null)
        {
            foreach (var p in ViewModel.Data)
            {
                _data.Add(new Point(p.PeriodStart, p.Amount));
            }
            _multipleYears = ViewModel.MultipleYears;
            _loading = ViewModel.Loading;
        }
        else
        {
            _multipleYears = false;
            _loading = false;
        }
        StateHasChanged();
    }

    private async Task LoadAsync()
    {
        if (ViewModel == null) return;
        await ViewModel.LoadAsync(_period);
        MapFromViewModel();
    }

    private string FormatLabel(DateTime d)
    {
        // Culture-aware compact labeling
        var culture = CultureInfo.CurrentUICulture;
        switch (_period)
        {
            case "Month":
                // Use abbreviated month name; append year if multiple years present or first month of year when mixing
                var monthName = culture.DateTimeFormat.GetAbbreviatedMonthName(d.Month);
                if (_multipleYears || d.Month == 1)
                {
                    return string.Concat(monthName, " ", d.ToString("yy", culture));
                }
                return monthName;
            case "Quarter":
                var q = ((d.Month - 1) / 3) + 1;
                return _multipleYears ? $"Q{q} {d:yy}" : $"Q{q}";
            case "HalfYear":
                var h = d.Month <= 6 ? 1 : 2;
                return _multipleYears ? $"H{h} {d:yy}" : $"H{h}";
            case "Year":
                return d.ToString("yyyy", culture);
            default:
                return d.ToString("d", culture);
        }
    }

    private string BuildTooltip(Point p)
    {
        var culture = CultureInfo.CurrentUICulture;
        if (string.Equals(_period, "Quarter", StringComparison.OrdinalIgnoreCase))
        {
            var q = ((p.PeriodStart.Month - 1) / 3) + 1;
            return string.Format(culture, "{0:yyyy}-Q{1} ({2})", p.PeriodStart, q, p.Amount.ToString("N2", culture));
        }
        if (string.Equals(_period, "HalfYear", StringComparison.OrdinalIgnoreCase))
        {
            var h = p.PeriodStart.Month <= 6 ? 1 : 2;
            return string.Format(culture, "{0:yyyy}-H{1} ({2})", p.PeriodStart, h, p.Amount.ToString("N2", culture));
        }
        if (string.Equals(_period, "Year", StringComparison.OrdinalIgnoreCase))
        {
            return string.Format(culture, "{0:yyyy} ({1})", p.PeriodStart, p.Amount.ToString("N2", culture));
        }
        // Month
        var dateStr = p.PeriodStart.ToString("d", culture);
        return string.Format(culture, "{0} ({1})", dateStr, p.Amount.ToString("N2", culture));
    }

    private string BuildAria(Point p) => Localizer["AriaBar", p.PeriodStart.ToString("yyyy-MM-dd"), p.Amount];

    private sealed class TimeSeriesResponse { public DateTime PeriodStart { get; set; } public decimal Amount { get; set; } }
}
