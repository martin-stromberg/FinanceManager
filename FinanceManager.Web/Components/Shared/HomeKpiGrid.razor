@using System.Net.Http.Json
@using FinanceManager.Application.Reports
@using FinanceManager.Domain.Reports
@using FinanceManager.Shared.Dtos.Postings
@using FinanceManager.Shared.Dtos.Reports
@using FinanceManager.Shared.Dtos.HomeKpi
@using FinanceManager.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Localization

@inject FinanceManager.Shared.IApiClient Api
@inject IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject NavigationManager Nav
@inject IServiceProvider Services

<div class="kpi-grid">
    @foreach (var k in _kpis.OrderBy(x => x.SortOrder).ThenBy(x => x.CreatedUtc))
    {
        <div class="kpi-tile">
            @if (EditMode)
            {
                <button type="button" class="kpi-delete" title="@Localizer["Delete"]" @onclick="(()=> DeleteKpiAsync(k.Id))">
                    <svg class="ico"><use href="/icons/sprite.svg#close" /></svg>
                </button>
                <div class="kpi-order">
                    <button type="button" class="kpi-move" title="@Localizer["MoveLeft"]" disabled="@_kpiMoving.Contains(k.Id)" @onclick="(()=> MoveKpiAsync(k, -1))">
                        <svg class="ico"><use href="/icons/sprite.svg#arrow-left" /></svg>
                    </button>
                    <button type="button" class="kpi-move" title="@Localizer["MoveRight"]" disabled="@_kpiMoving.Contains(k.Id)" @onclick="(()=> MoveKpiAsync(k, 1))">
                        <svg class="ico"><use href="/icons/sprite.svg#arrow-right" /></svg>
                    </button>
                </div>
            }

            @RenderKpiTile(k)
        </div>
    }

    @if (EditMode)
    {
        <button type="button" class="kpi-tile add-tile" @onclick="OpenAddKpiDialog" title="@Localizer["AddKpi"]">
            <svg class="add-ico"><use href="/icons/sprite.svg#plus"/></svg>
        </button>
    }
</div>

@if (_showAddKpiDialog)
{
    <div class="modal-overlay" @onclick="(()=> _showAddKpiDialog = false)">
        <div class="modal kpi-modal" @onclick:stopPropagation="true">
            <h3>@Localizer["AddKpi_Title"]</h3>
            <div class="tabs-bar" role="tablist">
                <button type="button" class="@( !_addTabFavorites ? "tab-btn active" : "tab-btn")" role="tab" aria-selected="@(!_addTabFavorites)" @onclick="(()=> { _addTabFavorites = false; StateHasChanged(); })">@Localizer["Kpi_Tab_Predefined"]</button>
                <button type="button" class="@( _addTabFavorites ? "tab-btn active" : "tab-btn")" role="tab" aria-selected="@_addTabFavorites" @onclick="(()=> { _addTabFavorites = true; StateHasChanged(); })">@Localizer["Kpi_Tab_Favorites"]</button>
            </div>
            @if(!_addTabFavorites)
            {
                <div class="option-list">
                    @foreach (var p in Enum.GetValues<HomeKpiPredefined>())
                    {
                        var label = p switch
                        {
                            HomeKpiPredefined.AccountsAggregates => Localizer["Chart_Title_AllAccounts"],
                            HomeKpiPredefined.SavingsPlanAggregates => Localizer["Chart_Title_MonthlySaving"],
                            HomeKpiPredefined.SecuritiesDividends => Localizer["Chart_Title_DividendsQuarterly"],
                            HomeKpiPredefined.ActiveSavingsPlansCount => Localizer["Kpi_ActiveSavingsPlansCount"],
                            HomeKpiPredefined.ContactsCount => Localizer["Kpi_ContactsCount"],
                            HomeKpiPredefined.SecuritiesCount => Localizer["Kpi_SecuritiesCount"],
                            HomeKpiPredefined.OpenStatementDraftsCount => Localizer["Kpi_OpenStatementDraftsCount"],
                            _ => Localizer["KPI"]
                        };
                        <label class="mk-item line"><input type="radio" name="predef" checked="@(_selPredefined==p)" @onchange="_=> _selPredefined = p" /> @label</label>
                    }
                </div>
            }
            else
            {
                <div class="scroll-box option-list">
                    @if (_favorites.Count == 0)
                    {
                        <div class="small-empty">@Localizer["NoData"]</div>
                    }
                    else
                    {
                        @foreach (var f in _favorites)
                        {
                            <label class="mk-item line"><input type="radio" name="fav" checked="@(_selFavoriteId==f.Id)" @onchange="_=> _selFavoriteId = f.Id" /> @f.Name</label>
                        }
                    }
                </div>
            }
            @if(_addTabFavorites)
            {
                <div class="row">
                    <div class="group-title">@Localizer["Kpi_Display"]</div>
                    <label class="mk-item line"><input type="radio" name="disp" checked="@(_selDisplay==HomeKpiDisplayMode.TotalOnly)" @onchange="_=> _selDisplay = HomeKpiDisplayMode.TotalOnly" /> @Localizer["Kpi_Display_TotalOnly"]</label>
                    <label class="mk-item line"><input type="radio" name="disp" checked="@(_selDisplay==HomeKpiDisplayMode.TotalWithComparisons)" @onchange="_=> _selDisplay = HomeKpiDisplayMode.TotalWithComparisons" /> @Localizer["Kpi_Display_TotalWithComparisons"]</label>
                    <label class="mk-item line"><input type="radio" name="disp" checked="@(_selDisplay==HomeKpiDisplayMode.ReportGraph)" @onchange="_=> _selDisplay = HomeKpiDisplayMode.ReportGraph" /> @Localizer["Kpi_Display_ReportGraph"]</label>
                </div>
            }
            <div class="dialog-actions">
                <button class="btn" @onclick="AddKpiAsync" disabled="@(_addTabFavorites && !_selFavoriteId.HasValue)">@Localizer["Dialog_Add"]</button>
                <button class="btn secondary" @onclick="(()=> _showAddKpiDialog=false)">@Localizer["Dialog_Cancel"]</button>
            </div>
        </div>
    </div>
}

@code
{
    [Parameter] public bool EditMode { get; set; }

    private List<HomeKpiDto> _kpis = new();
    private Dictionary<Guid, FavKpiData> _favData = new();
    private HashSet<Guid> _favLoading = new();
    private HashSet<Guid> _kpiMoving = new();

    private bool _showAddKpiDialog;
    private bool _addTabFavorites;
    private HomeKpiPredefined _selPredefined = HomeKpiPredefined.AccountsAggregates;
    private HomeKpiDisplayMode _selDisplay = HomeKpiDisplayMode.TotalOnly;
    private Guid? _selFavoriteId;
    private List<ReportFavoriteDto> _favorites = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadKpisAsync();
    }

    private async Task LoadKpisAsync()
    {
        try
        {
            var list = await Api.HomeKpis_ListAsync();
            _kpis = list.ToList();
        }
        catch { }
        StateHasChanged();
    }

    private void OpenAddKpiDialog()
    {
        _addTabFavorites = false;
        _selPredefined = HomeKpiPredefined.AccountsAggregates;
        _selDisplay = HomeKpiDisplayMode.TotalOnly;
        _selFavoriteId = null;
        _showAddKpiDialog = true;
        _ = EnsureFavoritesLoadedAsync();
    }

    private async Task EnsureFavoritesLoadedAsync()
    {
        try
        {
            var list = await Api.Reports_ListFavoritesAsync();
            _favorites = (list ?? Array.Empty<ReportFavoriteDto>()).OrderBy(f => f.Name).ToList();
        }
        catch { }
        StateHasChanged();
    }

    private async Task AddKpiAsync()
    {
        var sort = _kpis.Count == 0 ? 0 : _kpis.Max(k => k.SortOrder) + 1;
        var kind = _addTabFavorites ? HomeKpiKind.ReportFavorite : HomeKpiKind.Predefined;
        var payload = new HomeKpiCreateRequest(kind, _addTabFavorites ? _selFavoriteId : null, _addTabFavorites ? null : _selPredefined, null, _selDisplay, sort);
        try
        {
            var dto = await Api.HomeKpis_CreateAsync(payload);
            if (dto != null) { _kpis.Add(dto); }
        }
        catch { }
        finally
        {
            _showAddKpiDialog = false; StateHasChanged();
        }
    }

    private async Task DeleteKpiAsync(Guid id)
    {
        try
        {
            var ok = await Api.HomeKpis_DeleteAsync(id);
            if (ok)
            {
                _kpis.RemoveAll(k => k.Id == id);
                _favData.Remove(id);
            }
        }
        catch { }
        StateHasChanged();
    }

    private async Task MoveKpiAsync(HomeKpiDto kpi, int delta)
    {
        try
        {
            var ordered = _kpis.OrderBy(x => x.SortOrder).ThenBy(x => x.CreatedUtc).ToList();
            var idx = ordered.FindIndex(x => x.Id == kpi.Id);
            if (idx < 0) { return; }
            var targetIdx = idx + delta;
            if (targetIdx < 0 || targetIdx >= ordered.Count) { return; }
            var other = ordered[targetIdx];

            var aNew = other.SortOrder;
            var bNew = kpi.SortOrder;

            _kpiMoving.Add(kpi.Id); _kpiMoving.Add(other.Id);

            var iKpi = _kpis.FindIndex(x => x.Id == kpi.Id);
            var iOther = _kpis.FindIndex(x => x.Id == other.Id);
            if (iKpi >= 0) { _kpis[iKpi] = kpi with { SortOrder = aNew }; }
            if (iOther >= 0) { _kpis[iOther] = other with { SortOrder = bNew }; }
            StateHasChanged();

            var reqA = new HomeKpiUpdateRequest(kpi.Kind, kpi.ReportFavoriteId, kpi.PredefinedType, kpi.Title, kpi.DisplayMode, aNew);
            var reqB = new HomeKpiUpdateRequest(other.Kind, other.ReportFavoriteId, other.PredefinedType, other.Title, other.DisplayMode, bNew);

            var dtoA = await Api.HomeKpis_UpdateAsync(kpi.Id, reqA);
            var dtoB = await Api.HomeKpis_UpdateAsync(other.Id, reqB);

            if (dtoA != null && dtoB != null)
            {
                var iA = _kpis.FindIndex(x => x.Id == dtoA.Id);
                if (iA >= 0) { _kpis[iA] = dtoA; }
                var iB = _kpis.FindIndex(x => x.Id == dtoB.Id);
                if (iB >= 0) { _kpis[iB] = dtoB; }
            }
            else
            {
                if (iKpi >= 0) { _kpis[iKpi] = kpi; }
                if (iOther >= 0) { _kpis[iOther] = other; }
            }
        }
        catch { }
        finally
        {
            _kpiMoving.Clear();
            StateHasChanged();
        }
    }

    private async Task OnTitleChangedAsync(HomeKpiDto k, string? newTitle)
    {
        try
        {
            var req = new HomeKpiUpdateRequest(k.Kind, k.ReportFavoriteId, k.PredefinedType, newTitle, k.DisplayMode, k.SortOrder);
            var updated = await Api.HomeKpis_UpdateAsync(k.Id, req);
            if (updated != null)
            {
                var idx = _kpis.FindIndex(x => x.Id == k.Id);
                if (idx >= 0) { _kpis[idx] = updated; }
            }
        }
        catch { }
        StateHasChanged();
    }

    private RenderFragment RenderKpiTile(HomeKpiDto k) => builder =>
    {
        var i = 0;

        if (k.Kind == HomeKpiKind.Predefined)
        {
            var predefined = k.PredefinedType ?? (HomeKpiPredefined)(k.SortOrder % 3);
            var titleDefault = predefined switch
            {
                HomeKpiPredefined.AccountsAggregates => Localizer["Chart_Title_AllAccounts"],
                HomeKpiPredefined.SavingsPlanAggregates => Localizer["Chart_Title_MonthlySaving"],
                HomeKpiPredefined.SecuritiesDividends => Localizer["Chart_Title_DividendsQuarterly"],
                HomeKpiPredefined.ActiveSavingsPlansCount => Localizer["Kpi_ActiveSavingsPlansCount"],
                HomeKpiPredefined.ContactsCount => Localizer["Kpi_ContactsCount"],
                HomeKpiPredefined.SecuritiesCount => Localizer["Kpi_SecuritiesCount"],
                HomeKpiPredefined.OpenStatementDraftsCount => Localizer["Kpi_OpenStatementDraftsCount"],
                _ => Localizer["KPI"]
            };
            var title = string.IsNullOrWhiteSpace(k.Title) ? titleDefault : k.Title;

            builder.OpenElement(i++, "div");
            builder.AddAttribute(i++, "class", "kpi-content");
            builder.OpenElement(i++, "h4");
            if (EditMode)
            {
                builder.OpenElement(i++, "input");
                builder.AddAttribute(i++, "class", "kpi-title-input");
                builder.AddAttribute(i++, "value", title);
                builder.AddAttribute(i++, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, (ChangeEventArgs e) => OnTitleChangedAsync(k, e?.Value?.ToString())));
                builder.CloseElement();
            }
            else
            {
                builder.AddContent(i++, title);
            }
            builder.CloseElement();

            switch (predefined)
            {
                case HomeKpiPredefined.AccountsAggregates:
                    {
                        var vm = new AggregateBarChartViewModel(Services, "/api/accounts/aggregates", null, 7, null);
                        vm.HideIntervalSelector = true;
                        vm.InitialPeriod = "Month";
                        vm.Compact = true;
                        vm.BarsHeightPx = 110;
                        builder.OpenComponent<AggregateBarChart>(i++);
                        builder.AddAttribute(i++, "ViewModel", vm);
                        builder.CloseComponent();
                    }
                    break;
                case HomeKpiPredefined.SavingsPlanAggregates:
                    {
                        var vm = new AggregateBarChartViewModel(Services, "/api/savings-plans/aggregates", null, 7, null);
                        vm.HideIntervalSelector = true;
                        vm.InitialPeriod = "Month";
                        vm.PositiveColor = "#2d9d4f";
                        vm.NegativeColor = "#b55";
                        vm.Compact = true;
                        vm.BarsHeightPx = 110;
                        builder.OpenComponent<AggregateBarChart>(i++);
                        builder.AddAttribute(i++, "ViewModel", vm);
                        builder.CloseComponent();
                    }
                    break;
                case HomeKpiPredefined.SecuritiesDividends:
                    {
                        var vm = new AggregateBarChartViewModel(Services, "/api/securities/dividends", null, null, null);
                        vm.HideIntervalSelector = true;
                        vm.InitialPeriod = "Quarter";
                        vm.PositiveColor = "#d4a72c";
                        vm.NegativeColor = "#b55";
                        vm.Compact = true;
                        vm.BarsHeightPx = 110;
                        builder.OpenComponent<AggregateBarChart>(i++);
                        builder.AddAttribute(i++, "ViewModel", vm);
                        builder.CloseComponent();
                    }
                    break;
                case HomeKpiPredefined.ActiveSavingsPlansCount:
                    builder.OpenElement(i++, "svg"); builder.AddAttribute(i++, "class", "kpi-bg-ico kpi-savings"); builder.AddMarkupContent(i++, "<use href='/icons/sprite.svg#save' />"); builder.CloseElement();
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-body");
                    builder.OpenElement(i++, "a");
                    builder.AddAttribute(i++, "href", "/list/savings-plans");
                    builder.AddAttribute(i++, "class", "kpi-number-link kpi-savings");
                    builder.AddAttribute(i++, "title", Localizer["Kpi_ActiveSavingsPlansCount"]);
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-number");
                    builder.AddContent(i++, (RenderFragment)(builder2 =>
                    {
                        var j = 0;
                        builder2.OpenComponent<NumericKpi>(j++);
                        builder2.AddAttribute(j++, "Load", (Func<Task<int>>)(async () => { try { var cnt = await Api.SavingsPlans_CountAsync(true); return cnt; } catch { return 0; } }));
                        builder2.CloseComponent();
                    }));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    break;
                case HomeKpiPredefined.ContactsCount:
                    builder.OpenElement(i++, "svg"); builder.AddAttribute(i++, "class", "kpi-bg-ico kpi-contacts"); builder.AddMarkupContent(i++, "<use href='/icons/sprite.svg#groups' />"); builder.CloseElement();
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-body");
                    builder.OpenElement(i++, "a");
                    builder.AddAttribute(i++, "href", "/list/contacts");
                    builder.AddAttribute(i++, "class", "kpi-number-link kpi-contacts");
                    builder.AddAttribute(i++, "title", Localizer["Kpi_ContactsCount"]);
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-number");
                    builder.AddContent(i++, (RenderFragment)(builder2 =>
                    {
                        var j = 0;
                        builder2.OpenComponent<NumericKpi>(j++);
                        builder2.AddAttribute(j++, "Load", (Func<Task<int>>)(async () => { try { var cnt = await Api.Contacts_CountAsync(); return cnt; } catch { return 0; } }));
                        builder2.CloseComponent();
                    }));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    break;
                case HomeKpiPredefined.SecuritiesCount:
                    builder.OpenElement(i++, "svg"); builder.AddAttribute(i++, "class", "kpi-bg-ico kpi-securities"); builder.AddMarkupContent(i++, "<use href='/icons/sprite.svg#postings' />"); builder.CloseElement();
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-body");
                    builder.OpenElement(i++, "a");
                    builder.AddAttribute(i++, "href", "/list/securities");
                    builder.AddAttribute(i++, "class", "kpi-number-link kpi-securities");
                    builder.AddAttribute(i++, "title", Localizer["Kpi_SecuritiesCount"]);
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-number");
                    builder.AddContent(i++, (RenderFragment)(builder2 =>
                    {
                        var j = 0;
                        builder2.OpenComponent<NumericKpi>(j++);
                        builder2.AddAttribute(j++, "Load", (Func<Task<int>>)(async () => { try { var cnt = await Api.Securities_CountAsync(true); return cnt; } catch { return 0; } }));
                        builder2.CloseComponent();
                    }));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    break;
                case HomeKpiPredefined.OpenStatementDraftsCount:
                    builder.OpenElement(i++, "svg"); builder.AddAttribute(i++, "class", "kpi-bg-ico kpi-drafts"); builder.AddMarkupContent(i++, "<use href='/icons/sprite.svg#upload' />"); builder.CloseElement();
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-body");
                    builder.OpenElement(i++, "a");
                    builder.AddAttribute(i++, "href", "/list/statement-drafts");
                    builder.AddAttribute(i++, "class", "kpi-number-link kpi-drafts");
                    builder.AddAttribute(i++, "title", Localizer["Kpi_OpenStatementDraftsCount"]);
                    builder.OpenElement(i++, "div");
                    builder.AddAttribute(i++, "class", "kpi-number");
                    builder.AddContent(i++, (RenderFragment)(builder2 =>
                    {
                        var j = 0;
                        builder2.OpenComponent<NumericKpi>(j++);
                        builder2.AddAttribute(j++, "Load", (Func<Task<int>>)(async () => { try { var cnt = await Api.StatementDrafts_GetOpenCountAsync(); return cnt; } catch { return 0; } }));
                        builder2.CloseComponent();
                    }));
                    builder.CloseElement();
                    builder.CloseElement();
                    builder.CloseElement();
                    break;
            }
            builder.CloseElement();
            return;
        }

        var name = string.IsNullOrWhiteSpace(k.Title) ? (k.ReportFavoriteName ?? Localizer["Favorite"]) : k.Title;

        builder.OpenElement(i++, "div");
        builder.AddAttribute(i++, "class", "fav-kpi");

        builder.OpenElement(i++, "h4");
        if (EditMode)
        {
            builder.OpenElement(i++, "input");
            builder.AddAttribute(i++, "class", "kpi-title-input");
            builder.AddAttribute(i++, "value", name);
            builder.AddAttribute(i++, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, (ChangeEventArgs e) => OnTitleChangedAsync(k, e?.Value?.ToString())));
            builder.CloseElement();
        }
        else
        {
            builder.AddAttribute(i++, "class", "clickable");
            builder.AddAttribute(i++, "title", Localizer["OpenReport"]);
            builder.AddAttribute(i++, "onclick", EventCallback.Factory.Create<MouseEventArgs>(this, () => OnOpenFavorite(k)));
            builder.AddContent(i++, name);
        }
        builder.CloseElement();

        if (!_favData.ContainsKey(k.Id) && !_favLoading.Contains(k.Id))
        {
            _favLoading.Add(k.Id);
            _ = LoadFavoriteKpiDataAsync(k);
        }

        if (_favData.TryGetValue(k.Id, out var data))
        {
            var series = data.Series?.Select(p => new ReportKpiTile.Point(p.Date, p.Amount)).ToList()
                        ?? new List<ReportKpiTile.Point>();

            builder.OpenComponent<ReportKpiTile>(i++);
            builder.AddAttribute(i++, "DisplayMode", k.DisplayMode);
            builder.AddAttribute(i++, "Amount", data.Amount);
            builder.AddAttribute(i++, "Prev", data.Prev);
            builder.AddAttribute(i++, "Year", data.Year);
            builder.AddAttribute(i++, "Series", series);
            builder.AddAttribute(i++, "PrimaryKind", data.Kind);
            builder.AddAttribute(i++, "Clickable", !EditMode);
            builder.AddAttribute(i++, "OnClick", EventCallback.Factory.Create(this, () => OnOpenFavorite(k)));
            builder.CloseComponent();
        }
        else
        {
            builder.OpenElement(i++, "div"); builder.AddAttribute(i++, "class", "small-loading"); builder.AddContent(i++, Localizer["Loading"]); builder.CloseElement();
        }

        builder.CloseElement();
    };

    private void OnOpenFavorite(HomeKpiDto k)
    {
        if (k.Kind == HomeKpiKind.ReportFavorite && k.ReportFavoriteId.HasValue)
        {
            Nav.NavigateTo($"/reports/dashboard?favoriteId={k.ReportFavoriteId.Value}&edit=false");
        }
    }

    private async Task LoadFavoriteKpiDataAsync(HomeKpiDto k)
    {
        try
        {
            if (!k.ReportFavoriteId.HasValue) { return; }
            var fav = await Api.Reports_GetFavoriteAsync(k.ReportFavoriteId.Value);
            if (fav == null) { return; }
            var disablePrev = fav.Interval == ReportInterval.Ytd || fav.Interval == ReportInterval.Year;
            var req = new ReportAggregatesQueryRequest(
                fav.PostingKind,
                fav.Interval,
                fav.Take,
                fav.IncludeCategory,
                disablePrev ? false : fav.ComparePrevious,
                fav.CompareYear,
                fav.UseValutaDate,
                fav.PostingKinds?.Count > 0 ? fav.PostingKinds : null,
                null,
                fav.Filters == null ? null : new ReportAggregatesFiltersRequest(
                    fav.Filters.AccountIds, fav.Filters.ContactIds, fav.Filters.SavingsPlanIds, fav.Filters.SecurityIds,
                    fav.Filters.ContactCategoryIds, fav.Filters.SavingsPlanCategoryIds, fav.Filters.SecurityCategoryIds, fav.Filters.SecuritySubTypes,
                    fav.Filters.IncludeDividendRelated)
            );
            var agg = await Api.Reports_QueryAggregatesAsync(req);
            if (agg == null) { return; }
            var points = (agg.Points ?? new List<ReportAggregatePointDto>()).OrderBy(p => p.GroupKey).ThenBy(p => p.PeriodStart).ToList();
            var series = points.Where(p => p.ParentGroupKey == null || p.GroupKey.StartsWith("Type:"))
                               .GroupBy(p => p.PeriodStart)
                               .Select(g => new SeriesPoint(g.Key, g.Where(x => x.ParentGroupKey == null || x.GroupKey.StartsWith("Type:")).Sum(x => x.Amount)))
                               .OrderBy(x => x.Date).ToList();
            var last = series.LastOrDefault();
            decimal amount = last?.Amount ?? 0m;
            decimal? prev = null; decimal? year = null;
            if (fav.ComparePrevious && !disablePrev)
            {
                prev = points.Where(p => p.ParentGroupKey == null || p.GroupKey.StartsWith("Type:"))
                              .Where(p => p.PreviousAmount.HasValue)
                              .GroupBy(p => p.PeriodStart)
                              .OrderBy(g => g.Key).LastOrDefault()?
                              .Where(p => p.PreviousAmount.HasValue).Sum(p => p.PreviousAmount!.Value);
            }
            if (fav.CompareYear)
            {
                year = points.Where(p => p.ParentGroupKey == null || p.GroupKey.StartsWith("Type:"))
                              .Where(p => p.YearAgoAmount.HasValue)
                              .GroupBy(p => p.PeriodStart)
                              .OrderBy(g => g.Key).LastOrDefault()?
                              .Where(p => p.YearAgoAmount.HasValue).Sum(p => p.YearAgoAmount!.Value);
            }
            _favData[k.Id] = new FavKpiData(amount, prev, year, series, (int)fav.PostingKind);
        }
        catch { }
        finally
        {
            _favLoading.Remove(k.Id);
            StateHasChanged();
        }
    }

    private sealed record FavKpiData(decimal Amount, decimal? Prev, decimal? Year, List<SeriesPoint> Series, int Kind);
    private sealed record SeriesPoint(DateTime Date, decimal Amount);
}