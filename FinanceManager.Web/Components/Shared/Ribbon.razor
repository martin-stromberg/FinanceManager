@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels
@typeparam TTabEnum

@if ((TabsToRender)?.Any() == true)
{
    var tabs = TabsToRender!;
    var singleTab = tabs.Count == 1;

    // Determine current ActiveTab: prefer provider's active tab when available
    var providerActive = default(TTabEnum);
    bool providerHas = false;
    if (Provider is IRibbonProvider rp)
    {
        var vObj = (object?)rp.GetActiveTab<TTabEnum>();
        if (vObj != null)
        {
            providerActive = (TTabEnum)vObj;
            providerHas = true;
        }
    }

    var active = providerHas ? providerActive : ActiveTab;
    var activeIndex = tabs.FindIndex(t => EqualityComparer<TTabEnum>.Default.Equals(t.Id, active));
    if (activeIndex < 0) { activeIndex = 0; }

    <div class="fm-ribbon @(singleTab?"single-tab":"")" role="region" aria-label="@AriaLabel">
        @if(!singleTab)
        {
            <ul class="fm-ribbon-tabs" role="tablist" aria-label="@AriaTabsLabel">
                @for (var i = 0; i < tabs.Count; i++)
                {
                    var t = tabs[i];
                    var isActive = i == activeIndex;
                    var tabId = $"ribbon-tab-{i}";
                    var panelId = $"ribbon-panel-{i}";
                    <li class="@(isActive ? "active" : "")" role="presentation">
                        <button type="button"
                                id="@tabId"
                                role="tab"
                                aria-selected="@isActive"
                                aria-controls="@panelId"
                                tabindex="@(isActive?"0":"-1")"
                                @onclick="(() => SelectTab(t.Id))"
                                @onkeydown="(e)=>OnTabKeyDown(e,i)">
                            @t.Title
                        </button>
                    </li>
                }
            </ul>
        }
        <div class="fm-ribbon-content" role="tabpanel" id="ribbon-panel-@activeIndex" aria-labelledby="ribbon-tab-@activeIndex">
            @if (CurrentGroups != null)
            {
                <div class="fm-ribbon-groups" role="toolbar" aria-label="@AriaGroupsLabel">
                    @foreach (var (g, gIndex) in CurrentGroups.Select((g,i)=>(g,i)))
                    {
                        var groupLabelId = $"ribbon-group-label-{activeIndex}-{gIndex}";
                        <div class="fm-ribbon-group" role="group" aria-labelledby="@groupLabelId">
                            <div class="fm-ribbon-group-body ribbon-items-grid">
                                @foreach (var item in g.Items)
                                {
                                    <button id="@item.Id" disabled="@item.Disabled"
                                            aria-disabled="@(item.Disabled ? "true" : null)"
                                            aria-label="@item.Label"
                                            title="@(!string.IsNullOrWhiteSpace(item.Tooltip)?item.Tooltip:item.Label)"
                                            type="button"
                                            class="fm-ribbon-btn @(item.Size==RibbonItemSize.Large?"large":"small")"
                                            @onclick="(()=>OnItemClick(item))">
                                        <span class="icon" aria-hidden="true">@((MarkupString)item.IconSvg)</span>
                                        @if(item.Size==RibbonItemSize.Large)
                                        {
                                            <span class="text">@item.Label</span>
                                        }
                                        else
                                        {
                                            <span class="text-inline">@item.Label</span>
                                        }
                                    </button>
                                }
                            </div>
                            <div class="fm-ribbon-group-footer" id="@groupLabelId">@g.Title</div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    // Unified API: prefer Provider; obsolete public parameters left for compatibility
    [Parameter] public IRibbonProvider? Provider { get; set; }
    [Parameter] public Microsoft.Extensions.Localization.IStringLocalizer? Localizer { get; set; }
    // Legacy parameters maintained for pages that construct tabs locally
    [Parameter] public TTabEnum ActiveTab { get; set; }
    [Parameter] public EventCallback<TTabEnum> ActiveTabChanged { get; set; }

    [Parameter] public string AriaLabel { get; set; } = "Application ribbon";
    [Parameter] public string AriaTabsLabel { get; set; } = "Ribbon tabs";
    [Parameter] public string AriaGroupsLabel { get; set; } = "Ribbon action groups";

    private List<RibbonTab<TTabEnum>>? TabsToRender => _tabsToRender ??= BuildTabsToRender();
    private List<RibbonTab<TTabEnum>>? _tabsToRender;

    private List<RibbonTab<TTabEnum>>? BuildTabsToRender()
    {
        var regs = Provider?.GetRibbonRegisters(Localizer);
        if (regs == null) { return new List<RibbonTab<TTabEnum>>(); }

        // Merge groups across registers: groups with same title get merged; preserve first-seen order
        var groupOrder = new List<string>();
        var groupMap = new Dictionary<string, RibbonGroup>(StringComparer.Ordinal);

        foreach (var reg in regs)
        {
            if (reg.Tabs == null || reg.Tabs.Count == 0) continue;

            foreach (var tab in reg.Tabs)
            {
                if (tab.Items == null || tab.Items.Count == 0) continue;

                var groupTitle = !string.IsNullOrWhiteSpace(tab.Title) ? tab.Title : reg.Kind.ToString();
                if (!groupMap.TryGetValue(groupTitle, out var existingGroup))
                {
                    existingGroup = new RibbonGroup { Title = groupTitle, Items = new List<RibbonItem>(), Sort = tab.Sort };
                    groupMap[groupTitle] = existingGroup;
                    groupOrder.Add(groupTitle);
                }

                foreach (var act in tab.Items)
                {
                    var size = act.Size == UiRibbonItemSize.Large ? RibbonItemSize.Large : RibbonItemSize.Small;
                    existingGroup.Items.Add(new RibbonItem
                    {
                        Id = act.Id,
                        Label = act.Label,
                        IconSvg = act.IconSvg,
                        Size = size,
                        Disabled = act.Disabled,
                        Tooltip = act.Tooltip,
                        Callback = act.Callback
                    });
                }
            }
        }

        var groups = groupOrder.Select(title => groupMap[title]).ToList();

        if (groups.Count == 0) return new List<RibbonTab<TTabEnum>>();

        // Determine title: use first tab title from registers if available
        var firstTitle = regs.SelectMany(r => r.Tabs ?? Enumerable.Empty<UiRibbonTab>()).Select(t => t.Title).FirstOrDefault();

        // Compute id by boxing provider result to object to avoid unconstrained-generic nullability checks
        TTabEnum id;
        if (Provider is IRibbonProvider p)
        {
            var boxed = (object?)p.GetActiveTab<TTabEnum>();
            id = boxed != null ? (TTabEnum)boxed : ActiveTab;
        }
        else
        {
            id = ActiveTab;
        }

        return new List<RibbonTab<TTabEnum>>
        {
            new RibbonTab<TTabEnum>
            {
                Id = id,
                Title = firstTitle ?? string.Empty,
                Groups = groups.OrderBy(g => g.Sort).ToList()
            }
        };
    }

    private IEnumerable<RibbonGroup>? CurrentGroups
    {
        get
        {
            TTabEnum effectiveActive;
            if (Provider is IRibbonProvider p)
            {
                var boxed = (object?)p.GetActiveTab<TTabEnum>();
                effectiveActive = boxed != null ? (TTabEnum)boxed : ActiveTab;
            }
            else
            {
                effectiveActive = ActiveTab;
            }
            return TabsToRender?.FirstOrDefault(t => EqualityComparer<TTabEnum>.Default.Equals(t.Id, effectiveActive))?.Groups;
        }
    }

    protected override void OnParametersSet()
    {
        _tabsToRender = null;
        var regs = Provider?.GetRibbonRegisters(Localizer);
        if (regs != null && regs.Any())
        {
            if (Provider is IRibbonProvider rp)
            {
                var boxed = (object?)rp.GetActiveTab<TTabEnum>();
                var providerActive = boxed != null ? (TTabEnum)boxed : default!;
                if (boxed != null && !TabsToRender.Any(t => EqualityComparer<TTabEnum>.Default.Equals(t.Id, providerActive)))
                {
                    rp.SetActiveTab<TTabEnum>(TabsToRender.First().Id);
                }
                else if (boxed == null && !TabsToRender.Any(t => EqualityComparer<TTabEnum>.Default.Equals(t.Id, ActiveTab)))
                {
                    rp.SetActiveTab<TTabEnum>(TabsToRender.First().Id);
                }
            }
            else if (!TabsToRender.Any(t => EqualityComparer<TTabEnum>.Default.Equals(t.Id, ActiveTab)))
            {
                ActiveTab = TabsToRender.First().Id;
            }
        }
    }

    private async Task SelectTab(TTabEnum id)
    {
        if (Provider is IRibbonProvider rp)
        {
            rp.SetActiveTab(id);
        }
        ActiveTab = id;
        if (ActiveTabChanged.HasDelegate)
        {
            await ActiveTabChanged.InvokeAsync(id);
        }
        StateHasChanged();
    }

    private async Task OnItemClick(RibbonItem item)
    {
        if (item.Disabled) { return; }
        if (item.Callback != null) { await item.Callback.Invoke(); }
    }

    private void OnTabKeyDown(KeyboardEventArgs e, int index)
    {
        var tabs = TabsToRender;
        if (tabs == null || tabs.Count == 0) { return; }
        if (e.Key == "ArrowRight")
        {
            var next = (index + 1) % tabs.Count;
            _ = SelectTab(tabs[next].Id);
        }
        else if (e.Key == "ArrowLeft")
        {
            var prev = (index - 1 + tabs.Count) % tabs.Count;
            _ = SelectTab(tabs[prev].Id);
        }
    }

    private class RibbonTab<T>
    {
        public required T Id { get; set; }
        public required string Title { get; set; }
        public List<RibbonGroup> Groups { get; set; } = new();
    }
    private class RibbonGroup
    {
        public required string Title { get; set; }
        public List<RibbonItem> Items { get; set; } = new();
        public int Sort { get; set; } = 0;
    }
    private class RibbonItem
    {
        public string? Id { get; set; }
        public required string Label { get; set; }
        public required string IconSvg { get; set; }
        public RibbonItemSize Size { get; set; } = RibbonItemSize.Small;
        public bool Disabled { get; set; }
        public string? Tooltip { get; set; }
        public Func<Task>? Callback { get; set; }
    }
    private enum RibbonItemSize { Small, Large }
}
