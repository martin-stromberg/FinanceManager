@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using FinanceManager.Shared.Dtos.Users
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject IServiceProvider Services

<EditForm Model="model" OnValidSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div style="display:flex;flex-direction:column;gap:0.5rem;">
        <InputText @bind-Value="model.Password" placeholder="@Localizer["User_SetPassword_Placeholder"]" />
        <InputText @bind-Value="model.ConfirmPassword" placeholder="@Localizer["User_SetPassword_ConfirmPlaceholder"]" />
        <div style="display:flex;gap:.5rem;justify-content:flex-end;">
            <button type="button" class="btn" @onclick="Close">@Localizer["Btn_Cancel"]</button>
            <button type="submit" class="btn btn-primary">@Localizer["Btn_Save"]</button>
        </div>
    </div>
</EditForm>

@code {
    [CascadingParameter(Name = "OverlayClose")] public Action? OverlayClose { get; set; }
    [CascadingParameter(Name = "OverlayOnFinished")] public Action<object>? OverlayOnFinished { get; set; }

    [Parameter] public Guid? UserId { get; set; }
    [Parameter] public string? OverlayTitle { get; set; }

    private Model model = new Model();

    private sealed class Model
    {
        [Required]
        [MinLength(8)]
        public string? Password { get; set; }

        [Compare("Password", ErrorMessage = "Passwords must match")]
        public string? ConfirmPassword { get; set; }
    }

    private void Close()
    {
        OverlayClose?.Invoke();
    }

    private async Task OnSubmit()
    {
        if (UserId == null)
        {
            Close();
            return;
        }

        var api = Services.GetRequiredService<FinanceManager.Shared.IApiClient>();
        try
        {
            var req = new ResetPasswordRequest(model.Password ?? string.Empty);
            await api.Admin_ResetPasswordAsync(UserId.Value, req);
            var user = await api.Admin_GetUserAsync(UserId.Value);
            OverlayOnFinished?.Invoke(user);
        }
        catch
        {
            // swallow for now - could show validation/error
            Close();
        }
    }
}
