@inherits LayoutComponentBase
@inject FinanceManager.Application.ICurrentUserService CurrentUser
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> L
@inject Microsoft.AspNetCore.Components.NavigationManager Nav
@implements IDisposable

<link rel="stylesheet" href="/css/ribbon.css" />
<link rel="stylesheet" href="/css/app.css" />

<div class="app-shell dark-mode">
    <input type="checkbox" id="nav-toggle" class="nav-toggle" />
    <nav class="sidebar">
        <div class="brand">
            <img src="@_logoPath" alt="App Logo" class="brand-logo" />
            <span>@L["Brand"]</span>
        </div>
        <ul class="nav-links">
            @if (CurrentUser.IsAuthenticated)
            {
                <li><NavLink href="/" Match="NavLinkMatch.All">@L["Nav_Home"]</NavLink></li>
                <li><NavLink href="/list/accounts">@L["Nav_Accounts"]</NavLink></li>
                <li><NavLink href="/list/statement-drafts" Match="NavLinkMatch.All">@L["Nav_StatementDrafts"]</NavLink></li>
                <li><NavLink href="/list/contacts">@L["Nav_Contacts"]</NavLink></li>
                <li><NavLink href="/list/savings-plans">@L["Nav_Plans"]</NavLink></li>
                <li><NavLink href="/list/securities">@L["Nav_Securities"]</NavLink></li>
                <li><NavLink href="/reports">@L["Nav_Reports"]</NavLink></li>
                <li><NavLink href="/setup">@L["Nav_Setup"]</NavLink></li>
                @if (CurrentUser.IsAdmin)
                {
                    <li><NavLink href="/users">@L["Nav_Users"]</NavLink></li>
                }
            }
        </ul>
        <div class="user-area">
            <div style="margin-bottom:.35rem; font-size:.85rem;">
                <NavLink href="/legal">@L["Nav_Legal"]</NavLink>
            </div>
            <LoginStatus />
        </div>
    </nav>
    <main class="content">
        <div class="mobile-topbar">
            <label for="nav-toggle" class="hamburger" aria-label="Menu">
                <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
                    <path fill="currentColor" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z" />
                </svg>
            </label>
            <div class="mobile-brand">
                <img src="@_logoPath" alt="App Logo" class="brand-logo" />
                <span>@L["Brand"]</span>
            </div>
        </div>
        <div class="inner" style="@(_useFullWidth ? "max-width:none" : null)">
            @Body
        </div>
    </main>
    <label for="nav-toggle" class="mobile-overlay" aria-hidden="true"></label>
</div>

<div id="blazor-error-ui" data-nosnippet>
    @L["Error_Unhandled"]
    <a href="." class="reload">@L["Error_Reload"]</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    private string _logoPath = "/icons/finance_manager.png";
    private bool _useFullWidth;

    protected override void OnInitialized()
    {
        UpdateLogo(Nav.Uri);
        Nav.LocationChanged += HandleLocationChanged;
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateLogo(e.Location);
        _ = InvokeAsync(StateHasChanged);
    }

    private void UpdateLogo(string uri)
    {
        string path;
        try
        {
            path = new Uri(uri, UriKind.Absolute).AbsolutePath.ToLowerInvariant();
        }
        catch
        {
            // Fallback if uri is not absolute
            path = uri.ToLowerInvariant();
        }

        // Support generic list routes, e.g., /list/accounts
        string kind = null;
        if (path.StartsWith("/list/"))
        {
            var parts = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
            {
                kind = parts[1];
            }
        }

        // decide logo
        if (path.StartsWith("/accounts") || string.Equals(kind, "accounts", StringComparison.OrdinalIgnoreCase))
        {
            _logoPath = "/icons/finance_manager-accounts.png";
        }
        else if (path.StartsWith("/contacts") || string.Equals(kind, "contacts", StringComparison.OrdinalIgnoreCase))
        {
            _logoPath = "/icons/finance_manager-contacts.png";
        }
        else if (path.StartsWith("/statement-drafts"))
        {
            _logoPath = "/icons/finance_manager-statementdrafts.png";
        }
        else if (path.StartsWith("/reports"))
        {
            _logoPath = "/icons/finance_manager-reports.png";
        }
        else if (path.StartsWith("/savings-plans") || string.Equals(kind, "savings-plans", StringComparison.OrdinalIgnoreCase))
        {
            _logoPath = "/icons/finance_manager-savingplans.png";
        }
        else if (path.StartsWith("/securities") || string.Equals(kind, "securities", StringComparison.OrdinalIgnoreCase))
        {
            _logoPath = "/icons/finance_manager-securities.png";
        }
        else if (path.StartsWith("/setup"))
        {
            _logoPath = "/icons/finance_manager-setup.png";
        }
        else
        {
            _logoPath = "/icons/finance_manager.png"; // Home and default
        }

        // Full-width for table-heavy pages
        _useFullWidth = path.StartsWith("/statement-drafts")
            || path.StartsWith("/accounts")
            || path.StartsWith("/reports")
            || path.StartsWith("/securities")
            || path.StartsWith("/savings-plans")
            || path.StartsWith("/contacts")
            || path.StartsWith("/list/")
            || path.StartsWith("/card/");
    }

    public void Dispose()
    {
        Nav.LocationChanged -= HandleLocationChanged;
    }
}
