@page "/statement-drafts/{Id:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IServiceProvider Services
@using FinanceManager.Application.Statements
@using FinanceManager.Domain.Statements
@using FinanceManager.Shared.Dtos.Statements
@using FinanceManager.Web.Components.Shared
@using Microsoft.Extensions.Localization
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.StatementDrafts
@inject IStringLocalizer<Components.Pages.StatementDraftDetail> Localizer
@inject IJSRuntime JS
@inject FinanceManager.Shared.IApiClient Api

<Ribbon TTabEnum="StatementDraftDetail.TabId" Provider="_vm" Localizer="Localizer" />

<h3>@Localizer["Title"]</h3>

@if (_vm == null || _vm.Loading)
{
    <p>@Localizer["Loading"]</p>
}
else if (_vm.Draft == null)
{
    <p>@Localizer["NotFound"]</p>
}
else
{
    <div style="margin:.5rem 0 1rem 0;">
        <div><strong>@Localizer["Date"]:</strong> @_vm.Draft?.Entries?.FirstOrDefault()?.BookingDate.ToShortDateString()</div>
        <div><strong>@Localizer["File"]:</strong> @_vm.Draft?.OriginalFileName</div>
        <div><strong>@Localizer["Status"]:</strong> @_vm.Draft?.Status</div>
        @if(_vm.Draft.DetectedAccountId == null)
        {
            <div style="margin-top:.5rem;">
                <button class="icon-btn" @onclick="OpenAssignAccountDialog"><svg><use href="/icons/sprite.svg#bank" /></svg>&nbsp;@Localizer["Btn_AssignAccount"]</button>
            </div>
        }
        else
        {
            <div style="margin-top:.35rem;">
                <strong>@Localizer["AssignedAccount"]:</strong> @(_detectedAccountName ?? _vm.Draft.DetectedAccountId.ToString())
            </div>
        }
    </div>

    @if (_vm.ShowAttachments)
    {
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:1000;display:flex;align-items:center;justify-content:center;" @onclick="_vm.CloseAttachments">
            <div style="background:var(--bg);border-radius:8px;padding:1.5rem;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,.5);" @onclick:stopPropagation>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h4>@Localizer["Attachments"]</h4>
                    <button class="icon-btn" @onclick="_vm.CloseAttachments" title="@Localizer["Close"]">
                        <svg style="width:20px;height:20px;"><use href="/icons/sprite.svg#close" /></svg>
                    </button>
                </div>
                <AttachmentsPanel ParentKind="FinanceManager.Domain.Attachments.AttachmentEntityKind.StatementDraft" ParentId="@Id" />
            </div>
        </div>
    }

    @if(_showAssignAccount)
    {
        <div class="split-center" @onclick="(()=> _showAssignAccount = false)">
            <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                    <h3 style="margin:0;font-size:1rem;">@Localizer["AssignAccount_Title"]</h3>
                    <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> _showAssignAccount=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
                <input type="text" @bind="_accountFilter" @bind:event="oninput" placeholder='@Localizer["Filter"]' style="width:100%;margin:.5rem 0 .75rem 0;" />
                <div style="max-height:60vh; overflow:auto;">
                    @if(_loadingAccounts)
                    {
                        <div style="opacity:.7;">@Localizer["Loading"]</div>
                    }
                    else
                    {
                        @foreach(var a in FilteredAccounts)
                        {
                            <div class="split-row @(a.Id==_selectedAccountId? "active" : string.Empty)" @onclick="(()=>SelectAccount(a.Id))">
                                <div class="name" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">@a.Name</div>
                                <div class="meta">@a.Type · @a.Iban</div>
                            </div>
                        }
                        @if(!FilteredAccounts.Any())
                        {
                            <div style="opacity:.6;">@Localizer["NoMatches"]</div>
                        }
                    }
                </div>
                @if(!string.IsNullOrEmpty(_assignError))
                {
                    <div style="margin-top:.35rem;color:#e66;font-size:.8rem;">@_assignError</div>
                }
                <div style="display:flex;gap:.5rem;margin-top:.75rem;">
                    <button class="icon-btn" disabled="@(_selectedAccountId==null)" @onclick="ConfirmAssignAccount" title='@Localizer["Apply"]' aria-label='@Localizer["Apply"]'><svg><use href="/icons/sprite.svg#check" /></svg></button>
                    <button class="icon-btn" @onclick="(()=> _showAssignAccount=false)" title='@Localizer["Cancel"]' aria-label='@Localizer["Cancel"]'><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
            </div>
        </div>
    }

    <h4>@Localizer["EntriesHeader"]</h4>
    @if (_vm.Draft.Entries == null || _vm.Draft.Entries.Count == 0)
    {
        <p style="opacity:.7;">@Localizer["NoEntries"]</p>
    }
    else
    {
        var sorted = _vm.SortedEntries;
        <table class="fm-table wide">
            <thead>
                <tr>
                    <th style="width:46px;"></th>
                    <th>@Localizer["Th_Date"]</th>
                    <th style="text-align:right;">@Localizer["Th_Amount"]</th>
                    <th>@Localizer["Th_Recipient"]</th>
                    <th>@Localizer["Th_Subject"]</th>
                    <th>@Localizer["Th_SavingsPlan"]</th>
                    <th>@Localizer["Th_Security"]</th>
                    <th>@Localizer["Th_Status"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in sorted)
                {
                    Guid? contactSymbolId = null;
                    Guid? planSymbolId = null;
                    Guid? securitySymbolId = null;
                    string? planName = null;
                    string? securityName = null;
                    if (_vm.Draft.ContactSymbols != null && _vm.Draft.ContactSymbols.TryGetValue(entry.Id, out var cs)) { contactSymbolId = cs; }
                    if (_vm.Draft.SavingsPlanSymbols != null && _vm.Draft.SavingsPlanSymbols.TryGetValue(entry.Id, out var ps)) { planSymbolId = ps; }
                    if (_vm.Draft.SavingsPlanNames != null && _vm.Draft.SavingsPlanNames.TryGetValue(entry.Id, out var pn)) { planName = pn; }
                    if (_vm.Draft.SecuritySymbols != null && _vm.Draft.SecuritySymbols.TryGetValue(entry.Id, out var ss)) { securitySymbolId = ss; }
                    if (_vm.Draft.SecurityNames != null && _vm.Draft.SecurityNames.TryGetValue(entry.Id, out var sn)) { securityName = sn; }
                    var muted = entry.Status == StatementDraftEntryStatus.AlreadyBooked || entry.Status == StatementDraftEntryStatus.Announced;
                    <tr style="cursor:pointer;@(muted?"opacity:.6;":"")" @onclick="@(() => Nav.NavigateTo($"/statement-drafts/{Id}/entries/{entry.Id}"))">
                        <td>
                            @if (contactSymbolId != null)
                            {
                                <div title="Kontakt" style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                    <img src="@($"/api/attachments/{contactSymbolId}/download")" alt="contact" style="max-width:100%;max-height:100%;display:block;" />
                                </div>
                            }
                            else
                            {
                                <div style="width:28px;height:28px;border-radius:6px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);">
                                    <svg style="width:18px;height:18px;opacity:.6;"><use href="/icons/sprite.svg#image" /></svg>
                                </div>
                            }
                        </td>
                        <td>@entry.BookingDate.ToShortDateString()</td>
                        <td style="text-align:right;">@entry.Amount</td>
                        <td class="wrap">@(string.IsNullOrWhiteSpace(entry.RecipientName)?"-":entry.RecipientName)</td>
                        <td class="wrap">@(string.IsNullOrWhiteSpace(entry.Subject)?"-":entry.Subject)</td>
                        <td>
                            @if (planSymbolId != null)
                            {
                                <div title="Sparplan" style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                    <img src="@($"/api/attachments/{planSymbolId}/download")" alt="plan" style="max-width:100%;max-height:100%;display:block;" />
                                </div>
                            }
                            @if (entry.SavingsPlanId != null)
                            {
                                <div title="Sparplan zugeordnet" style="display:flex;align-items:center;gap:.35rem;">
                                    <div style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;">
                                        <svg style="width:18px;height:18px;"><use href="/icons/sprite.svg#groups" /></svg>
                                    </div>
                                    <span class="wrap">@(string.IsNullOrWhiteSpace(planName)?"-":planName)</span>
                                </div>
                            }
                            else
                            {
                                <span style="opacity:.6;">-</span>
                            }
                        </td>
                        <td>
                            @if (securitySymbolId != null)
                            {
                                <div title="Wertpapier" style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                    <img src="@($"/api/attachments/{securitySymbolId}/download")" alt="security" style="max-width:100%;max-height:100%;display:block;" />
                                </div>
                            }
                            @if (entry.SecurityId != null)
                            {
                                <div title="Wertpapier zugeordnet" style="display:flex;align-items:center;gap:.35rem;">
                                    <div style="width:28px;height:28px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;">
                                        <svg style="width:18px;height:18px;"><use href="/icons/sprite.svg#security" /></svg>
                                    </div>
                                    <span class="wrap">@(string.IsNullOrWhiteSpace(securityName)?"-":securityName)</span>
                                </div>
                            }
                            else
                            {
                                <span style="opacity:.6;">-</span>
                            }
                        </td>
                        <td>@entry.Status</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    [Parameter] public Guid Id { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? Src { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryDraftId { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryId { get; set; }

    private StatementDraftDetailViewModel? _vm;
    private bool _showAssignAccount;
    private bool _loadingAccounts;
    private string _accountFilter = string.Empty;
    private Guid? _selectedAccountId;
    private List<AccountListItem> _accounts = new();
    private string? _assignError;
    private string? _detectedAccountName;

    private enum TabId { Statement }

    protected override async Task OnParametersSetAsync()
    {
        if (_vm == null || _vm.DraftId != Id)
        {
            if (_vm is not null)
            {
                _vm.StateChanged -= VmOnStateChanged;
                _vm.UiActionRequested -= VmOnUiActionRequested;
                _ = _vm.DisposeAsync();
            }
            _vm = ActivatorUtilities.CreateInstance<StatementDraftDetailViewModel>(Services);
            _vm.StateChanged += VmOnStateChanged;
            _vm.UiActionRequested += VmOnUiActionRequested;
            _vm.ForDraft(Id);

            await _vm.InitializeAsync();
            await LoadDetectedAccountNameAsync();
        }
        else
        {
            await LoadDetectedAccountNameAsync();
        }
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void VmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(() => HandleVmAction(action!));
    }

    private IEnumerable<AccountListItem> FilteredAccounts => string.IsNullOrWhiteSpace(_accountFilter)
        ? _accounts
        : _accounts.Where(a => a.Name.Contains(_accountFilter, StringComparison.OrdinalIgnoreCase)
                            || (!string.IsNullOrWhiteSpace(a.Iban) && a.Iban!.Contains(_accountFilter, StringComparison.OrdinalIgnoreCase)));

    private sealed record AccountListItem(Guid Id, string Name, string Type, string? Iban);

    private async Task HandleVmAction(string action)
    {
        switch (action)
        {
            case "Back":
                // If navigated from an entry, go back to that entry instead of the drafts overview
                if (string.Equals(Src, "entry", StringComparison.OrdinalIgnoreCase) && FromEntryDraftId.HasValue && FromEntryId.HasValue)
                {
                    Nav.NavigateTo($"/statement-drafts/{FromEntryDraftId}/entries/{FromEntryId}");
                }
                else
                {
                    Nav.NavigateTo("/statement-drafts");
                }
                break;
            case "OpenAttachments":
                _vm?.OpenAttachments();
                break;  
            case "OpenAccountDetails":
                if (_vm?.Draft?.DetectedAccountId is Guid accId && accId != Guid.Empty)
                {
                    Nav.NavigateTo($"/accounts/{accId}");
                }
                break;
            case "Prev":
                if (_vm?.Draft?.PrevInUpload != null)
                {
                    Nav.NavigateTo($"/statement-drafts/{_vm.Draft.PrevInUpload}");
                }
                break;
            case "Next":
                if (_vm?.Draft?.NextInUpload != null)
                {
                    Nav.NavigateTo($"/statement-drafts/{_vm.Draft.NextInUpload}");
                }
                break;
            case "AssignAccount":
                OpenAssignAccountDialog();
                break;
            case "Book":
                // booking handled elsewhere (entry-level); keep placeholder for future
                break;
            case "DeleteDraft":
                if (_vm != null)
                {
                    var okConfirm = true;
                    try { okConfirm = await JS.InvokeAsync<bool>("confirm", Localizer["Ribbon_Confirmation_Delete"].Value); } catch { }
                    if (!okConfirm) break;

                    var ok = await _vm.DeleteAsync();
                    if (ok)
                    {
                        Nav.NavigateTo("/statement-drafts", true);
                    }
                }
                break;
            case "Saved":
            case "Deleted":
                Nav.NavigateTo("/statement-drafts", true);
                break;
            default:
                break;
        }
    }

    private async void OpenAssignAccountDialog()
    {
        _showAssignAccount = true;
        _loadingAccounts = true; _assignError = null; _selectedAccountId = null;
        StateHasChanged();
        try
        {
            var list = await Api.GetAccountsAsync(0, 200, null);
            _accounts = list.Select(a => new AccountListItem(a.Id, a.Name, a.Type.ToString(), a.Iban)).OrderBy(a => a.Name).ToList();
        }
        catch (Exception ex)
        {
            _assignError = ex.Message;
        }
        finally
        {
            _loadingAccounts = false;
            StateHasChanged();
        }
    }

    private void SelectAccount(Guid id)
    {
        _selectedAccountId = id;
        StateHasChanged();
    }

    private async Task LoadDetectedAccountNameAsync()
    {
        _detectedAccountName = null;
        var accId = _vm?.Draft?.DetectedAccountId;
        if (accId.HasValue && accId.Value != Guid.Empty)
        {
            try
            {
                var dto = await Api.GetAccountAsync(accId.Value);
                _detectedAccountName = dto?.Name;
            }
            catch { }
        }
    }

    private async Task ConfirmAssignAccount()
    {
        if (_selectedAccountId == null) { return; }
        _assignError = null;
        try
        {
            var dto = await Api.StatementDrafts_SetAccountAsync(Id, _selectedAccountId.Value);
            if (dto != null)
            {
                _showAssignAccount = false;
                await _vm!.InitializeAsync();
                await LoadDetectedAccountNameAsync();
            }
            else
            {
                _assignError = Localizer["Error_AssignFailed"];
            }
        }
        catch (Exception ex)
        {
            _assignError = ex.Message;
        }
        finally { StateHasChanged(); }
    }
}
