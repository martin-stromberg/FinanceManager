@page "/"
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@inject IHttpContextAccessor httpContextAccessor
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject FinanceManager.Shared.IApiClient Api
@inject NavigationManager Nav
@inject IJSRuntime JS
@using FinanceManager.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@using FinanceManager.Shared.Dtos.Statements
@using Microsoft.Extensions.DependencyInjection
@inject IServiceProvider ServiceProvider
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="TabId" Provider="_vm" Localizer="Localizer" />

<h1>@Localizer["PageTitle"]</h1>

@if (_vm?.IsAuthenticated == true)
{
    <HomeNotifications />

    @if (_vm?.UploadInProgress == true)
    {
        <div class="upload-progress" role="status" aria-live="polite">
            <div class="hdr">
                <span class="title">@Localizer["Upload_Progress_Title"]</span>
                <span class="cnt">@_vm.UploadDone/@_vm.UploadTotal</span>
            </div>
            <div class="bar"><div class="bar-inner" style="width:@_vm.UploadPercent%"></div></div>
            @if(!string.IsNullOrWhiteSpace(_vm.CurrentFileName))
            {
                <div class="file" title="@_vm.CurrentFileName">@_vm.CurrentFileName</div>
            }
        </div>
    }

    @if (_vm?.ImportSuccess == true && _vm?.FirstDraftId != null)
    {
        <div class="alert alert-success import-success">
            @Localizer["Import_Success"]
            <a href="@($"/statement-drafts/{_vm.FirstDraftId}")" class="alert-link">@Localizer["Import_ShowDetails"]</a>
        </div>
    }
    @if (_vm?.SplitInfo != null)
    {
        <div class="alert split-info">
            @if(_vm.SplitInfo.EffectiveMonthly)
            {
                <span>@string.Format(Localizer["Import_SplitInfo_Monthly"], _vm.SplitInfo.TotalMovements, _vm.SplitInfo.DraftCount)</span>
            }
            else
            {
                <span>@string.Format(Localizer["Import_SplitInfo_Fixed"], _vm.SplitInfo.TotalMovements, _vm.SplitInfo.DraftCount)</span>
            }
            <span class="split-details">@string.Format(Localizer["Import_SplitInfo_Details"], _vm.SplitInfo.Mode, _vm.SplitInfo.MaxEntriesPerDraft, _vm.SplitInfo.LargestDraftSize)</span>
        </div>
    }

    <div class="kpi-grid">
        <HomeKpiGrid EditMode="@(_vm?.KpiEditMode == true)" />
    </div>

    <!-- File input used for import. Normally off-screen; moved over the Import button for iOS taps. -->
    <InputFile id="home-import-input" OnChange="OnFileChanged" multiple style="position:fixed; left:-9999px; width:1px; height:1px; opacity:0;" />
}
else
{
    <div class="signed-out">
        @* Lightweight placeholder when not authenticated to avoid unnecessary data loading *@
        <p>@Localizer["PleaseLoginPrompt"]</p>
    </div>
}

@code {
    private enum TabId { Home }
    private TabId _activeTab = TabId.Home;
    private Task OnActiveTabChanged(TabId id){ _activeTab = id; return Task.CompletedTask; }

    private FinanceManager.Web.ViewModels.Home.HomeViewModel? _vm;

    protected override async Task OnInitializedAsync()
    {
        _vm = ActivatorUtilities.CreateInstance<FinanceManager.Web.ViewModels.Home.HomeViewModel>(ServiceProvider);
        _vm.StateChanged += VmOnStateChanged;
        _vm.UiActionRequested += VmOnUiActionRequested;
        await Task.CompletedTask;
    }

    private void VmOnUiActionRequested(object? _, string? action)
    {
        if (string.Equals(action, "Import", StringComparison.OrdinalIgnoreCase))
        {
            _ = InvokeAsync(TriggerImportOverlayAsync);
        }
    }

    private void VmOnStateChanged(object? _, EventArgs? __)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task TriggerImportOverlayAsync()
    {
        // Position input over the button and immediately click it in the same user gesture.
        var js = @"(function(){
            var btn = document.getElementById('home-import-btn');
            var inp = document.getElementById('home-import-input');
            if(!btn || !inp) return false;
            var r = btn.getBoundingClientRect();
            var scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            var scrollY = window.pageYOffset || document.documentElement.scrollTop;
            inp.style.position='absolute';
            inp.style.left = (r.left + scrollX) + 'px';
            inp.style.top = (r.top + scrollY) + 'px';
            inp.style.width = r.width + 'px';
            inp.style.height = r.height + 'px';
            inp.style.opacity = '0.01';
            inp.style.pointerEvents = 'auto';
            try { inp.click(); } catch(e) {}
            return true;
        })();";
        try
        {
            var ok = await JS.InvokeAsync<bool>("eval", js);
            if (!ok)
            {
                await JS.InvokeVoidAsync("eval", "document.getElementById('home-import-input')?.click();");
            }
        }
        catch
        {
            Nav.NavigateTo("/statement-drafts");
        }
    }

    private async Task OnFileChanged(InputFileChangeEventArgs e)
    {
        if (_vm == null) return;

        var files = e.GetMultipleFiles();
        if (files == null || files.Count == 0)
        {
            await JS.InvokeVoidAsync("eval", "(function(){var inp=document.getElementById('home-import-input'); if(inp){inp.style.left='-9999px';inp.style.opacity='0';inp.style.pointerEvents='none';}})()");
            return;
        }

        _vm.StartUpload(files.Count);

        foreach (var file in files)
        {
            await using var stream = file.OpenReadStream(10_000_000);
            await _vm.UploadFileAsync(stream, file.Name);
        }

        // Hide input again
        await JS.InvokeVoidAsync("eval", "(function(){var inp=document.getElementById('home-import-input'); if(inp){inp.style.left='-9999px';inp.style.opacity='0';inp.style.pointerEvents='none';}})()");
    }

    public void Dispose()
    {
        if (_vm != null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.UiActionRequested -= VmOnUiActionRequested;
        }
    }
}
