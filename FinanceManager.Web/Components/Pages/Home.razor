@page "/"
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@inject IHttpContextAccessor httpContextAccessor
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject FinanceManager.Shared.IApiClient Api
@inject NavigationManager Nav
@inject IJSRuntime JS
@using FinanceManager.Web.Components.Shared
@using Microsoft.AspNetCore.Components.Web
@using FinanceManager.Shared.Dtos.Statements
@using Microsoft.Extensions.DependencyInjection
@inject IServiceProvider ServiceProvider
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="TabId" Provider="_vm" Localizer="Localizer" />

<h1>@Localizer["Home_PageTitle"]</h1>

@if (_vm?.IsAuthenticated == true)
{
    <HomeNotifications />

    @if (_vm?.UploadInProgress == true)
    {
        <div class="upload-progress" role="status" aria-live="polite">
            <div class="hdr">
                <span class="title">@Localizer["Upload_Progress_Title"]</span>
                <span class="cnt">@_vm.UploadDone/@_vm.UploadTotal</span>
            </div>
            <div class="bar"><div class="bar-inner" style="width:@_vm.UploadPercent%"></div></div>
            @if(!string.IsNullOrWhiteSpace(_vm.CurrentFileName))
            {
                <div class="file" title="@_vm.CurrentFileName">@_vm.CurrentFileName</div>
            }
        </div>
    }

    @if (_vm?.ImportSuccess == true && _vm?.FirstDraftId != null)
    {
        <div class="alert alert-success import-success">
            @Localizer["Import_Success"]
            <a href="@($"/card/statement-drafts/{_vm.FirstDraftId}")" class="alert-link">@Localizer["Import_ShowDetails"]</a>
        </div>
    }
    @if (_vm?.SplitInfo != null)
    {
        <div class="alert split-info">
            @if(_vm.SplitInfo.EffectiveMonthly)
            {
                <span>@string.Format(Localizer["Import_SplitInfo_Monthly"], _vm.SplitInfo.TotalMovements, _vm.SplitInfo.DraftCount)</span>
            }
            else
            {
                <span>@string.Format(Localizer["Import_SplitInfo_Fixed"], _vm.SplitInfo.TotalMovements, _vm.SplitInfo.DraftCount)</span>
            }
            <span class="split-details">@string.Format(Localizer["Import_SplitInfo_Details"], _vm.SplitInfo.Mode, _vm.SplitInfo.MaxEntriesPerDraft, _vm.SplitInfo.LargestDraftSize)</span>
        </div>
    }

    <div class="kpi-grid">
        <HomeKpiGrid EditMode="@(_vm?.KpiEditMode == true)" />
    </div>
}
else
{
    <div class="signed-out">
        @* Lightweight placeholder when not authenticated to avoid unnecessary data loading *@
        <p>@Localizer["PleaseLoginPrompt"]</p>
    </div>
}

@code {
    private enum TabId { Home }
    private TabId _activeTab = TabId.Home;
    private Task OnActiveTabChanged(TabId id){ _activeTab = id; return Task.CompletedTask; }

    private FinanceManager.Web.ViewModels.Home.HomeViewModel? _vm;

    protected override async Task OnInitializedAsync()
    {
        _vm = ActivatorUtilities.CreateInstance<FinanceManager.Web.ViewModels.Home.HomeViewModel>(ServiceProvider);
        _vm.StateChanged += VmOnStateChanged;
        _vm.UiActionRequested += VmOnUiActionRequested;
        await Task.CompletedTask;
    }

    private void VmOnUiActionRequested(object? _, string? action)
    {
        // Import action is handled by the Ribbon FileCallback; page does not need to trigger a file input click anymore.
    }

    private void VmOnStateChanged(object? _, EventArgs? __)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        if (_vm != null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.UiActionRequested -= VmOnUiActionRequested;
        }
    }
}
