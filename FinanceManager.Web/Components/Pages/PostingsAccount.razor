@page "/postings/account/{AccountId:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceProvider Services
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.PostingsAccount> Localizer
@using FinanceManager.Domain
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Postings
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="TabId" Provider="_vm" Localizer="Localizer" />

@if (_exporting)
{
    <div class="small-loading" style="margin:.5rem 0;">@Localizer["Loading"]</div>
}

<h3>@Localizer["Title"]</h3>
<div style="margin-bottom:.75rem;display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;">
    <input placeholder='@Localizer["SearchPlaceholder"]' value="@_vm?.Search" @oninput="OnSearchInput" style="min-width:220px;" />
    <div style="display:flex;align-items:center;gap:.25rem;font-size:.7rem;">
        <label>@Localizer["From"]:</label>
        <InputDate @bind-Value="_from" @bind-Value:after="(()=>OnRangeChanged())" />
        <label>@Localizer["To"]:</label>
        <InputDate @bind-Value="_to" @bind-Value:after="(()=>OnRangeChanged())" />
    </div>
</div>
@if((_vm?.Loading ?? true) && (_vm?.Items.Count ?? 0)==0)
{
    <p>@Localizer["Loading"]</p>
}
else
{
    <table class="fm-table wide">
        <thead>
            <tr>
                <th style="width:7rem;">@Localizer["Th_Date"]</th>
                <th style="width:7rem;">@Localizer["Th_Valuta"]</th>
                <th style="width:7rem;text-align:right;">@Localizer["Th_Amount"]</th>
                <th style="width:6rem;">@Localizer["Th_Kind"]</th>
                <th style="width:18%">@Localizer["Th_Recipient"]</th>
                <th style="width:22%">@Localizer["Th_Subject"]</th>
                <th>@Localizer["Th_Description"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var p in _vm!.Items)
            {
                <tr style="cursor:pointer;" @onclick="(()=> OpenDetail(p.Id))">
                    <td>@p.BookingDate.ToShortDateString()</td>
                    <td>@p.ValutaDate.ToShortDateString()</td>
                    <td style="text-align:right;">@p.Amount</td>
                    <td>@(p.Kind == PostingKind.Security && p.SecuritySubType.HasValue ? $"Security-{p.SecuritySubType}" : p.Kind.ToString())</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.RecipientName)?"-":p.RecipientName)</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.Subject)?"-":p.Subject)</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.Description)?"-":p.Description)</td>
                </tr>
            }
            @if(_vm.Loading)
            {
                <tr><td colspan="7" style="opacity:.6;">@Localizer["Loading"]</td></tr>
            }
        </tbody>
    </table>
    <div style="margin-top:.5rem;">
        @if(_vm.CanLoadMore)
        {
            <div @ref="_sentinel" class="infinite-sentinel" aria-hidden="true"></div>
        }
        else if(_vm.Items.Count==0 && !_vm.Loading)
        {
            <span style="opacity:.6;font-size:.75rem;">@Localizer["NoItems"]</span>
        }
        else if(!_vm.CanLoadMore)
        {
            <div class="end-of-list" style="opacity:.6;font-size:.65rem;">@Localizer["EndOfList"]</div>
        }
    </div>
}

@code {
    [Parameter] public Guid AccountId { get; set; }
    [SupplyParameterFromQuery(Name="back")] public string? BackNav { get; set; }

    private PostingsAccountViewModel? _vm;

    private ElementReference _sentinel;
    private DotNetObjectReference<PostingsAccount>? _selfRef;
    private bool _observerAttached;
    private DateTime? _from; private DateTime? _to;

    private bool _exporting;

    private enum TabId { Postings }

    protected override async Task OnInitializedAsync()
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.AuthenticationRequired -= VmOnAuthenticationRequired;
            _vm.UiActionRequested -= VmOnUiActionRequested;
            await _vm.DisposeAsync();
        }
        _vm = ActivatorUtilities.CreateInstance<PostingsAccountViewModel>(Services);
        _vm.StateChanged += VmOnStateChanged;
        _vm.AuthenticationRequired += VmOnAuthenticationRequired;
        _vm.UiActionRequested += VmOnUiActionRequested;
        _vm.Configure(AccountId);
        await _vm.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_observerAttached || !(_vm?.CanLoadMore ?? false) || (_vm?.Loading ?? false)) { return; }
        if (_sentinel.Context is null) { return; }
        try
        {
            _selfRef ??= DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("fmInfinite.observe", _sentinel, _selfRef, null);
            _observerAttached = true;
        }
        catch (JSException)
        {
            await Task.Yield();
            StateHasChanged();
        }
    }

    private async void VmOnAuthenticationRequired(object? sender, string? returnUrl)
    {
        var back = Nav.ToBaseRelativePath(Nav.Uri);
        var url = string.IsNullOrWhiteSpace(back) ? "/login" : $"/login?returnUrl={Uri.EscapeDataString(back)}";
        await InvokeAsync(() =>
        {
            try
            {
                Nav.NavigateTo(url, forceLoad: true);
            }
            catch (Microsoft.AspNetCore.Components.NavigationException)
            {
                // Fallback: clientseitige Navigation erzwingen
                try { JS.InvokeVoidAsync("eval", $"window.location.href={System.Text.Json.JsonSerializer.Serialize(url)}"); } catch { }
            }
        });
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void VmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(async () =>
        {
            switch (action)
            {
                case "Saved":
                case "Deleted":
                    if (_vm != null)
                    {
                        _vm.Items.Clear();
                        _observerAttached = false;
                        await _vm.LoadMoreAsync();
                        StateHasChanged();
                    }
                    return;
            }
            HandleRibbonAction(action!);
        });
    }


    private void HandleRibbonAction(string action)
    {
        switch (action)
        {
            case "Back": Back(); break;
            case "ClearSearch": _vm!.ClearSearch(); _observerAttached = false; _ = _vm.LoadMoreAsync(); break;
            case "ClearRange":
                // Clear VM range, clear UI inputs, and reload while preserving search
                _vm!.ClearRange();
                _from = null; _to = null;
                _vm.ResetAndSearch();
                _observerAttached = false;
                _ = _vm.LoadMoreAsync();
                break;
            case "ExportCsv": Export("csv"); break;
            case "ExportXlsx": Export("xlsx"); break;
        }
    }

    [JSInvokable]
    public async Task LoadMoreFromJs()
    {
        await _vm!.LoadMoreAsync();
        if (_vm.CanLoadMore) { await JS.InvokeVoidAsync("fmInfinite.refresh"); }
        else { StateHasChanged(); }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _vm!.SetSearch(e.Value?.ToString() ?? string.Empty);
        _vm.ResetAndSearch();
        _ = _vm.LoadMoreAsync();
    }

    private void OnRangeChanged()
    {
        _vm!.SetRange(_from, _to);
        _vm.ResetAndSearch();
        // force re-attach of intersection observer after filter change
        _observerAttached = false;
        _ = _vm.LoadMoreAsync();
    }

    private void Export(string format)
    {
        _exporting = true; StateHasChanged();
        var url = _vm!.GetExportUrl(format);
        var js = $"(function(){{var a=document.createElement('a'); a.href={System.Text.Json.JsonSerializer.Serialize(url)}; a.download=''; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a),200);}})()";
        try { JS.InvokeVoidAsync("eval", js); } catch { Nav.NavigateTo(url, forceLoad: true); }
        _exporting = false; StateHasChanged();
    }

    private string BuildBackValue() => Uri.EscapeDataString("/" + Nav.ToBaseRelativePath(Nav.Uri));

    private void OpenDetail(Guid id)
    {
        Nav.NavigateTo($"/postings/{id}?back={BuildBackValue()}");
    }

    private void Back()
    {
        if (!string.IsNullOrWhiteSpace(BackNav))
        {
            Nav.NavigateTo(BackNav!);
            return;
        }
        Nav.NavigateTo($"/accounts/{AccountId}");
    }
}
