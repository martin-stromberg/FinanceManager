@page "/reports"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IServiceProvider Services
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.ReportsHome> Localizer
@using FinanceManager.Domain
@using FinanceManager.Domain.Reports
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Reports

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="ReportsHome.TabId" Provider="_vm" Localizer="Localizer" />

<h2 class="page-heading">@Localizer["Heading"]</h2>

@if(_vm?.Loading ?? true)
{
    <p>@Localizer["Loading"]</p>
}
else if(_vm!.Favorites.Count == 0)
{
    <div class="empty-info">@Localizer["NoFavorites"]</div>
}
else
{
    <ul class="fav-grid">
        @foreach(var f in _vm!.Favorites)
        {
            <li>
                <button class="fav-card" @onclick="(()=>OpenFavorite(f.Id))" title="@Localizer["OpenFavorite"]">
                    <div class="fav-name">@f.Name</div>
                    <div class="fav-meta">@Localizer[$"PostingKind_{((PostingKind)f.PostingKind).ToString()}"] • @Localizer[$"Interval_{f.Interval}"]</div>
                </button>
            </li>
        }
    </ul>
}

@code {
    // Ribbon Tab enum required by Ribbon generic parameter
    private enum TabId { Reports }
    
    private ReportsHomeViewModel? _vm;

    protected override async Task OnInitializedAsync()
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.AuthenticationRequired -= VmOnAuthenticationRequired;
            await _vm.DisposeAsync();
        }
        _vm = ActivatorUtilities.CreateInstance<ReportsHomeViewModel>(Services);
        _vm.StateChanged += VmOnStateChanged;
        _vm.AuthenticationRequired += VmOnAuthenticationRequired;
        await _vm.InitializeAsync();
        StateHasChanged();
    }

    private void VmOnAuthenticationRequired(object? sender, string? returnUrl)
    {
        var url = "/login";
        Nav.NavigateTo(url, forceLoad: true);
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void OpenFavorite(Guid id)
    {
        Nav.NavigateTo($"/reports/dashboard?favoriteId={id}&edit=false");
    }
}
