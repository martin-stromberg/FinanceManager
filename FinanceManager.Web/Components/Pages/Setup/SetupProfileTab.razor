@using System.Net.Http.Json
@using FinanceManager.Shared.Dtos
@using FinanceManager.Web.ViewModels.Setup
@inject IJSRuntime JS
@inject Microsoft.Extensions.Localization.IStringLocalizer<Pages> Localizer
@using FinanceManager.Web.ViewModels
@using Microsoft.Extensions.DependencyInjection

<div>
    <h4 style="margin-top:0;">@Localizer["SetupProfile_Title"]</h4>

  @if (_vm == null)
  {
      <div>@Localizer["Msg_Loading"]</div>
  }
  else if (_vm.Loading)
  {
      <div>@Localizer["Msg_Loading"]</div>
  }
  else if (!string.IsNullOrWhiteSpace(_vm.Error))
  {
      <div class="error">@_vm.Error</div>
      <button class="icon-btn" @onclick="(()=> _vm.LoadAsync())" title="@Localizer["Ribbon_Retry"]">
          <svg class="icon"><use href="icons/sprite.svg#refresh" /></svg>
      </button>
  }
  else
  {
      <div class="form-grid">
          <div class="form-row">
              <label for="lang">@Localizer["SetupProfile_Label_Language"]</label>
              <select id="lang" @bind="_vm.Model.PreferredLanguage" @bind:after="(()=> _vm.OnChanged())">
                    <option value="">@Localizer["SetupProfile_Language_Auto"]</option>
                  <option value="de">Deutsch (de)</option>
                  <option value="en">English (en)</option>
              </select>
          </div>
          <div class="form-row">
                <label for="tz">@Localizer["SetupProfile_Label_TimeZone"]</label>
              <input id="tz" type="text" @bind="_vm.Model.TimeZoneId" @bind:after="(()=> _vm.OnChanged())" placeholder="Europe/Berlin" />
          </div>

          <div class="form-row">
                <label>@Localizer["SetupProfile_Label_AlphaVantageKey"]</label>
              <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
                    <input type="password" placeholder="@Localizer["SetupProfile_Placeholder_AlphaVantageKey"]" @bind="_vm.KeyInput" @bind:after="(() => _vm.OnChanged())" style="min-width:280px;" />
                    <small style="opacity:.8;">@(_vm.HasKey? Localizer["SetupProfile_Msg_KeyPresent"] : Localizer["SetupProfile_Msg_KeyMissing"])</small>
              </div>
          </div>
          <div class="form-row">
                <label>@Localizer["SetupProfile_Label_ShareKey"]</label>
              <div style="display:flex;gap:.5rem;align-items:center;">
                  <input id="share-key" type="checkbox" @bind="_vm.ShareKey" @bind:after="(()=> _vm.OnChanged())" />
                    <label for="share-key" style="opacity:.8;">@Localizer["SetupProfile_Help_ShareKey"]</label>
              </div>
          </div>
      </div>

      if (!string.IsNullOrWhiteSpace(_vm.SaveError))
      {
          <div class="error" style="margin-top:.5rem;">@_vm.SaveError</div>
      }
  }
</div>

@code {
    [Parameter] public SetupProfileViewModel? ViewModel { get; set; }

    private SetupProfileViewModel? _vm;
    private IJSObjectReference? _module;

    protected override async Task OnInitializedAsync()
    {
        _vm = ViewModel;     
        if (_vm != null)
        {
            _vm.StateChanged += OnVmStateChanged;
            _vm.UiActionRequested += OnUiActionRequested;
            await _vm.LoadAsync();
        }
    }

    private void OnVmStateChanged(object? s, EventArgs e) => _ = InvokeAsync(StateHasChanged);

    private async void OnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e)
    {
        await InvokeAsync(async () =>
        {
            var action = e?.Action;
            var payload = e?.Payload;
            switch (action)
            {
                case "DetectTimezone":
                    await DetectTimezoneFromBrowserAsync();
                    break;
            }
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "/js/profile.js");
        }
    }

    private async Task DetectTimezoneFromBrowserAsync()
    {
        try
        {
            if (_module != null && _vm != null)
            {
                var lang = await _module.InvokeAsync<string>("getLocale");
                var tz = await _module.InvokeAsync<string>("getTimeZone");
                _vm.SetDetectedTimezone(lang, tz);
             }
         }
         catch { }
     }

    private Task SaveAsync() => _vm!.SaveAsync();

    private void ClearKey() => _vm!.ClearKey();

    private void Reset() => _vm!.Reset();

    public void Dispose()
    {
        if (_vm != null) _vm.StateChanged -= OnVmStateChanged;
    }
}
