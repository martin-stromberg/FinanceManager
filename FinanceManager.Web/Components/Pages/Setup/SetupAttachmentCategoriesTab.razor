@using System.Net.Http.Json
@using FinanceManager.Shared.Dtos
@using FinanceManager.Web.ViewModels.Setup
@inject Microsoft.Extensions.Localization.IStringLocalizer<Pages> Localizer
@inject IServiceProvider Services
@using FinanceManager.Web.ViewModels
@using Microsoft.Extensions.DependencyInjection

<div>
    <h4 style="margin-top:0;">@Localizer["AttachmentCategories_TabTitle"]</h4>

    @if (_vm!.Loading)
    {
        <div>@Localizer["Msg_Loading"]</div>
    }
    else
    {
        <div class="form-grid">
            <div class="form-row">
                <label>@Localizer["AttachmentCategories_Label_NewName"]</label>
                <input type="text" @bind="_vm!.NewName" @bind:after="(()=> _vm!.OnChanged())" maxlength="100" />
                <button type="button" class="icon-btn" disabled="@(!_vm!.CanAdd || _vm!.Busy)" title="@Localizer["Btn_Add"]" @onclick="(()=> _vm!.AddAsync())">
                    <svg class="icon"><use href="icons/sprite.svg#plus" /></svg>
                </button>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_vm!.LastError))
        {
            <div class="error" style="margin:.5rem 0;">@_vm!.LastError</div>
        }
        @if (_vm!.ActionOk)
        {
            <div class="success" style="margin:.5rem 0;">@Localizer["AttachmentCategories_ActionSuccess"]</div>
        }

        <div class="table-responsive" style="margin-top:.5rem;">
            <table class="fm-table wide">
                <thead>
                    <tr>
                        <th>@Localizer["AttachmentCategories_Th_Name"]</th>
                        <th style="width:10rem;">@Localizer["AttachmentCategories_Th_IsSystem"]</th>
                        <th style="width:8rem;">@Localizer["AttachmentCategories_Th_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @if (_vm!.Items.Count == 0)
                    {
                        <tr><td colspan="3" style="opacity:.7;">@Localizer["AttachmentCategories_NoEntries"]</td></tr>
                    }
                    else
                    {
                        @foreach (var c in _vm!.Items)
                        {
                            var isEditing = _vm!.EditId == c.Id;
                            <tr>
                                <td>
                                    @if (isEditing)
                                    {
                                        <input type="text" @bind="_vm!.EditName" @bind:after="(()=> _vm!.OnChanged())" maxlength="100" disabled="@_vm!.Busy" />
                                    }
                                    else
                                    {
                                        @c.Name
                                    }
                                </td>
                                <td>@(c.IsSystem ? "✔" : "")</td>
                                <td>
                                    @if (isEditing)
                                    {
                                        <button class="icon-btn" title="@Localizer["Btn_Save"]" disabled="@(!_vm!.CanSaveEdit || _vm!.Busy)" @onclick="(()=> _vm!.SaveEditAsync())">
                                            <svg class="icon"><use href="icons/sprite.svg#save" /></svg>
                                        </button>
                                        <button class="icon-btn" title="@Localizer["Btn_Cancel"]" disabled="@_vm!.Busy" @onclick="(()=> _vm!.CancelEdit())">
                                            <svg class="icon"><use href="icons/sprite.svg#clear" /></svg>
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="icon-btn" title="@Localizer["Btn_Edit"]" disabled="@_vm!.Busy" @onclick="(()=> _vm!.BeginEdit(c.Id, c.Name))">
                                            <svg class="icon"><use href="icons/sprite.svg#edit" /></svg>
                                        </button>
                                        <button class="icon-btn danger" title="@Localizer["Btn_Delete"]" disabled="@(c.IsSystem || _vm!.Busy)" @onclick="async () => await _vm!.DeleteAsync(c.Id)">
                                            <svg class="icon"><use href="icons/sprite.svg#delete" /></svg>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Parameter] public SetupAttachmentCategoriesViewModel? ViewModel { get; set; }

    private SetupAttachmentCategoriesViewModel? _vm;
    private EventHandler? _stateChangedHandler;

    protected override async Task OnInitializedAsync()
    {
        _vm = ViewModel;
        if (_vm is not null)
        {
            _stateChangedHandler = (_, __) => { _ = InvokeAsync(StateHasChanged); };
            _vm.StateChanged += _stateChangedHandler;
            await _vm.LoadAsync();
        }
    }

    public void Dispose()
    {
        if (_vm is not null && _stateChangedHandler is not null)
        {
            _vm.StateChanged -= _stateChangedHandler;
        }
    }
}
