@using System.Net.Http.Json
@using FinanceManager.Shared.Dtos
@using FinanceManager.Web.ViewModels.Setup
@inject Microsoft.Extensions.Localization.IStringLocalizer<Pages> Localizer
@using FinanceManager.Web.ViewModels

<div style="text-align:left;">
  <h4 style="margin-top:0;">@Localizer["Notifications_TabTitle"]</h4>

  @if (_vm == null)
  {
      <div>@Localizer["Msg_Loading"]</div>
  }
  else if (_vm.Loading)
  {
      <div>@Localizer["Msg_Loading"]</div>
  }
  else if (!string.IsNullOrWhiteSpace(_vm.Error))
  {
      <div class="error">@_vm.Error</div>
      <button class="icon-btn" @onclick="(()=> _vm.LoadAsync())" title="@Localizer["Btn_Retry"]">
          <svg class="icon"><use href="icons/sprite.svg#refresh" /></svg>
      </button>
  }
  else
  {
      <div class="form-grid" style="text-align:left;display:flex;flex-direction:column;gap:0.75rem;align-items:stretch;">

          <div class="form-row" style="display:flex;align-items:center;gap:.5rem;justify-content:flex-start;">
              <label for="notif-monthly" style="min-width:10rem;">@Localizer["Notifications_MonthlyReminder"]</label>
              <input id="notif-monthly" type="checkbox" @bind="_vm.Model.MonthlyReminderEnabled" @bind:after="(()=> _vm.OnChanged())" />
              <span style="opacity:.8;">@Localizer["Notifications_MonthlyReminder_Help"]</span>
          </div>

          <div class="form-row" style="display:flex;align-items:center;gap:.4rem;justify-content:flex-start;">
              <label style="min-width:10rem;">@Localizer["Notifications_Holidays_Provider"]</label>
              <select @bind="_vm.Model.HolidayProvider" @bind:after="(()=> _vm.OnProviderChanged())" style="width:12rem;">
                <option value="Memory">Memory</option>
                <option value="NagerDate">Nager.Date</option>
              </select>
              <span style="opacity:.7;">@Localizer["Notifications_Holidays_Provider_Help"]</span>
          </div>

          <div class="form-row time-row" style="display:flex;align-items:flex-start;gap:.5rem;justify-content:flex-start;flex-wrap:nowrap;">
              <label style="min-width:10rem;">@Localizer["Notifications_MonthlyReminder_Time"]</label>
              <div class="time-group" style="display:flex;align-items:center;gap:.25rem;flex-wrap:nowrap;">
                  <input type="number" min="0" max="23" style="width:5rem;" @bind="_vm.Hour" @bind:after="(()=> _vm.OnTimeChanged())" />
                  <span>:</span>
                  <input type="number" min="0" max="59" style="width:5rem;" @bind="_vm.Minute" @bind:after="(()=> _vm.OnTimeChanged())" />
              </div>
              <span style="opacity:.7;">@Localizer["Notifications_MonthlyReminder_Time_Help"]</span>
          </div>

          <div class="form-row" style="display:flex;align-items:center;gap:.4rem;justify-content:flex-start;">
              <label style="min-width:10rem;">@Localizer["Notifications_Holidays_Region"]</label>
              <input placeholder="DE" style="width:6rem;" @bind="_vm.Model.HolidayCountryCode" @bind:after="(()=> _vm.OnCountryChanged())" />
              @if (_vm.Model.HolidayProvider != "Memory")
              {
                  <select style="width:10rem;" @bind="_vm.Model.HolidaySubdivisionCode" @bind:after="(()=> _vm.OnChanged())">
                      <option value="">--</option>
                      @if (_vm.Subdivisions is not null)
                      {
                          @foreach (var s in _vm.Subdivisions)
                          {
                              <option value="@s">@s</option>
                          }
                      }
                  </select>
              }
              <span style="opacity:.7;">@Localizer["Notifications_Holidays_Region_Help"]</span>
          </div>

      </div>

      @if (!string.IsNullOrWhiteSpace(_vm.SaveError))
      {
          <div class="error" style="margin-top:.5rem;">@_vm.SaveError</div>
      }
  }
</div>

@code {
    [Parameter] public required SetupNotificationsViewModel ViewModel { get; set; }

    private SetupNotificationsViewModel? _vm;
    private EventHandler? _stateHandler;

    protected override async Task OnInitializedAsync()
    {
        if (ViewModel == null) throw new InvalidOperationException("SetupNotificationsTab requires a ViewModel parameter");
        _vm = ViewModel;
        _stateHandler = (_, __) => { _ = InvokeAsync(StateHasChanged); };
        _vm.StateChanged += _stateHandler;
        await _vm.LoadAsync();
    }

    public void Dispose()
    {
        if (_vm != null && _stateHandler != null) _vm.StateChanged -= _stateHandler;
    }
}
