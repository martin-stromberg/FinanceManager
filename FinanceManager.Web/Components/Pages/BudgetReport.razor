@page "/reports/budget"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject Microsoft.Extensions.Localization.IStringLocalizer<Pages>? Localizer

@using FinanceManager.Shared.Dtos.Budget
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels.Budget
@using FinanceManager.Web.ViewModels.Common
@using System.Globalization

<PageTitle>@(Localizer?["Budget_Report_Title"].Value ?? "Budget report")</PageTitle>

@code {
    private BudgetReportViewModel? _vm;

    protected override async Task OnInitializedAsync()
    {
        _vm = new BudgetReportViewModel(Services);
        _vm.StateChanged += VmOnStateChanged;
        _vm.UiActionRequested += OnUiActionRequested;
        await _vm.InitializeAsync();
    }

    public void Dispose()
    {
        if (_vm != null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.UiActionRequested -= OnUiActionRequested;
        }
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void OnUiActionRequested(object? sender, BaseViewModel.UiActionEventArgs? e)
    {
        if (e?.Action == "ShowSettings")
        {
            _vm?.ShowSettings();
            return;
        }
    }
}

@if (_vm == null)
{
    <p>@(Localizer?["General_Loading"].Value ?? "Loading")</p>
}
else
{
    <Ribbon TTabEnum="int" Provider="_vm" Localizer="Localizer" />

    <div class="budget-report" style="margin:1rem auto;max-width:900px;">
        <div class="budget-report-sheet">
            @if (_vm.Settings.ShowTitle)
            {
                <h2 class="budget-report-title" style="margin-top:0;">@(Localizer?["Budget_Report_Title"].Value ?? "Budget report")</h2>
                <div class="budget-report-period" style="font-size:.875rem;color:var(--text-muted,#666);margin-top:-.25rem;margin-bottom:1rem;">
                    @{
                        var to = _vm.Settings.AsOfDate;
                        var from = new DateOnly(to.Year, to.Month, 1).AddMonths(-(Math.Max(1, _vm.Settings.Months) - 1));

                        var fromText = from.ToDateTime(TimeOnly.MinValue).ToString("d", CultureInfo.CurrentCulture);
                        var toText = to.ToDateTime(TimeOnly.MinValue).ToString("d", CultureInfo.CurrentCulture);
                    }
                    @fromText – @toText
                </div>
            }

            @if (_vm.Settings.ShowLineChart)
            {
                <BudgetLineChart
                    Data="_vm.Periods.OrderBy(p => p.PeriodStart).Select(p => (p.PeriodStart, p.Budget, p.Actual)).ToList()"
                    BudgetLabel="@(Localizer?["List_Th_Budget"].Value ?? "Budget")"
                    ActualLabel="@(Localizer?["List_Th_Actual"].Value ?? "Actual")"
                    AriaLabel="@(Localizer?["Budget_Report_Chart_Placeholder"].Value ?? "Line chart (Budget vs Actual)")" />
            }

            @if (_vm.Settings.ShowMonthlyTable)
            {
                <h3 class="budget-report-section-title">@(Localizer?["Budget_Report_MonthlyTable"].Value ?? "Monthly totals")</h3>
                <table class="table budget-report-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th style="text-align:left;">@(Localizer?["Budget_Report_Th_Period"].Value ?? "Period")</th>
                            <th style="text-align:right;">@(Localizer?["List_Th_Budget"].Value ?? "Budget")</th>
                            <th style="text-align:right;">@(Localizer?["List_Th_Actual"].Value ?? "Actual")</th>
                            <th style="text-align:right;">@(Localizer?["List_Th_Delta"].Value ?? "Delta")</th>
                            <th style="text-align:right;">@(Localizer?["Budget_Report_Th_DeltaPct"].Value ?? "Delta %")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in _vm.Periods)
                        {
                            <tr>
                                <td>@row.PeriodStart.ToDateTime(TimeOnly.MinValue).ToString("d", CultureInfo.CurrentCulture)</td>
                                <td style="text-align:right;">@row.Budget.ToString("N2")</td>
                                <td style="text-align:right;">@row.Actual.ToString("N2")</td>
                                <td style="text-align:right;">@row.Delta.ToString("N2")</td>
                                <td style="text-align:right;">@row.DeltaPct.ToString("N2")</td>
                            </tr>
                        }

                        @if (_vm.Settings.ShowPeriodSumRow && _vm.Periods.Count > 0)
                        {
                            var sumBudget = _vm.Periods.Sum(p => p.Budget);
                            var sumActual = _vm.Periods.Sum(p => p.Actual);
                            var sumDelta = sumBudget - sumActual;
                            var sumPct = sumBudget == 0m ? 0m : (sumDelta / sumBudget) * 100m;

                            <tr style="font-weight:600;">
                                <td>@(Localizer?["List_Sum"].Value ?? "Sum")</td>
                                <td style="text-align:right;">@sumBudget.ToString("N2")</td>
                                <td style="text-align:right;">@sumActual.ToString("N2")</td>
                                <td style="text-align:right;">@sumDelta.ToString("N2")</td>
                                <td style="text-align:right;">@sumPct.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            @if (_vm.Settings.ShowDetailsTable)
            {
                <h3 class="budget-report-section-title">@(Localizer?["Budget_Report_DetailsTable"].Value ?? "Categories & purposes")</h3>

                <table class="table budget-report-table" style="width:100%;margin-bottom:1rem;">
                    <thead>
                        <tr>
                            <th style="text-align:left;">@(Localizer?["List_Th_Name"].Value ?? "Name")</th>
                            <th style="text-align:right;">@(Localizer?["List_Th_Budget"].Value ?? "Budget")</th>
                            <th style="text-align:right;">@(Localizer?["List_Th_Actual"].Value ?? "Actual")</th>
                            <th style="text-align:right;">@(Localizer?["List_Th_Delta"].Value ?? "Delta")</th>
                            <th style="text-align:right;">@(Localizer?["Budget_Report_Th_DeltaPct"].Value ?? "Delta %")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cat in _vm.Categories)
                        {
                            var isSpecialRow = cat.Kind is BudgetReportCategoryRowKind.Sum or BudgetReportCategoryRowKind.Unbudgeted or BudgetReportCategoryRowKind.Result;
                            var showZeroAsEmpty = cat.Kind is BudgetReportCategoryRowKind.Unbudgeted;
                            var sumActualPurposes = cat.Purposes.Sum(p => p.Actual);
                            var hasCategoryBudget = cat.Budget != 0m;

                            if (hasCategoryBudget && !isSpecialRow)
                            {
                                var delta = cat.Budget - sumActualPurposes;
                                var pct = cat.Budget == 0m ? 0m : (delta / cat.Budget) * 100m;

                                <tr style="font-weight:600;">
                                    <td>@cat.Name</td>
                                    <td style="text-align:right;">@cat.Budget.ToString("N2")</td>
                                    <td style="text-align:right;">@sumActualPurposes.ToString("N2")</td>
                                    <td style="text-align:right;">@delta.ToString("N2")</td>
                                    <td style="text-align:right;">@pct.ToString("N2")</td>
                                </tr>

                                @if (_vm.Settings.ShowPurposeRows)
                                {
                                    @foreach (var p in cat.Purposes)
                                    {
                                        <tr>
                                            <td style="padding-left:1.5rem;">@p.Name</td>
                                            <td style="text-align:right;">@p.Budget.ToString("N2")</td>
                                            <td style="text-align:right;">@p.Actual.ToString("N2")</td>
                                            <td style="text-align:right;">@p.Delta.ToString("N2")</td>
                                            <td style="text-align:right;">@p.DeltaPct.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                            }
                            else
                            {
                                <tr style="font-weight:600;">
                                    <td>@cat.Name</td>
                                    <td style="text-align:right;">@(showZeroAsEmpty && cat.Budget == 0m ? string.Empty : cat.Budget.ToString("N2"))</td>
                                    <td style="text-align:right;">@(showZeroAsEmpty && cat.Actual == 0m ? string.Empty : cat.Actual.ToString("N2"))</td>
                                    <td style="text-align:right;">@(showZeroAsEmpty && cat.Delta == 0m ? string.Empty : cat.Delta.ToString("N2"))</td>
                                    <td style="text-align:right;">@(showZeroAsEmpty && cat.DeltaPct == 0m ? string.Empty : cat.DeltaPct.ToString("N2"))</td>
                                </tr>

                                @if (_vm.Settings.ShowPurposeRows && !isSpecialRow)
                                {
                                    @foreach (var p in cat.Purposes)
                                    {
                                        <tr>
                                            <td style="padding-left:1.5rem;">@p.Name</td>
                                            <td style="text-align:right;">@p.Budget.ToString("N2")</td>
                                            <td style="text-align:right;">@p.Actual.ToString("N2")</td>
                                            <td style="text-align:right;">@p.Delta.ToString("N2")</td>
                                            <td style="text-align:right;">@p.DeltaPct.ToString("N2")</td>
                                        </tr>
                                    }
                                }
                            }
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    @if (_vm.SettingsVisible)
    {
        <div class="split-center" @onclick="(()=> _vm.HideSettings())">
            <div class="split-dialog" style="max-width:600px;" @onclick:stopPropagation="true">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                    <h3 style="margin:0;font-size:1rem;">@(Localizer?["Budget_Report_Settings"].Value ?? "Settings")</h3>
                    <button class="icon-btn" title='@(Localizer?["Btn_Close"].Value ?? "Close")' @onclick="(()=> _vm.HideSettings())"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>

                <BudgetReportSettingsOverlay Settings="_vm.Settings" OnApply="_vm.ApplySettingsAsync" />
            </div>
        </div>
    }
}
