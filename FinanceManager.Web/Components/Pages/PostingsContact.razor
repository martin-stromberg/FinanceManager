@page "/postings/contact/{ContactId:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceProvider Services
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.PostingsContact> Localizer
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Postings
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="PostingsContact.TabId" Provider="_vm" Localizer="Localizer" />

@if (_exporting)
{
    <div class="small-loading" style="margin:.5rem 0;">@Localizer["Loading"]</div>
}

<h3>@Localizer["Title"]</h3>
<div style="margin-bottom:.75rem;display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;">
    <input placeholder='@Localizer["SearchPlaceholder"]' value="@_vm?.Search" @oninput="OnSearchInput" style="min-width:260px;" />
</div>
@if((_vm?.Loading ?? true) && (_vm?.Items.Count ?? 0)==0)
{
    <p>@Localizer["Loading"]</p>
}
else
{
    <table class="fm-table wide">
        <thead>
            <tr>
                <th>&nbsp;</th>
                <th style="width:7rem;">@Localizer["Th_Date"]</th>
                <th style="width:7rem;">@Localizer["Th_Valuta"]</th>
                <th style="width:7rem;text-align:right;">@Localizer["Th_Amount"]</th>
                <th style="width:6rem;">@Localizer["Th_Kind"]</th>
                <th style="width:18%">@Localizer["Th_Recipient"]</th>
                <th style="width:22%">@Localizer["Th_Subject"]</th>
                <th>@Localizer["Th_Description"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var p in _vm!.Items)
            {
                <tr style="cursor:pointer;" @onclick="(()=> OpenDetail(p.Id))">
                    <td class="wrap">
                        <div style="display:flex;gap:.4rem;align-items:center;">
                            @* primary bank account symbol for this posting's group *@
                            @if (p.BankPostingAccountSymbolAttachmentId != null)
                            {
                                <div title="@p.BankPostingAccountName" style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                    <img src="@($"/api/attachments/{p.BankPostingAccountSymbolAttachmentId}/download")" alt="@(p.BankPostingAccountName ?? "bank")" style="max-width:100%;max-height:100%;display:block;" />
                                </div>
                            }
                            else
                            {
                                <div title="@p.BankPostingAccountName" style="width:28px;height:28px;border-radius:6px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);">
                                    <svg style="width:18px;height:18px;opacity:.6;"><use href="/icons/sprite.svg#image" /></svg>
                                </div>
                            }

                            @* if linked contact posting exists, show separator and its bank symbol *@
                            @if (p.LinkedPostingId != null && p.LinkedPostingAccountSymbolAttachmentId != null)
                            {
                                <svg style="width:16px;height:16px;opacity:.6;margin:0 .2rem;"><use href="/icons/sprite.svg#link" /></svg>
                                <div title="@p.LinkedPostingAccountName" style="width:28px;height:28px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:6px;">
                                    <img src="@($"/api/attachments/{p.LinkedPostingAccountSymbolAttachmentId}/download")" alt="@(p.LinkedPostingAccountName ?? "bank")" style="max-width:100%;max-height:100%;display:block;" />
                                </div>
                            }
                        </div>
                    </td>
                    <td>@p.BookingDate.ToShortDateString()</td>
                    <td>@p.ValutaDate.ToShortDateString()</td>
                    <td style="text-align:right;">@p.Amount</td>
                    <td>@(p.Kind == PostingKind.Security && p.SecuritySubType.HasValue ? $"Security-{p.SecuritySubType}" : p.Kind.ToString())</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.RecipientName)?"-":p.RecipientName)</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.Subject)?"-":p.Subject)</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.Description)?"-":p.Description)</td>
                </tr>
            }
            @if(_vm.Loading)
            {
                <tr><td colspan="8" style="opacity:.6;">@Localizer["Loading"]</td></tr>
            }
        </tbody>
    </table>
    <div style="margin-top:.5rem;">
        @if(_vm.CanLoadMore)
        {
            <div @ref="_sentinel" class="infinite-sentinel" aria-hidden="true"></div>
        }
        else if(_vm.Items.Count==0 && !_vm.Loading)
        {
            <span style="opacity:.6;font-size:.75rem;">@Localizer["NoItems"]</span>
        }
        else if(!_vm.CanLoadMore)
        {
            <div class="end-of-list" style="opacity:.6;font-size:.65rem;">@Localizer["EndOfList"]</div>
        }
    </div>
}

@code {
    [Parameter] public Guid ContactId { get; set; }
    [SupplyParameterFromQuery(Name="back")] public string? BackNav { get; set; }

    private PostingsContactViewModel? _vm;

    private ElementReference _sentinel;
    private DotNetObjectReference<PostingsContact>? _selfRef;
    private bool _observerAttached;

    private bool _exporting;

    private enum TabId { Postings }

    protected override async Task OnInitializedAsync()
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.AuthenticationRequired -= VmOnAuthenticationRequired;
            _vm.UiActionRequested -= VmOnUiActionRequested;
            await _vm.DisposeAsync();
        }
        _vm = ActivatorUtilities.CreateInstance<PostingsContactViewModel>(Services);
        _vm.StateChanged += VmOnStateChanged;
        _vm.AuthenticationRequired += VmOnAuthenticationRequired;
        _vm.UiActionRequested += VmOnUiActionRequested;
        _vm.Configure(ContactId);
        await _vm.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_observerAttached || !(_vm?.CanLoadMore ?? false) || (_vm?.Loading ?? false)) { return; }
        if (_sentinel.Context is null) { return; }
        try
        {
            _selfRef ??= DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("fmInfinite.observe", _sentinel, _selfRef, null);
            _observerAttached = true;
        }
        catch (JSException)
        {
            await Task.Yield();
            StateHasChanged();
        }
    }

    private void VmOnAuthenticationRequired(object? sender, string? returnUrl)
    {
        var back = Nav.ToBaseRelativePath(Nav.Uri);
        var url = string.IsNullOrWhiteSpace(back) ? "/login" : $"/login?returnUrl={Uri.EscapeDataString(back)}";
        Nav.NavigateTo(url, forceLoad: true);
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void VmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(() => { HandleRibbonAction(action!); return Task.CompletedTask; });
    }

    private void HandleRibbonAction(string action)
    {
        switch (action)
        {
            case "Back": Back(); break;
            case "ClearSearch": _vm!.ClearSearch(); _ = _vm.LoadMoreAsync(); break;
            case "ExportCsv": Export("csv"); break;
            case "ExportXlsx": Export("xlsx"); break;
        }
    }

    [JSInvokable]
    public async Task LoadMoreFromJs()
    {
        await _vm!.LoadMoreAsync();
        if (_vm.CanLoadMore) { await JS.InvokeVoidAsync("fmInfinite.refresh"); }
        else { StateHasChanged(); }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _vm!.SetSearch(e.Value?.ToString() ?? string.Empty);
        _vm.ResetAndSearch();
        _ = _vm.LoadMoreAsync();
    }

    private void Export(string format)
    {
        _exporting = true; StateHasChanged();
        var url = _vm!.GetExportUrl(format);
        var js = $"(function(){{var a=document.createElement('a'); a.href={System.Text.Json.JsonSerializer.Serialize(url)}; a.download=''; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a),200);}})()";
        try { JS.InvokeVoidAsync("eval", js); } catch { Nav.NavigateTo(url, forceLoad: true); }
        _exporting = false; StateHasChanged();
    }

    private string BuildBackValue() => Uri.EscapeDataString("/" + Nav.ToBaseRelativePath(Nav.Uri));

    private void OpenDetail(Guid id)
    {
        Nav.NavigateTo($"/postings/{id}?back={BuildBackValue()}");
    }

    private void Back()
    {
        if (!string.IsNullOrWhiteSpace(BackNav))
        {
            Nav.NavigateTo(BackNav!);
            return;
        }
        Nav.NavigateTo($"/contacts/{ContactId}");
    }
}
