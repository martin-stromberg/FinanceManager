@page "/card/{Kind}/{Id:guid}"
@page "/card/{Kind}/{SubKind?}/{Id:guid}"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject IJSRuntime JS
@using System
@using FinanceManager.Shared.Dtos
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.Extensions
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Accounts
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Contacts
@using FinanceManager.Web.ViewModels.Contacts.Groups
@using FinanceManager.Web.ViewModels.Postings
@using FinanceManager.Web.ViewModels.Postings.Common
@using FinanceManager.Web.ViewModels.SavingsPlans.Categories
@using FinanceManager.Web.ViewModels.Securities.Categories
@using Microsoft.AspNetCore.Components

@if (_vm == null)
{
    <PageTitle>@($"{Localizer["CardPage_PageTitle"]}: {GetKindTitle()}")</PageTitle>
    <p>@Localizer["General_Loading"]</p>
}
else
{
    <PageTitle>@($"{GetKindTitle()}: {_vm.Title}")</PageTitle>
    <GenericCardPage TKeyValue="(string, string)" Provider="_vm" Localizer="Localizer" LoadingText="@Localizer["General_Loading"]" />
    @if (_vm.ChartViewModel != null)
    {
        <div style="margin-top:1.25rem;">
            <AggregateBarChart ViewModel="_vm.ChartViewModel" />
        </div>
    }

    @* Generic overlay rendering: VMs can request a UiOverlaySpec via UiActionRequested with an object payload. This keeps the page independent of concrete VM types. *@
    @if (_overlayVisible && _overlaySpec is not null)
    {
        <div class="split-center" @onclick="(()=> CloseOverlay())">
            <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                    <h3 style="margin:0;font-size:1rem;">@GetOverlayTitle()</h3>
                    <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> CloseOverlay())"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
                @* Filter out overlay-only keys (e.g., OverlayTitle) so they are not passed as component parameters *@
                @{ 
                    IDictionary<string, object?>? parms = null;
                    if (_overlaySpec.Parameters != null)
                    {
                        parms = _overlaySpec.Parameters.Where(kvp => !string.Equals(kvp.Key, "OverlayTitle", StringComparison.OrdinalIgnoreCase)
                                                                    && !string.Equals(kvp.Key, "Visible", StringComparison.OrdinalIgnoreCase))
                                    .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
                    }

                    Action overlayClose = CloseOverlay;
                    Action<object> overlayOnFinished = obj =>
                    {
                        CloseOverlay();
                        _ = NavigationManager.NavigateToModelCard(obj);
                    };
                }
                <CascadingValue Name="OverlayClose" Value="@(overlayClose)">
                    <CascadingValue Name="OverlayOnFinished" Value="@(overlayOnFinished)">
                        <DynamicComponent Type="_overlaySpec.ComponentType" Parameters="parms" />
                    </CascadingValue>
                </CascadingValue>
            </div>
        </div>
    }
}

@code {
    [Parameter] public string Kind { get; set; } = string.Empty;
    [Parameter] public string? SubKind { get; set; }
    [Parameter] public Guid Id { get; set; }

    [Parameter, SupplyParameterFromQuery(Name = "back")] public string? Back { get; set; }
    // Note: draft/entry/prefill navigation parameters removed — special initialization for specific VMs is no longer done here.

    private BaseCardViewModel<(string Key, string Value)>? _vm;
    // Generic overlay state
    private BaseViewModel.UiOverlaySpec? _overlaySpec;
    private bool _overlayVisible;

    private bool _showAttachmentsOverlay;

    private string BuildListPath()
    {
        var kind = (Kind ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(SubKind)) return $"/list/{kind}";
        return $"/list/{kind}/{SubKind}";
    }

    private string BuildCardPath(string kind, string? subKind, string id, string? back)
    {
        var k = kind.Trim();
        var basePath = string.IsNullOrWhiteSpace(subKind) ? $"/card/{k}/{id}" : $"/card/{k}/{subKind}/{id}";
        if (string.IsNullOrWhiteSpace(back)) return basePath;
        return basePath + "?back=" + Uri.EscapeDataString(back);
    }

    private async Task SetViewModel(BaseCardViewModel<(string Key, string Value)> vm)
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= ViewModelSatteChanged;
            _vm.UiActionRequested -= OnUiActionRequested;
        }
        _vm = vm;
        _vm.StateChanged += ViewModelSatteChanged;
        _vm.UiActionRequested += OnUiActionRequested;

        // Generic initialization for all card view models. Special navigation/init logic was removed from the page.
        await _vm.InitializeAsync(Id);
    }

    private void ViewModelSatteChanged(object? sender, EventArgs e) => _ = InvokeAsync(StateHasChanged);

    private void OnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e) => _ = InvokeAsync(() =>
    {
        // If a rich object payload (e.g. UiOverlaySpec) was provided, render it generically
        if (e?.PayloadObject is BaseViewModel.UiOverlaySpec spec)
        {
            _overlaySpec = spec;
            _overlayVisible = true;
            StateHasChanged();
            return;
        }

        var action = e?.Action;
        var payload = e?.Payload;
        switch (action)
        {
            case "Back":
                // prefer explicit Back query param if present
                if (!string.IsNullOrWhiteSpace(Back))
                {
                    NavigationManager.NavigateTo(Back);
                    break;
                }
                // payload may contain subtype (e.g., categories)
                if (string.IsNullOrWhiteSpace(payload))
                    NavigationManager.NavigateTo(BuildListPath());
                else
                    NavigationManager.NavigateTo($"/list/{Kind}/{payload}");
                break;
            case "OpenPostings":
                if (!string.IsNullOrWhiteSpace(payload)) NavigationManager.NavigateTo(payload);
                break;
            case "OpenPrices":
                if (!string.IsNullOrWhiteSpace(payload)) NavigationManager.NavigateTo(payload);
                break;
            case "OpenBankContact":
                var parts = (payload ?? string.Empty).Split(',', 2);
                if (parts.Length == 2 && Guid.TryParse(parts[1], out var cid))
                {
                    var kind = parts[0];
                    var back = BuildCardPath(Kind, SubKind, Id.ToString(), Back);
                    NavigationManager.NavigateTo($"/card/{kind}/{cid}?back={Uri.EscapeDataString(back)}");
                }
                break;
            case "OpenCategory":
                if (!string.IsNullOrWhiteSpace(payload)) NavigationManager.NavigateTo(payload);
                break;
            case "OpenAttachments":
                // Attachments are handled via UiOverlaySpec payloads emitted by viewmodels. No fallback.
                break;
            case "OpenMerge":
                // OpenMerge is handled by viewmodels emitting a UiOverlaySpec payload (handled above). No fallback here.
                break;
            case "Delete":
                _ = HandleDeleteAsync();
                break;
            case "Deleted":
                // when deleted navigate back to list (prefer Back)
                if (!string.IsNullOrWhiteSpace(Back)) NavigationManager.NavigateTo(Back);
                else NavigationManager.NavigateTo(BuildListPath());
                break;
            case "Saved":
                var kindLower = (Kind ?? string.Empty).Trim().ToLowerInvariant();
                var savedId = payload;
                var url = BuildCardPath(kindLower, SubKind, savedId ?? Id.ToString(), Back);
                NavigationManager.NavigateTo(url);
                break;
        }
    });

    // NOTE: no fallback for OpenAttachments — viewmodels must send UiOverlaySpec via RaiseUiActionRequested

    private string GetKindTitle() => (Kind ?? string.Empty).Trim().ToLowerInvariant() switch
    {
        "accounts" => Localizer["General_Title_Account"],
        "contacts" => Localizer["General_Title_Contact"],
        "savings-plans" => (SubKind ?? string.Empty).Trim().ToLowerInvariant() == "categories" ? Localizer["General_Title_SavingsPlan_Categories"] : Localizer["General_Title_SavingsPlans"],
        _ => Kind
    };

    protected override async Task OnParametersSetAsync()
    {
        var kind = (Kind ?? string.Empty).Trim().ToLowerInvariant();
        var sub = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
        if (kind == "accounts")
            await SetViewModel(ActivatorUtilities.CreateInstance<BankAccountCardViewModel>(Services));
        else if (kind == "postings")
            await SetViewModel(ActivatorUtilities.CreateInstance<PostingsCardViewModel>(Services));
        else if (kind == "contacts" && string.IsNullOrWhiteSpace(sub))
            await SetViewModel(ActivatorUtilities.CreateInstance<ContactCardViewModel>(Services));
        else if (kind == "contacts" && sub == "categories")
            await SetViewModel(ActivatorUtilities.CreateInstance<ContactGroupCardViewModel>(Services));
        else if (kind == "contact-categories")
            // backward compatibility: if someone uses old flat route, still resolve to category card
            await SetViewModel(ActivatorUtilities.CreateInstance<ContactGroupCardViewModel>(Services));
        else if (kind == "savings-plans" && sub == "categories")
            await SetViewModel(ActivatorUtilities.CreateInstance<SavingsPlanCategoryCardViewModel>(Services));
        else if (kind == "savings-plans")
            await SetViewModel(ActivatorUtilities.CreateInstance<FinanceManager.Web.ViewModels.SavingsPlans.SavingsPlanCardViewModel>(Services));
        else if (kind == "securities" && sub == "categories")
            await SetViewModel(ActivatorUtilities.CreateInstance<SecurityCategoryCardViewModel>(Services));
        else if (kind == "securities")
            await SetViewModel(ActivatorUtilities.CreateInstance<FinanceManager.Web.ViewModels.Securities.SecurityCardViewModel>(Services));
    }

    private async Task HandleDeleteAsync()
    {
        try
        {
            // choose confirmation message depending on current kind/subkind
            var kindLower = (Kind ?? string.Empty).Trim().ToLowerInvariant();
            var subLower = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
            var confirmKey = "Confirm_Delete_Item"; // fallback
            if (kindLower == "accounts") confirmKey = "Confirm_Delete_Account";
            else if (kindLower == "securities" && subLower == "categories") confirmKey = "Confirm_Delete_SecurityCategory";
            else if (kindLower == "contacts" && subLower == "categories") confirmKey = "Confirm_Delete_ContactCategory";

            var confirmed = true;
            try { confirmed = await JS.InvokeAsync<bool>("confirm", Localizer[confirmKey].Value ?? Localizer["Confirm_Delete_Item"].Value ?? "Delete item?"); } catch { }
            if (!confirmed) return;

            if (_vm is FinanceManager.Web.ViewModels.Common.IDeletableViewModel deletable)
            {
                var ok = await deletable.DeleteAsync();
                if (ok)
                {
                    if (!string.IsNullOrWhiteSpace(Back)) NavigationManager.NavigateTo(Back); else NavigationManager.NavigateTo(BuildListPath());
                }
                else
                {
                    var msg = deletable.LastError ?? "Delete failed";
                    await JS.InvokeVoidAsync("alert", msg);
                }
            }
            else
            {
                // Fallback: not supported for other kinds
                await JS.InvokeVoidAsync("alert", Localizer["Err_OperationNotSupported"].Value ?? "Operation not supported");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }

    private void CloseOverlay()
    {
        _overlayVisible = false;
        _overlaySpec = null;
        StateHasChanged();
    }

    private string GetOverlayTitle()
    {
        if (_overlaySpec == null) return string.Empty;
        // Prefer explicit title passed in parameters (use 'OverlayTitle' to avoid colliding with component parameters)
        if (_overlaySpec.Parameters != null && _overlaySpec.Parameters.TryGetValue("OverlayTitle", out var v) && v is string s && !string.IsNullOrWhiteSpace(s)) return s;
        var t = _overlaySpec.ComponentType;
        if (t == typeof(FinanceManager.Web.Components.Shared.AttachmentsPanel)) return Localizer["Attachments_Title"];
        if (t == typeof(FinanceManager.Web.Components.Shared.ContactMergePanel)) return Localizer["Merge_Title"];
        if (t == typeof(FinanceManager.Web.Components.Shared.SecurityPricesBackfillPanel)) return Localizer["SecurityPricesBackfill_Title"];
        return Localizer["Attachments_Title"];
    }
}
