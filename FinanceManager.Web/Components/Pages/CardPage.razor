@page "/card/{Kind}/{Id:guid}"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject IJSRuntime JS
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.Components.Shared
@using System
@using FinanceManager.Web.ViewModels.Accounts
@using FinanceManager.Web.ViewModels.Postings
@using FinanceManager.Web.ViewModels.Contacts

@if (_vm == null)
{
    <PageTitle>@($"{Localizer["CardPage_PageTitle"]}: {GetKindTitle()}")</PageTitle>
    <p>@Localizer["General_Loading"]</p>
}
else
{
    <PageTitle>@($"{GetKindTitle()}: {_vm.Title}")</PageTitle>
    <GenericCardPage TKeyValue="(string, string)" Provider="_vm" Localizer="Localizer" LoadingText="@Localizer["General_Loading"]" />
    @if (_vm.ChartViewModel != null)
    {
        <div style="margin-top:1.25rem;">
            <AggregateBarChart ViewModel="_vm.ChartViewModel" />
        </div>
    }

    @if (_showAttachmentsOverlay)
    {
        if (_vm is FinanceManager.Web.ViewModels.Accounts.BankAccountCardViewModel bam)
        {
            <div class="split-center" @onclick="(()=> _showAttachmentsOverlay = false)">
                <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                        <h3 style="margin:0;font-size:1rem;">@Localizer["Attachments_Title"]</h3>
                        <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> _showAttachmentsOverlay=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                    </div>
                    <AttachmentsPanel ParentKind="FinanceManager.Domain.Attachments.AttachmentEntityKind.Account" ParentId="bam.Id" />
                </div>
            </div>
        }
        else if (_vm is FinanceManager.Web.ViewModels.Contacts.ContactCardViewModel cvm)
        {
            <div class="split-center" @onclick="(()=> _showAttachmentsOverlay = false)">
                <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                        <h3 style="margin:0;font-size:1rem;">@Localizer["Attachments_Title"]</h3>
                        <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> _showAttachmentsOverlay=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                    </div>
                    <AttachmentsPanel ParentKind="FinanceManager.Domain.Attachments.AttachmentEntityKind.Contact" ParentId="cvm.Id" />
                </div>
            </div>
        }
    }
}

@code {
    [Parameter] public string Kind { get; set; } = string.Empty;
    [Parameter] public Guid Id { get; set; }

    private BaseCardViewModel<(string Key, string Value)>? _vm;
    private bool _showAttachmentsOverlay;

    private async Task SetViewModel(BaseCardViewModel<(string Key, string Value)> vm)
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= ViewModelSatteChanged;
            _vm.UiActionRequested -= OnUiActionRequested;
        }
        _vm = vm;
        _vm.StateChanged += ViewModelSatteChanged;
        _vm.UiActionRequested += OnUiActionRequested;
        await _vm.InitializeAsync(Id);
    }
    private void ViewModelSatteChanged(object? sender, EventArgs e) => _ = InvokeAsync(StateHasChanged);
    private void OnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e) => _ = InvokeAsync(() =>
    {
        var action = e?.Action;
        var payload = e?.Payload;
        switch (action)
        {
            case "Back":
                if (string.IsNullOrEmpty(payload))
                    NavigationManager.NavigateTo($"/list/{Kind}");
                else
                    NavigationManager.NavigateTo($"/list/{Kind}/{payload}");
                break;
            case "OpenPostings":
                NavigationManager.NavigateTo(payload);
                break;
            case "OpenBankContact":
                var parts = (payload?? string.Empty).Split(',', 2);
                if (parts.Length == 2 && Guid.TryParse(parts[1], out var cid))
                {
                    var kind = parts[0];
                    var back = $"/card/{Kind}/{Id}";
                    NavigationManager.NavigateTo($"/card/{kind}/{cid}?back={Uri.EscapeDataString(back)}");
                }
                break;
            case "OpenAttachments":
                _showAttachmentsOverlay = true;
                StateHasChanged();
                break;
            case "Delete":
                _ = HandleDeleteAsync();
                break;
            case "Deleted":
                NavigationManager.NavigateTo($"/list/{Kind}");
                break;
            case "Saved":
                var kindLower = (Kind ?? string.Empty).Trim().ToLowerInvariant();
                NavigationManager.NavigateTo($"/card/{kindLower}/{payload}");
                break;
        }
    });

    private string GetKindTitle() => (Kind ?? string.Empty).Trim().ToLowerInvariant() switch
    {
        "accounts" => Localizer["General_Title_Account"],
        "contacts" => Localizer["General_Title_Contact"],
        _ => Kind
    };

    protected override async Task OnParametersSetAsync()
    {
        if (Kind?.ToLowerInvariant() == "accounts")
            await SetViewModel(ActivatorUtilities.CreateInstance<BankAccountCardViewModel>(Services));
        else if (Kind?.ToLowerInvariant() == "postings")
            await SetViewModel(ActivatorUtilities.CreateInstance<PostingsCardViewModel>(Services));
        else if (Kind?.ToLowerInvariant() == "contacts")
            await SetViewModel(ActivatorUtilities.CreateInstance<ContactCardViewModel>(Services));
    }

    private async Task HandleDeleteAsync()
    {
        try
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", Localizer["Confirm_Delete_Account"].Value ?? "Delete item?");
            if (!confirmed) return;

            if (_vm is FinanceManager.Web.ViewModels.Accounts.BankAccountCardViewModel bam)
            {
                var ok = await bam.DeleteAsync();
                if (ok)
                {
                    // navigation will also be triggered by the Deleted event, but navigate here as fallback
                    NavigationManager.NavigateTo($"/list/{Kind}");
                }
                else
                {
                    var msg = bam.LastError ?? "Delete failed";
                    await JS.InvokeVoidAsync("alert", msg);
                }
            }
            else if (_vm is FinanceManager.Web.ViewModels.Contacts.ContactCardViewModel cvm)
            {
                var ok = await cvm.DeleteAsync();
                if (ok)
                {
                    NavigationManager.NavigateTo($"/list/{Kind}");
                }
                else
                {
                    var msg = cvm.LastError ?? "Delete failed";
                    await JS.InvokeVoidAsync("alert", msg);
                }
            }
            else
            {
                // Fallback: not supported for other kinds
                await JS.InvokeVoidAsync("alert", Localizer["Err_OperationNotSupported"].Value ?? "Operation not supported");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }
}
