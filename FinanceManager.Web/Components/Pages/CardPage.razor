@page "/card/{Kind}/{Id:guid}"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject IJSRuntime JS
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.Components.Shared
@using System
@using FinanceManager.Web.ViewModels.Accounts
@using FinanceManager.Web.ViewModels.Postings
@using FinanceManager.Web.ViewModels.Contacts
@using FinanceManager.Shared.Dtos
@using Microsoft.AspNetCore.Components
@using FinanceManager.Web.Extensions

@if (_vm == null)
{
    <PageTitle>@($"{Localizer["CardPage_PageTitle"]}: {GetKindTitle()}")</PageTitle>
    <p>@Localizer["General_Loading"]</p>
}
else
{
    <PageTitle>@($"{GetKindTitle()}: {_vm.Title}")</PageTitle>
    <GenericCardPage TKeyValue="(string, string)" Provider="_vm" Localizer="Localizer" LoadingText="@Localizer["General_Loading"]" />
    @if (_vm.ChartViewModel != null)
    {
        <div style="margin-top:1.25rem;">
            <AggregateBarChart ViewModel="_vm.ChartViewModel" />
        </div>
    }

    @* Generic overlay rendering: VMs can request a UiOverlaySpec via UiActionRequested with an object payload. This keeps the page independent of concrete VM types. *@
    @if (_overlayVisible && _overlaySpec is not null)
    {
        <div class="split-center" @onclick="(()=> CloseOverlay())">
            <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                    <h3 style="margin:0;font-size:1rem;">@GetOverlayTitle()</h3>
                    <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> CloseOverlay())"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
                @* Filter out overlay-only keys (e.g., OverlayTitle) so they are not passed as component parameters *@
                @{
                    IDictionary<string, object?>? parms = null;
                    if (_overlaySpec.Parameters != null)
                    {
                        parms = _overlaySpec.Parameters.Where(kvp => !string.Equals(kvp.Key, "OverlayTitle", StringComparison.OrdinalIgnoreCase)
                                                                    && !string.Equals(kvp.Key, "Visible", StringComparison.OrdinalIgnoreCase))
                                    .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
                    }

                    Action overlayClose = CloseOverlay;
                    Action<object> overlayOnFinished = obj =>
                    {
                        CloseOverlay();
                        _ = NavigationManager.NavigateToModelCard(obj);
                    };
                }
                <CascadingValue Name="OverlayClose" Value="@(overlayClose)">
                    <CascadingValue Name="OverlayOnFinished" Value="@(overlayOnFinished)">
                        <DynamicComponent Type="_overlaySpec.ComponentType" Parameters="parms" />
                    </CascadingValue>
                </CascadingValue>
            </div>
        </div>
    }
}

@code {
    [Parameter] public string Kind { get; set; } = string.Empty;
    [Parameter] public Guid Id { get; set; }

    private BaseCardViewModel<(string Key, string Value)>? _vm;
    // Generic overlay state
    private BaseViewModel.UiOverlaySpec? _overlaySpec;
    private bool _overlayVisible;

    private bool _showAttachmentsOverlay;

    private async Task SetViewModel(BaseCardViewModel<(string Key, string Value)> vm)
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= ViewModelSatteChanged;
            _vm.UiActionRequested -= OnUiActionRequested;
        }
        _vm = vm;
        _vm.StateChanged += ViewModelSatteChanged;
        _vm.UiActionRequested += OnUiActionRequested;
        await _vm.InitializeAsync(Id);
    }
    private void ViewModelSatteChanged(object? sender, EventArgs e) => _ = InvokeAsync(StateHasChanged);
    private void OnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e) => _ = InvokeAsync(() =>
    {
        // If a rich object payload (e.g. UiOverlaySpec) was provided, render it generically
        if (e?.PayloadObject is BaseViewModel.UiOverlaySpec spec)
        {
            _overlaySpec = spec;
            _overlayVisible = true;
            StateHasChanged();
            return;
        }

        var action = e?.Action;
        var payload = e?.Payload;
        switch (action)
        {
            case "Back":
                if (string.IsNullOrEmpty(payload))
                    NavigationManager.NavigateTo($"/list/{Kind}");
                else
                    NavigationManager.NavigateTo($"/list/{Kind}/{payload}");
                break;
            case "OpenPostings":
                NavigationManager.NavigateTo(payload);
                break;
            case "OpenBankContact":
                var parts = (payload?? string.Empty).Split(',', 2);
                if (parts.Length == 2 && Guid.TryParse(parts[1], out var cid))
                {
                    var kind = parts[0];
                    var back = $"/card/{Kind}/{Id}";
                    NavigationManager.NavigateTo($"/card/{kind}/{cid}?back={Uri.EscapeDataString(back)}");
                }
                break;
            case "OpenAttachments":
                // Attachments are handled via UiOverlaySpec payloads emitted by viewmodels. No fallback.
                break;
            case "OpenMerge":
                // OpenMerge is handled by viewmodels emitting a UiOverlaySpec payload (handled above). No fallback here.
                break;
            case "Delete":
                _ = HandleDeleteAsync();
                break;
            case "Deleted":
                NavigationManager.NavigateTo($"/list/{Kind}");
                break;
            case "Saved":
                var kindLower = (Kind ?? string.Empty).Trim().ToLowerInvariant();
                NavigationManager.NavigateTo($"/card/{kindLower}/{payload}");
                break;
        }
    });

    // NOTE: no fallback for OpenAttachments — viewmodels must send UiOverlaySpec via RaiseUiActionRequested

    private string GetKindTitle() => (Kind ?? string.Empty).Trim().ToLowerInvariant() switch
    {
        "accounts" => Localizer["General_Title_Account"],
        "contacts" => Localizer["General_Title_Contact"],
        _ => Kind
    };

    protected override async Task OnParametersSetAsync()
    {
        if (Kind?.ToLowerInvariant() == "accounts")
            await SetViewModel(ActivatorUtilities.CreateInstance<BankAccountCardViewModel>(Services));
        else if (Kind?.ToLowerInvariant() == "postings")
            await SetViewModel(ActivatorUtilities.CreateInstance<PostingsCardViewModel>(Services));
        else if (Kind?.ToLowerInvariant() == "contacts")
            await SetViewModel(ActivatorUtilities.CreateInstance<ContactCardViewModel>(Services));
    }

    private async Task HandleDeleteAsync()
    {
        try
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", Localizer["Confirm_Delete_Account"].Value ?? "Delete item?");
            if (!confirmed) return;

            if (_vm is FinanceManager.Web.ViewModels.Common.IDeletableViewModel deletable)
            {
                var ok = await deletable.DeleteAsync();
                if (ok)
                {
                    // navigation will also be triggered by the Deleted event, but navigate here as fallback
                    NavigationManager.NavigateTo($"/list/{Kind}");
                }
                else
                {
                    var msg = deletable.LastError ?? "Delete failed";
                    await JS.InvokeVoidAsync("alert", msg);
                }
            }
            else
            {
                // Fallback: not supported for other kinds
                await JS.InvokeVoidAsync("alert", Localizer["Err_OperationNotSupported"].Value ?? "Operation not supported");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }

    private void CloseOverlay()
    {
        _overlayVisible = false;
        _overlaySpec = null;
        StateHasChanged();
    }

    private string GetOverlayTitle()
    {
        if (_overlaySpec == null) return string.Empty;
        // Prefer explicit title passed in parameters (use 'OverlayTitle' to avoid colliding with component parameters)
        if (_overlaySpec.Parameters != null && _overlaySpec.Parameters.TryGetValue("OverlayTitle", out var v) && v is string s && !string.IsNullOrWhiteSpace(s)) return s;
        var t = _overlaySpec.ComponentType;
        if (t == typeof(FinanceManager.Web.Components.Shared.AttachmentsPanel)) return Localizer["Attachments_Title"];
        if (t == typeof(FinanceManager.Web.Components.Shared.ContactMergePanel)) return Localizer["Merge_Title"];
        return Localizer["Attachments_Title"];
    }
}
