@page "/card/{Kind}/{Id:guid}"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Pages> Localizer
@inject IJSRuntime JS
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.Components.Shared
@using System
@using FinanceManager.Web.ViewModels.Accounts
@using FinanceManager.Web.ViewModels.Postings

@if (_vm == null)
{
    <PageTitle>@($"{Localizer["CardPage_PageTitle"]}: {GetKindTitle()}")</PageTitle>
    <p>@Localizer["General_Loading"]</p>
}
else
{
    <PageTitle>@($"{GetKindTitle()}: {_vm.Title}")</PageTitle>
    <GenericCardPage TKeyValue="(string, string)" Provider="_vm" Localizer="Localizer" LoadingText="@Localizer["General_Loading"]" />
    @if (_vm.ChartViewModel != null)
    {
        <div style="margin-top:1.25rem;">
            <AggregateBarChart ViewModel="_vm.ChartViewModel" />
        </div>
    }
}

@code {
    [Parameter] public string Kind { get; set; } = string.Empty;
    [Parameter] public Guid Id { get; set; }

    private BaseCardViewModel<(string Key, string Value)>? _vm;
    private async Task SetViewModel(BaseCardViewModel<(string Key, string Value)> vm)
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= ViewModelSatteChanged;
            _vm.UiActionRequested -= OnUiActionRequested;
        }
        _vm = vm;
        _vm.StateChanged += ViewModelSatteChanged;
        _vm.UiActionRequested += OnUiActionRequested;
        await _vm.InitializeAsync(Id);
    }
    private void ViewModelSatteChanged(object? sender, EventArgs e) => _ = InvokeAsync(StateHasChanged);
    private void OnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e) => _ = InvokeAsync(() =>
    {
        var action = e?.Action;
        var payload = e?.Payload;
        switch (action)
        {
            case "Back":
                if (string.IsNullOrEmpty(payload))
                    NavigationManager.NavigateTo($"/list/{Kind}");
                else
                    NavigationManager.NavigateTo($"/list/{Kind}/{payload}");
                break;
            case "OpenPostings":
                NavigationManager.NavigateTo(payload);
                break;
            case "Delete":
                _ = HandleDeleteAsync();
                break;
            case "Deleted":
                NavigationManager.NavigateTo($"/list/{Kind}");
                break;
            case "Saved":
                var kindLower = (Kind ?? string.Empty).Trim().ToLowerInvariant();
                NavigationManager.NavigateTo($"/card/{kindLower}/{payload}");
                break;
        }
    });

    private string GetKindTitle() => (Kind ?? string.Empty).Trim().ToLowerInvariant() switch
    {
        "accounts" => Localizer["General_Title_Account"],
        "contacts" => Localizer["General_Title_Contact"],
        _ => Kind
    };

    protected override async Task OnParametersSetAsync()
    {
        if (Kind?.ToLowerInvariant() == "accounts")
            await SetViewModel(ActivatorUtilities.CreateInstance<BankAccountCardViewModel>(Services));
        else if (Kind?.ToLowerInvariant() == "postings")
            await SetViewModel(ActivatorUtilities.CreateInstance<PostingsCardViewModel>(Services));
    }

    private async Task HandleDeleteAsync()
    {
        try
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", Localizer["Confirm_Delete_Account"].Value ?? "Delete item?");
            if (!confirmed) return;

            if (_vm is FinanceManager.Web.ViewModels.Accounts.BankAccountCardViewModel bam)
            {
                var ok = await bam.DeleteAsync();
                if (ok)
                {
                    // navigation will also be triggered by the Deleted event, but navigate here as fallback
                    NavigationManager.NavigateTo($"/list/{Kind}");
                }
                else
                {
                    var msg = bam.LastError ?? "Delete failed";
                    await JS.InvokeVoidAsync("alert", msg);
                }
            }
            else
            {
                // Fallback: not supported for other kinds
                await JS.InvokeVoidAsync("alert", Localizer["Err_OperationNotSupported"].Value ?? "Operation not supported");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }
}
