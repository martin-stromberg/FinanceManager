@page "/savings-plans"
@inject NavigationManager Nav
@inject IServiceProvider Services
@rendermode InteractiveServer
@using System.Linq
@using FinanceManager.Shared.Dtos
@using FinanceManager.Shared.Dtos.SavingsPlans
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.SavingsPlans
@using Microsoft.Extensions.Localization
n
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<FinanceManager.Web.Components.Pages.SavingsPlanList> Localizer
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="SavingsPlanList.TabId" Tabs="_tabs" ActiveTab="_activeTab" ActiveTabChanged="OnActiveTabChanged" />

<h3>@Localizer["TitleList"]</h3>

@if(!(_vm?.Loaded ?? false))
{
    <p>@Localizer["Loading"]</p>
}
else if(!_vm!.IsAuthenticated)
{
    <p>@Localizer["PleaseLogin"]</p>
}
else if(_vm!.Plans.Count==0)
{
    <p class="status-archived">@Localizer["StatusArchived"]</p>
}
<table class="fm-table wide savings-table">
    <thead>
        <tr>
            <th></th>
            <th>@Localizer["LabelName"]</th>
            <th>@Localizer["LabelTargetAmount"]</th>
            <th>@Localizer["LabelBalance"]</th>
            <th>@Localizer["LabelRemaining"]</th>
            <th>@Localizer["LabelTargetDate"]</th>
            <th>@Localizer["LabelStatus"]</th>
        </tr>
    </thead>
    <tbody>
        @{
            // Sort plans: overdue (first), others (middle), completed (last). Within groups sort by name.
            var orderedPlans = (_vm?.Plans ?? new List<SavingsPlanDto>())
                .OrderBy(p => _vm!.IsOverdue(p) ? 0 : _vm.IsCompleted(p) ? 2 : 1)
                .ThenBy(p => p.Name, StringComparer.CurrentCultureIgnoreCase)
                .ToList();
        }
        @foreach (var plan in orderedPlans)
        {
            var status = _vm!.GetStatusFlags(plan);
            var symbolId = _vm!.GetDisplaySymbolAttachmentId(plan);
            var acc = _vm.GetAccumulatedAmount(plan);
            var rem = _vm.GetRemainingAmount(plan);
            <tr class="plan-row" @onclick="() => OpenDetail(plan.Id)">
                <td class="col-symbol">
                    @if (symbolId != null)
                    {
                        <div class="symbol-box">
                            <img src="@($"/api/attachments/{symbolId}/download")" alt="symbol" />
                        </div>
                    }
                </td>
                <td>@plan.Name</td>
                <td>@(plan.TargetAmount?.ToString("N2") ?? "")</td>
                <td>@(acc.HasValue ? acc.Value.ToString("N2") : "")</td>
                <td class="@(rem.HasValue && rem.Value < 0 ? "negative" : string.Empty)">@(rem.HasValue ? rem.Value.ToString("N2") : "")</td>
                <td>
                    <div class="target-date-cell">
                        <div>@(plan.TargetDate?.ToShortDateString() ?? "")</div>
                        @* interval badge: circular arrow with number (12/6/3/1) and subtle calendar background *@
                        @if (plan.Interval.HasValue)
                        {
                            var number = plan.Interval.Value switch
                            {
                                SavingsPlanInterval.Annually => 12,
                                SavingsPlanInterval.SemiAnnually => 6,
                                SavingsPlanInterval.Quarterly => 3,
                                SavingsPlanInterval.BiMonthly => 2,
                                SavingsPlanInterval.Monthly => 1,
                                _ => 0
                            };
                            if (number > 0)
                            {
                                <div class="interval-badge" title="@Localizer[$"Interval_{plan.Interval}"]">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                                        <!-- Kalenderrahmen -->
                                        <rect x="2" y="5" width="28" height="25" rx="3" ry="3" fill="#f0f0f0" stroke="navy" stroke-width="1" />
                                        <!-- Kalenderkopf -->
                                        <rect x="2" y="5" width="28" height="5" rx="3" ry="3" fill="navy" />
                                        <!-- Kalenderringe -->
                                        <line x1="8" y1="2" x2="8" y2="7" stroke="navy" stroke-width="1.5" />
                                        <line x1="24" y1="2" x2="24" y2="7" stroke="navy" stroke-width="1.5" />

                                        <!-- Kalender-Raster (5x4 Kästchen) -->
                                        <g fill="white" stroke="navy" stroke-width="0.4">
                                            <!-- Zeile 1 -->
                                            <rect x="3" y="11" width="5" height="3" />
                                            <rect x="8" y="11" width="5" height="3" />
                                            <rect x="13" y="11" width="5" height="3" />
                                            <rect x="18" y="11" width="5" height="3" />
                                            <rect x="23" y="11" width="5" height="3" />
                                            <!-- Zeile 2 -->
                                            <rect x="3" y="15" width="5" height="3" />
                                            <rect x="8" y="15" width="5" height="3" />
                                            <rect x="13" y="15" width="5" height="3" />
                                            <rect x="18" y="15" width="5" height="3" />
                                            <rect x="23" y="15" width="5" height="3" />
                                            <!-- Zeile 3 -->
                                            <rect x="3" y="19" width="5" height="3" />
                                            <rect x="8" y="19" width="5" height="3" />
                                            <rect x="13" y="19" width="5" height="3" />
                                            <rect x="18" y="19" width="5" height="3" />
                                            <rect x="23" y="19" width="5" height="3" />
                                            <!-- Zeile 4 -->
                                            <rect x="3" y="23" width="5" height="3" />
                                            <rect x="8" y="23" width="5" height="3" />
                                            <rect x="13" y="23" width="5" height="3" />
                                            <rect x="18" y="23" width="5" height="3" />
                                            <rect x="23" y="23" width="5" height="3" />
                                        </g>


                                        <!-- Vergrößerter Wiederholungskreis -->
                                        <circle cx="25" cy="25" r="6.5" fill="#ffffff" stroke="navy" stroke-width="1" />
                                        <!-- Größerer Pfeil -->
                                        <path d="M25 18.5             A6.5 6.5 0 0 1 31 25             L29.5 23.5             M31 25             L28.5 25" fill="none" stroke="navy" stroke-width="1" stroke-linecap="round" />
                                        <!-- Zahl 3 -->
                                        <text x="24" y="28" text-anchor="middle" font-size="10" fill="navy" font-family="Arial" font-weight="bold">@number</text>
                                    </svg>

                                </div>
                            }
                        }
                    </div>
                </td>
                <td class="col-status">
                    @* No status for Open plans *@
                    @{
                        var isCompleted = _vm!.IsCompleted(plan);
                        var isReachable = _vm.IsReachableButNotCompleted(plan);
                        var isUnreachable = _vm.IsUnreachable(plan);
                        var isOverdue = _vm.IsOverdue(plan);
                    }

                    @if (plan.Type == SavingsPlanType.Open || (!isCompleted && !isReachable && !isUnreachable))
                    {
                        <span aria-hidden="true"></span>
                    }
                    else
                    {
                        <SavingsPlanStatus IsCompleted="@isCompleted" IsOverdue="@isOverdue" IsUnreachable="@isUnreachable" IsReachable="@isReachable" Title="@(isCompleted? Localizer["StatusDone"] : isOverdue? Localizer["StatusOverdue"] : isReachable? Localizer["StatusReachable"] : Localizer["StatusUnreachable"])" />
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    // Ribbon state
    private enum TabId { SavingsPlans }
    private List<Ribbon<TabId>.RibbonTab<TabId>> _tabs = new();
    private TabId _activeTab = TabId.SavingsPlans;
    private Task OnActiveTabChanged(TabId id){ _activeTab = id; return Task.CompletedTask; }

    private SavingsPlansViewModel? _vm;

    protected override async Task OnInitializedAsync()
    {
        _vm = ActivatorUtilities.CreateInstance<SavingsPlansViewModel>(Services);
        _vm.StateChanged += (_, __) => { RebuildRibbon(); _ = InvokeAsync(StateHasChanged); };
        await _vm.InitializeAsync();
        RebuildRibbon();
    }

    private void RebuildRibbon()
    {
        var groupsDto = _vm?.GetRibbon(Localizer) ?? new List<UiRibbonGroup>();
        var groups = new List<Ribbon<TabId>.RibbonGroup>();
        foreach (var g in groupsDto)
        {
            var items = new List<Ribbon<TabId>.RibbonItem>();
            foreach (var it in g.Items)
            {
                var size = it.Size == UiRibbonItemSize.Large ? Ribbon<TabId>.RibbonItemSize.Large : Ribbon<TabId>.RibbonItemSize.Small;
                items.Add(new Ribbon<TabId>.RibbonItem
                {
                    Label = it.Label,
                    IconSvg = it.IconSvg,
                    Size = size,
                    Disabled = it.Disabled,
                    Callback = () => { HandleRibbonAction(it.Action); return Task.CompletedTask; }
                });
            }
            groups.Add(new Ribbon<TabId>.RibbonGroup { Title = g.Title, Items = items });
        }
        _tabs = new()
        {
            new Ribbon<TabId>.RibbonTab<TabId>
            {
                Id = TabId.SavingsPlans,
                Title = Localizer["PageTitle"],
                Groups = groups
            }
        };
        StateHasChanged();
    }

    private void HandleRibbonAction(string action)
    {
        switch (action)
        {
            case "New":
                NewPlan();
                break;
            case "Categories":
                Nav.NavigateTo("/savings-plan-categories");
                break;
            case "ToggleActive":
                _vm!.ToggleActiveOnly();
                break;
        }
    }

    private void NewPlan() => Nav.NavigateTo("/savings-plans/new");
    private void OpenDetail(Guid id) => Nav.NavigateTo($"/savings-plans/{id}");
}