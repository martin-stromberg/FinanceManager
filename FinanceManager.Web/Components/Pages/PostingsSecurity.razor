@page "/postings/security/{SecurityId:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceProvider Services
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.PostingsSecurity> Localizer
@using FinanceManager.Domain;
@using FinanceManager.Shared.Dtos;
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Postings
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="PostingsSecurity.TabId" Provider="_vm" Localizer="Localizer" />

<h3>@Localizer["Title"]</h3>
<div style="margin-bottom:.75rem;display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;">
    <input placeholder='@Localizer["SearchPlaceholder"]' value="@_vm?.Search" @oninput="OnSearchInput" style="min-width:260px;" />
</div>
@if((_vm?.Loading ?? true) && (_vm?.Items.Count ?? 0)==0)
{
    <p>@Localizer["Loading"]</p>
}
else
{
    <table class="fm-table wide">
        <thead>
            <tr>
                <th style="width:7rem;">@Localizer["Th_Date"]</th>
                <th style="width:7rem;">@Localizer["Th_Valuta"]</th>
                <th style="width:7rem;text-align:right;">@Localizer["Th_Amount"]</th>
                <th style="width:10rem;">@Localizer["Th_Kind"]</th>
                <th style="width:18%">@Localizer["Th_Quantity"]</th>
                <th style="width:22%">@Localizer["Th_Subject"]</th>
                <th>@Localizer["Th_Description"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var p in _vm!.Items)
            {
                <tr style="cursor:pointer;" @onclick="(()=> OpenDetail(p.Id))">
                    <td>@p.BookingDate.ToShortDateString()</td>
                    <td>@p.ValutaDate.ToShortDateString()</td>
                    <td style="text-align:right;">@p.Amount</td>
                    <td>@(p.Kind == PostingKind.Security && p.SecuritySubType!=null ? $"Security-{p.SecuritySubType}" : p.Kind.ToString())</td>
                    <td class="wrap">@(p.Quantity.HasValue && p.Quantity.Value != 0m ? p.Quantity.Value.ToString() : "")</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.Subject)?"-":p.Subject)</td>
                    <td class="wrap">@(string.IsNullOrWhiteSpace(p.Description)?"-":p.Description)</td>
                </tr>
            }
            @if(_vm.Loading)
            {
                <tr><td colspan="7" style="opacity:.6;">@Localizer["Loading"]</td></tr>
            }
        </tbody>
    </table>
    <div style="margin-top:.5rem;">
        @if(_vm.CanLoadMore)
        {
            <div @ref="_sentinel" class="infinite-sentinel" aria-hidden="true"></div>
        }
        else if(_vm.Items.Count==0 && !_vm.Loading)
        {
            <span style="opacity:.6;font-size:.75rem;">@Localizer["NoItems"]</span>
        }
        else if(!_vm.CanLoadMore)
        {
            <div class="end-of-list" style="opacity:.6;font-size:.65rem;">@Localizer["EndOfList"]</div>
        }
    </div>
}

@code {
    [Parameter] public Guid SecurityId { get; set; }
    [SupplyParameterFromQuery(Name="back")] public string? BackNav { get; set; }

    private PostingsSecurityViewModel? _vm;

    private ElementReference _sentinel;
    private DotNetObjectReference<PostingsSecurity>? _selfRef;
    private bool _observerAttached;

    private enum TabId { Postings }

    protected override async Task OnInitializedAsync()
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.AuthenticationRequired -= VmOnAuthenticationRequired;
            _vm.UiActionRequested -= VmOnUiActionRequested;
            await _vm.DisposeAsync();
        }
        _vm = ActivatorUtilities.CreateInstance<PostingsSecurityViewModel>(Services);
        _vm.StateChanged += VmOnStateChanged;
        _vm.AuthenticationRequired += VmOnAuthenticationRequired;
        _vm.UiActionRequested += VmOnUiActionRequested;
        _vm.Configure(SecurityId);
        await _vm.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_observerAttached || !(_vm?.CanLoadMore ?? false) || (_vm?.Loading ?? false))
        {
            return;
        }
        if (_sentinel.Context is null)
        {
            return;
        }
        try
        {
            _selfRef ??= DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("fmInfinite.observe", _sentinel, _selfRef, null);
            _observerAttached = true;
        }
        catch (JSException)
        {
            await Task.Yield();
            StateHasChanged();
        }
    }

    private void VmOnAuthenticationRequired(object? sender, string? returnUrl)
    {
        var back = Nav.ToBaseRelativePath(Nav.Uri);
        var url = string.IsNullOrWhiteSpace(back) ? "/login" : $"/login?returnUrl={Uri.EscapeDataString(back)}";
        Nav.NavigateTo(url, forceLoad: true);
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void VmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(() => { HandleRibbonAction(action!); return Task.CompletedTask; });
    }

    private void HandleRibbonAction(string action)
    {
        switch (action)
        {
            case "Back": Back(); break;
            case "ClearSearch": _vm!.ClearSearch(); _ = _vm.LoadMoreAsync(); break;
            case "ExportCsv": Export("csv"); break;
            case "ExportXlsx": Export("xlsx"); break;
        }
    }

    [JSInvokable]
    public async Task LoadMoreFromJs()
    {
        await _vm!.LoadMoreAsync();
        if (_vm.CanLoadMore)
        {
            await JS.InvokeVoidAsync("fmInfinite.refresh");
        }
        else
        {
            StateHasChanged();
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _vm!.SetSearch(e.Value?.ToString() ?? string.Empty);
        _vm.ResetAndSearch();
        _ = _vm.LoadMoreAsync();
    }

    private void Export(string format)
    {
        var url = _vm!.GetExportUrl(format);
        var js = $"(function(){{var a=document.createElement('a'); a.href={System.Text.Json.JsonSerializer.Serialize(url)}; a.download=''; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a),200);}})()";
        try { JS.InvokeVoidAsync("eval", js); } catch { Nav.NavigateTo(url, forceLoad: true); }
    }

    private string BuildBackValue() => Uri.EscapeDataString("/" + Nav.ToBaseRelativePath(Nav.Uri));

    private void OpenDetail(Guid id)
    {
        Nav.NavigateTo($"/postings/{id}?back={BuildBackValue()}");
    }

    private void Back()
    {
        if (!string.IsNullOrWhiteSpace(BackNav))
        {
            Nav.NavigateTo(BackNav!);
            return;
        }
        Nav.NavigateTo($"/securities/{SecurityId}");
    }
}
