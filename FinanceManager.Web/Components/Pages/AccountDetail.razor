@page "/accounts/{Id:guid}"
@page "/accounts/new"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Accounts
@inject HttpClient Http
@inject NavigationManager Nav
@inject FinanceManager.Application.ICurrentUserService CurrentUser
@using FinanceManager.Web.Components.Shared
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.AccountDetail> Localizer
@using FinanceManager.Domain.Attachments
@using FinanceManager.Web.ViewModels
@using System.Text.Json
@using FinanceManager.Shared.Dtos
@inject IServiceProvider Services
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="AccountDetail.TabId" Provider="_vm" Localizer="Localizer" />

<h1>@((_vm?.IsNew ?? (Id is null)) ? Localizer["TitleNew"] : Localizer["TitleEdit"])</h1>

@if (!_vm?.Loaded ?? true)
{
    <p>@Localizer["Loading"]</p>
}
else if (!CurrentUser.IsAuthenticated)
{
    <p>@Localizer["PleaseLogin"]</p>
}
else
{
    <EditForm Model="_vm" OnValidSubmit="@OnSaveClickedAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div style="display:grid;gap:.6rem;max-width:520px;">
            <div>
                <label>@Localizer["LabelName"]</label><br />
                <InputText @bind-Value="_vm!.Name" />
            </div>
            <div>
                <label>@Localizer["LabelType"]</label><br />
                <select @bind="_vm!.Type">
                    <option value="Giro">@Localizer["Type_Giro"]</option>
                    <option value="Savings">@Localizer["Type_Savings"]</option>
                </select>
            </div>
            <div>
                <label>@Localizer["LabelIban"]</label><br />
                <InputText @bind-Value="_vm!.Iban" />
            </div>
            <div>
                <label>@Localizer["LabelBankContact"]</label><br />
                <div class="contact-combobox" style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:420px;">
                    <div style="position:relative;min-width:0;">
                        <input type="text" style="width:95%;" @bind="_contactFilter" @bind:event="oninput" @bind:after="(()=>{OnContactFilterChanged();})" placeholder='@Localizer["Placeholder_FilterContacts"]' @onfocus="ShowContactDropdown" />
                        <input type="hidden" value="@_vm!.BankContactId" />
                        @if (_contactDropdownVisible)
                        {
                            <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectBankContact(null))" class="@( _vm!.BankContactId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                @foreach(var c in FilteredBankContacts)
                                {
                                    <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectBankContact(c.Id))" class="@( _vm!.BankContactId==c.Id?"active":string.Empty)" title="@c.Name">@c.Name</li>
                                }
                                @if (!FilteredBankContacts.Any())
                                {
                                    <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                }
                            </ul>
                        }
                    </div>
                    <div>
                        <button class="icon-btn" title='@Localizer["BtnNewContact"]' aria-label='@Localizer["BtnNewContact"]' @onclick="OpenCreateBankContact"><svg><use href="/icons/sprite.svg#plus" /></svg></button>
                    </div>
                </div>
             </div>
            @if (!_vm!.BankContactId.HasValue)
            {
                <div>
                    <label>@Localizer["LabelCreateNewBankContact"]</label><br />
                    <InputText @bind-Value="_vm!.NewBankContactName" />
                </div>
            }

            <div>
                <label>@Localizer["LabelSavingsPlanExpectation"]</label><br />
                <InputSelect TValue="SavingsPlanExpectation" @bind-Value="_vm!.SavingsPlanExpectation">
                    <option value="@(SavingsPlanExpectation.None.ToString())">@Localizer["Expectation_None"]</option>
                    <option value="@(SavingsPlanExpectation.Optional.ToString())">@Localizer["Expectation_Optional"]</option>
                    <option value="@(SavingsPlanExpectation.Required.ToString())">@Localizer["Expectation_Required"]</option>
                </InputSelect>
            </div>

            <!-- Symbol upload / preview -->
            <div>
                <SymbolPicker ParentKind="AttachmentEntityKind.Account" ParentId="@Id" CurrentAttachmentId="_vm.SymbolAttachmentId" OnUploaded="OnSymbolUploaded" OnClear="OnSymbolCleared" />
                @if (!string.IsNullOrEmpty(_symbolError))
                {
                    <div style="color:#e66;margin-top:.5rem;">@Localizer[_symbolError]</div>
                }
            </div>
        </div>
        @if (!string.IsNullOrEmpty(_vm!.Error))
        {
            <div style="color:#e66;margin-top:1rem;">@Localizer[_vm.Error]</div>
        }
    </EditForm>

    @if (_vm?.ShowCharts == true)
    {
      <div style="margin-top:1.5rem;">
          <AggregateBarChart Endpoint="@($"/api/accounts/{Id}/aggregates")" Title="@Localizer["Chart_Title_Account"]" />
      </div>
    }
}

@if (_vm?.ShowAttachments == true && Id != null)
{
    <div class="split-center" @onclick="(()=> _vm!.ShowAttachments = false)">
        <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                <h3 style="margin:0;font-size:1rem;">@Localizer["Attachments_Title"]</h3>
                <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> _vm!.ShowAttachments=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
            </div>
            <AttachmentsPanel ParentKind="AttachmentEntityKind.Account" ParentId="@Id!.Value" />
        </div>
    </div>
}

@if (_attachmentsPanelVisible && Id != null)
{
    <div class="split-center" @onclick="(()=> _attachmentsPanelVisible = false)">
        <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                <h3 style="margin:0;font-size:1rem;">@Localizer["UploadSymbol"]</h3>
                <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> _attachmentsPanelVisible=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
            </div>
            <AttachmentsPanel ParentKind="AttachmentEntityKind.Account" ParentId="@Id!.Value" OnUploaded="OnSymbolUploaded" AllowedMimeTypes="@(new[] { "image/png", "image/jpeg", "image/svg+xml" })" />
        </div>
    </div>
}

@code {
    public enum TabId { Account }

    [Parameter] public Guid? Id { get; set; }
    [SupplyParameterFromQuery(Name="back")] public string? BackNav { get; set; }

    private AccountDetailViewModel? _vm;
    private bool _attachmentsPanelVisible;
    private string? _symbolError;
    private string? _symbolPreviewUrl;

    // Bank contact combobox state
    private string _contactFilter = string.Empty;
    private bool _contactDropdownVisible;
    private CancellationTokenSource? _contactFilterCts;
    private IEnumerable<AccountDetailViewModel.BankContactVm> FilteredBankContacts => string.IsNullOrWhiteSpace(_contactFilter)
        ? _vm!.BankContacts
        : _vm!.BankContacts.Where(c => c.Name.Contains(_contactFilter, StringComparison.OrdinalIgnoreCase));

    private void ShowContactDropdown()
    {
        _contactDropdownVisible = true;
        StateHasChanged();
    }

    private async void OnContactFilterChanged()
    {
        _contactFilterCts?.Cancel();
        var cts = new CancellationTokenSource();
        _contactFilterCts = cts;
        try { await Task.Delay(250, cts.Token); } catch (TaskCanceledException) { return; }
        _contactDropdownVisible = true;
        await InvokeAsync(StateHasChanged);
    }

    private void SelectBankContact(Guid? id)
    {
        _vm!.BankContactId = id;
        _contactDropdownVisible = false;
        var name = id.HasValue ? _vm!.BankContacts.FirstOrDefault(c => c.Id == id)?.Name ?? string.Empty : string.Empty;
        _contactFilter = name;
        StateHasChanged();
    }

    private void OpenCreateBankContact()
    {
        var name = _contactFilter ?? string.Empty;
        // If account already exists, pass its id for post-save linking; otherwise pass current form values to prefill account creation
        var back = "/accounts/new";
        var common = $"prefillName={Uri.EscapeDataString(name)}&type=Bank";
        if (Id.HasValue)
        {
            var q = $"?{common}&accountId={Id.Value}&back={Uri.EscapeDataString(back)}";
            Nav.NavigateTo($"/contacts/new{q}");
        }
        else
        {
            var type = (_vm != null ? _vm.Type.ToString() : "Giro");
            var iban = _vm?.Iban ?? string.Empty;
            var exp = (_vm != null ? _vm.SavingsPlanExpectation.ToString() : string.Empty);
            var accPrefill = $"&accName={Uri.EscapeDataString(_vm?.Name ?? string.Empty)}&accType={Uri.EscapeDataString(type)}&accIban={Uri.EscapeDataString(iban)}&accExp={Uri.EscapeDataString(exp)}";
            var q = $"?{common}{accPrefill}&back={Uri.EscapeDataString(back)}";
            Nav.NavigateTo($"/contacts/new{q}");
        }
    }

    private bool _pendingRedirect;
    private string? _pendingRedirectUrl;

    protected override async Task OnParametersSetAsync()
    {
        if (_vm == null || _vm.AccountId != Id)
        {
            if (_vm is not null)
            {
                _vm.StateChanged -= VmOnStateChanged;
                _vm.AuthenticationRequired -= VmOnAuthenticationRequired;
                _vm.UiActionRequested -= VmOnUiActionRequested;
                await _vm.DisposeAsync();
            }
            _vm = ActivatorUtilities.CreateInstance<AccountDetailViewModel>(Services);
            _vm.StateChanged += VmOnStateChanged;
            _vm.AuthenticationRequired += VmOnAuthenticationRequired;
            _vm.UiActionRequested += VmOnUiActionRequested;
            _vm.ForAccount(Id);
            _vm.BackNav = BackNav;

            if (_vm.IsAuthenticated)
            {
                await _vm.InitializeAsync();
                // Prefill from query if provided (after returning from creating a bank contact)
                var uri = new Uri(Nav.Uri);
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                var accName = query.Get("accName");
                var accType = query.Get("accType");
                var accIban = query.Get("accIban");
                var accExp = query.Get("accExp");
                var bankContactIdStr = query.Get("bankContactId");
                if (!string.IsNullOrWhiteSpace(accName)) { _vm.Name = accName; }
                if (!string.IsNullOrWhiteSpace(accType))
                {
                    if (Enum.TryParse<AccountType>(accType, true, out var t)) { _vm.Type = t; }
                }
                if (!string.IsNullOrWhiteSpace(accIban)) { _vm.Iban = accIban; }
                if (!string.IsNullOrWhiteSpace(accExp))
                {
                    if (Enum.TryParse<SavingsPlanExpectation>(accExp, true, out var e)) { _vm.SavingsPlanExpectation = e; }
                }
                if (Guid.TryParse(bankContactIdStr, out var bcid)) { _vm.BankContactId = bcid; _contactFilter = _vm.BankContacts.FirstOrDefault(c => c.Id == bcid)?.Name ?? _contactFilter; }
                // Initialize contact filter text from selected
                if (_vm.BankContactId.HasValue)
                {
                    var sel = _vm.BankContacts.FirstOrDefault(c => c.Id == _vm.BankContactId.Value)?.Name;
                    _contactFilter = sel ?? string.Empty;
                }
                await EnsureSymbolPreviewAsync();
            }
            else
            {
                var returnUrl = Nav.ToBaseRelativePath(Nav.Uri);
                VmOnAuthenticationRequired(_vm, returnUrl);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_pendingRedirect && !string.IsNullOrWhiteSpace(_pendingRedirectUrl))
        {
            _pendingRedirect = false;
            var target = _pendingRedirectUrl;
            _pendingRedirectUrl = null;
            try
            {
                Nav.NavigateTo(target!, forceLoad: true);
            }
            catch
            {
                // ignore navigation errors
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private void VmOnAuthenticationRequired(object? sender, string? returnUrl)
    {
        var url = string.IsNullOrWhiteSpace(returnUrl) ? "/login" : $"/login?returnUrl={Uri.EscapeDataString(returnUrl)}";
        _pendingRedirectUrl = url;
        _pendingRedirect = true;
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void VmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(() =>
        {
            // Handle VM lifecycle events first
            switch (action)
            {
                case "Saved":
                    if (_vm != null && _vm.AccountId.HasValue)
                    {
                        Nav.NavigateTo($"/accounts/{_vm.AccountId.Value}", forceLoad: true);
                        return Task.CompletedTask;
                    }
                    break;
                case "Deleted":
                    Nav.NavigateTo("/accounts", forceLoad: true);
                    return Task.CompletedTask;
            }
            return HandleRibbonActionAsync(action!);
        });
    }

    private Task HandleRibbonActionAsync(string action)
    {
        HandleRibbonAction(action);
        return Task.CompletedTask;
    }

    private async Task EnsureSymbolPreviewAsync()
    {
        _symbolPreviewUrl = null;
        try
        {
            if (_vm?.SymbolAttachmentId != null)
            {
                // Request a short-lived token for the attachment so the browser can fetch it anonymously
                var attachId = _vm.SymbolAttachmentId.Value;
                var resp = await Http.PostAsync($"/api/attachments/{attachId}/download-token?validSeconds=300", content: null);
                if (resp.IsSuccessStatusCode)
                {
                    var obj = await resp.Content.ReadFromJsonAsync<JsonElement>();
                    if (obj.ValueKind == JsonValueKind.Object && obj.TryGetProperty("token", out var t) && t.ValueKind == JsonValueKind.String)
                    {
                        var token = t.GetString();
                        if (!string.IsNullOrWhiteSpace(token))
                        {
                            _symbolPreviewUrl = $"/api/attachments/{attachId}/download?token={Uri.EscapeDataString(token)}";
                        }
                    }
                }
            }
        }
        catch
        {
            // ignore preview failures; use direct download fallback
            _symbolPreviewUrl = null;
        }
        StateHasChanged();
    }

    private async Task OnSaveClickedAsync()
    {
        if (_vm is null) { return; }
        var id = await _vm.SaveAsync();
        if (id.HasValue)
        {
            Nav.NavigateTo($"/accounts/{id.Value}", forceLoad: true);
        }
    }

    private void HandleRibbonAction(string action)
    {
        switch (action)
        {
            case "Back":
                Back();
                break;
            case "Save":
                _ = OnSaveClickedAsync();
                break;
            case "Delete":
                _ = DeleteAsync();
                break;
            case "OpenBankContact":
                OpenBankContact();
                break;
            case "OpenPostings":
                OpenPostings();
                break;
            case "OpenAttachments":
                _vm!.ShowAttachments = true;
                break;
        }
    }

    private async Task DeleteAsync()
    {
        if (_vm is null || _vm.IsNew) { return; }
        await _vm.DeleteAsync();
        if (_vm.Error == null)
        {
            Back();
        }
    }

    private void Back()
    {
        if (!string.IsNullOrWhiteSpace(BackNav))
        {
            var target = Uri.UnescapeDataString(BackNav);
            Nav.NavigateTo(target, forceLoad: true);
            return;
        }
        Nav.NavigateTo("/accounts", forceLoad: true);
    }
    private void OpenBankContact(){ if (_vm?.BankContactId is Guid id) { Nav.NavigateTo($"/contacts/{id}"); } }
    private void OpenPostings(){ if (Id != null) { Nav.NavigateTo($"/postings/account/{Id}"); } }

    private void OpenAttachmentsPanel()
    {
        _attachmentsPanelVisible = true;
        _symbolError = null;
    }

    private async Task OnSymbolUploaded(Guid attachmentId)
    {
        _symbolError = null;
        if (_vm is null || Id == null) { return; }
        // Call API to set symbol reference for this account
        var resp = await Http.PostAsync($"/api/accounts/{Id}/symbol/{attachmentId}", null);
        if (resp.IsSuccessStatusCode)
        {
            // reload account and preview
            await _vm!.InitializeAsync();
            await EnsureSymbolPreviewAsync();
        }
        else
        {
            // keep panel closed but show small error
            _symbolError = "Error_SetSymbolFailed";
        }
    }

    private async Task OnSymbolCleared()
    {
        if (Id == null) { return; }
        var resp = await Http.DeleteAsync($"/api/accounts/{Id}/symbol");
        if (resp.IsSuccessStatusCode)
        {
            await _vm!.InitializeAsync();
            _symbolPreviewUrl = null;
            StateHasChanged();
        }
    }

}
