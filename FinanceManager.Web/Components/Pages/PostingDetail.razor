@page "/postings/{Id:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IServiceProvider Services
@inject Microsoft.Extensions.Localization.IStringLocalizer<FinanceManager.Web.Components.Pages.PostingDetail> Localizer
@using FinanceManager.Domain.Attachments
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.ViewModels.Postings
<PageTitle>@Localizer["PageTitle"]</PageTitle>

<Ribbon TTabEnum="PostingDetail.TabId" Provider="_vm" Localizer="Localizer" />

<h3>@Localizer["Title"]</h3>
@if(_vm?.Loading ?? true)
{
    <p>@Localizer["Loading"]</p>
}
else if(_vm!.Detail == null)
{
    <p>@Localizer["NotFound"]</p>
}
else
{
    <div style="margin:.5rem 0 1rem 0;">
        <div><strong>@Localizer["Date"]:</strong> @_vm.Detail!.BookingDate.ToShortDateString()</div>
        <div><strong>@Localizer["ValutaDate"]:</strong> @_vm.Detail!.ValutaDate.ToShortDateString()</div>
        <div><strong>@Localizer["Amount"]:</strong> @_vm.Detail!.Amount</div>
        <div><strong>@Localizer["Kind"]:</strong> @_vm.Detail!.Kind (@_vm.Detail!.SecuritySubType)</div>
        <div><strong>@Localizer["Subject"]:</strong> @_vm.Detail!.Subject</div>
        <div><strong>@Localizer["Recipient"]:</strong> @_vm.Detail!.RecipientName</div>
        <div><strong>@Localizer["Description"]:</strong> @_vm.Detail!.Description</div>
    </div>
    @if (_showAttachments)
    {
        <div class="split-center" @onclick="(()=> _showAttachments = false)">
            <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                    <h3 style="margin:0;font-size:1rem;">@Localizer["Attachments_Title"]</h3>
                    <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> _showAttachments=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
                <AttachmentsPanel ParentKind="@AttachmentEntityKind.Posting" ParentId="@Id" />
            </div>
        </div>
    }
}

@code{
    [Parameter] public Guid Id { get; set; }
    [SupplyParameterFromQuery(Name="back")] public string? BackNav { get; set; }

    private PostingDetailViewModel? _vm;
    private bool _showAttachments;

    private enum TabId { Detail }

    protected override async Task OnInitializedAsync()
    {
        if (_vm is not null)
        {
            _vm.StateChanged -= VmOnStateChanged;
            _vm.AuthenticationRequired -= VmOnAuthenticationRequired;
            await _vm.DisposeAsync();
        }
        _vm = ActivatorUtilities.CreateInstance<PostingDetailViewModel>(Services);
        _vm.StateChanged += VmOnStateChanged;
        _vm.AuthenticationRequired += VmOnAuthenticationRequired;
        _vm.UiActionRequested += VmOnUiActionRequested;
        _vm.Configure(Id);
        await _vm.InitializeAsync();
    }

    private void VmOnAuthenticationRequired(object? sender, string? returnUrl)
    {
        var back = Nav.ToBaseRelativePath(Nav.Uri);
        var url = string.IsNullOrWhiteSpace(back) ? "/login" : $"/login?returnUrl={Uri.EscapeDataString(back)}";
        Nav.NavigateTo(url, forceLoad: true);
    }

    private void VmOnStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void VmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(() =>
        {
            switch (action)
            {
                case "Back":
                    Back();
                    break;
                case "OpenAccount":
                    if (_vm?.LinkedAccountId is Guid aid) { Nav.NavigateTo($"/accounts/{aid}?back={BuildBackValue()}"); }
                    break;
                case "OpenContact":
                    if (_vm?.LinkedContactId is Guid cid) { Nav.NavigateTo($"/contacts/{cid}?back={BuildBackValue()}"); }
                    break;
                case "OpenSavingsPlan":
                    if (_vm?.LinkedPlanId is Guid pid) { Nav.NavigateTo($"/savings-plans/{pid}?back={BuildBackValue()}"); }
                    break;
                case "OpenSecurity":
                    if (_vm?.LinkedSecurityId is Guid sid) { Nav.NavigateTo($"/securities/{sid}?back={BuildBackValue()}"); }
                    break;
                case "OpenAttachments":
                    _showAttachments = true;
                    StateHasChanged();
                    break;
                case "Saved":
                case "Deleted":
                    // navigate back to postings list if linked
                    if (_vm?.LinkedAccountId != null) { Nav.NavigateTo($"/accounts/{_vm.LinkedAccountId}"); return Task.CompletedTask; }
                    if (_vm?.LinkedContactId != null) { Nav.NavigateTo($"/contacts/{_vm.LinkedContactId}"); return Task.CompletedTask; }
                    if (_vm?.LinkedPlanId != null) { Nav.NavigateTo($"/savings-plans/{_vm.LinkedPlanId}"); return Task.CompletedTask; }
                    if (_vm?.LinkedSecurityId != null) { Nav.NavigateTo($"/securities/{_vm.LinkedSecurityId}"); return Task.CompletedTask; }
                    Nav.NavigateTo("/");
                    break;
            }
            return Task.CompletedTask;
        });
    }

    private string BuildBackValue() => Uri.EscapeDataString("/" + Nav.ToBaseRelativePath(Nav.Uri));

    private void Back()
    {
        if (!string.IsNullOrWhiteSpace(BackNav))
        {
            Nav.NavigateTo(BackNav!);
            return;
        }
        if (_vm?.LinkedAccountId != null) { Nav.NavigateTo($"/accounts/{_vm.LinkedAccountId}"); return; }
        if (_vm?.LinkedContactId != null) { Nav.NavigateTo($"/contacts/{_vm.LinkedContactId}"); return; }
        if (_vm?.LinkedPlanId != null) { Nav.NavigateTo($"/savings-plans/{_vm.LinkedPlanId}"); return; }
        if (_vm?.LinkedSecurityId != null) { Nav.NavigateTo($"/securities/{_vm.LinkedSecurityId}"); return; }
        Nav.NavigateTo("/");
    }
}
