@page "/list/{Kind}/{SubKind?}/{Id?}"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject NavigationManager Nav
@inject Microsoft.Extensions.Localization.IStringLocalizer<Pages>? Localizer
@inject IJSRuntime JS
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using FinanceManager.Web.Components.Shared
@using System.Resources
@using System.Globalization
@using System.Collections

<PageTitle>@($"{Localizer["General_PageTitle"]}: {GetKindTitle()}")</PageTitle>

<h3>@Localizer["General_PageTitle"]: @GetKindTitle()</h3>


@if (_provider == null)
{
    <p>@Localizer["General_Loading"]</p>
}
else
{
    <GenericListPage TItem="object"
                     Provider="_provider"
                     Localizer="Localizer"
                     SearchPlaceholder="@Localizer["List_SearchPlaceholder"]"
                     RangeFromLabel="@Localizer["List_SearchFrom"]"
                     RangeToLabel="@Localizer["List_SearchTo"]"
                     LoadingText="@Localizer["General_Loading"]"
                     EmptyText="@Localizer["List_Result_NoItems"]"
                     EndOfListText="@Localizer["List_Result_EndOfList"]"
                     ItemClick="OnItemClick" />
}

@code {
    [Parameter] public string Kind { get; set; } = string.Empty;
    [Parameter] public string SubKind { get; set; } = string.Empty;
    [Parameter] public string? Id { get; set; }

    private IListProvider? _provider;

    private string GetKindTitle() => (Kind ?? string.Empty).Trim().ToLowerInvariant() switch
    {
        "accounts" => Localizer["General_Title_Account"],
        "contacts" => Localizer["General_Title_Contact"],
        _ => Kind
    };

    protected override async Task OnParametersSetAsync()
    {
        var factory = ActivatorUtilities.CreateInstance<ListViewModelFactory>(Services);
        ListFactoryResult? result = factory.Create(Kind, SubKind, Id);

        // unsubscribe previous provider's UiActionRequested if applicable
        if (_provider is BaseViewModel prevVm)
        {
            prevVm.UiActionRequested -= ProviderOnUiActionRequested;
        }

        _provider = result?.Provider;
        if (_provider != null)
        {
            _provider.StateChanged += (_, __) => _ = InvokeAsync(StateHasChanged);

            if (_provider is BaseViewModel newVm)
            {
                newVm.UiActionRequested += ProviderOnUiActionRequested;
            }

            await _provider.InitializeAsync();
        }
    }

    private Task OnItemClick(object item)
    {
        if (item is IListItemNavigation nav)
        {
            var uri = nav.GetNavigateUrl();
            if (!string.IsNullOrWhiteSpace(uri))
                Nav.NavigateTo(uri);
        }
        return Task.CompletedTask;
    }

    private void ProviderOnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e)
    {
        var action = e?.Action;
        var payload = e?.Payload;
        if (string.IsNullOrWhiteSpace(action)) return;
        _ = InvokeAsync(() => HandleProviderAction(action!, payload));
    }

    private void HandleProviderAction(string action, string? payload = null)
    {
        switch (action)
        {
            case "New":
                var kind = (Kind ?? string.Empty).Trim().ToLowerInvariant();
                var emptyId = Guid.Empty.ToString();
                Nav.NavigateTo($"/card/{kind}/{emptyId}");
                break;
            case "Back":
                // For postings lists, navigate back to card of calling dataset
                if ((Kind ?? string.Empty).Trim().ToLowerInvariant() == "postings")
                {
                    var sub = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
                    var mapped = sub switch
                    {
                        "account" => "accounts",
                        "contact" => "contacts",
                        "savings-plan" => "savings-plans",
                        "security" => "securities",
                        _ => null
                    };
                    if (mapped != null && Guid.TryParse(Id, out var gid))
                    {
                        Nav.NavigateTo($"/card/{mapped}/{gid}");
                        break;
                    }
                }
                // fallback: navigate to list root
                Nav.NavigateTo($"/list/{Kind}");
                break;
            case "ExportCsv":
            case "ExportXlsx":
                // build export url for postings lists based on subkind and provider state
                if ((Kind ?? string.Empty).Trim().ToLowerInvariant() == "postings" && _provider != null)
                {
                    var sub = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
                    var apiSub = sub; // account, contact, savings-plan, security
                    if (!string.IsNullOrWhiteSpace(apiSub) && Guid.TryParse(Id, out var cid))
                    {
                        var fmt = action == "ExportCsv" ? "csv" : "xlsx";
                        var parts = new List<string> { $"format={Uri.EscapeDataString(fmt)}" };
                        if (!string.IsNullOrWhiteSpace(_provider.Search)) parts.Add($"q={Uri.EscapeDataString(_provider.Search)}");
                        if (_provider.RangeFrom.HasValue) parts.Add($"from={_provider.RangeFrom.Value:O}");
                        if (_provider.RangeTo.HasValue) parts.Add($"to={_provider.RangeTo.Value:O}");
                        var qs = parts.Count > 0 ? ("?" + string.Join('&', parts)) : string.Empty;
                        var url = $"/api/postings/{apiSub}/{cid}/export{qs}";
                        var js = $"(function(){{var a=document.createElement('a'); a.href={System.Text.Json.JsonSerializer.Serialize(url)}; a.download=''; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a),200);}})()";
                        try { JS.InvokeVoidAsync("eval", js); } catch { Nav.NavigateTo(url, forceLoad: true); }
                    }
                }
                break;
        }
    }
}
