@page "/list/{Kind}/{SubKind?}/{Id?}"
@rendermode InteractiveServer
@inject IServiceProvider Services
@inject NavigationManager Nav
@inject Microsoft.Extensions.Localization.IStringLocalizer<Pages>? Localizer
@inject IJSRuntime JS
@using FinanceManager.Web.Components.Shared
@using FinanceManager.Web.Extensions
@using FinanceManager.Web.ViewModels
@using FinanceManager.Web.ViewModels.Common
@using System.Resources
@using System.Globalization
@using System.Collections
@using FinanceManager.Shared.Dtos.Statements
@using FinanceManager.Shared.Dtos.Admin

<PageTitle>@($"{Localizer["General_PageTitle"]}: {GetKindTitle()}")</PageTitle>

@if (_provider == null)
{
    <h3>@Localizer["General_PageTitle"]: @GetKindTitle()</h3>

    <p>@Localizer["General_Loading"]</p>
}
else
{
    @* Render ribbon here so upload UI can be positioned directly under it *@
    <Ribbon TTabEnum="TabId" Provider="(IRibbonProvider)_provider" Localizer="Localizer" />

    <h3>@Localizer["General_PageTitle"]: @GetKindTitle()</h3>

    <UploadStatus ViewModel="@(_provider as FinanceManager.Web.ViewModels.Common.IUploadFilesViewModel)"
                  CreatedCount="@_uploadCreatedCount"
                  FirstDraftId="@_firstCreatedDraftId"
                  Error="@_uploadError" />

    @* Background task status panel for viewmodel-specific task types *@
    <BackgroundTaskStatusPanel AllowedTypes="@((_provider as BaseViewModel)?.VisibleBackgroundTaskTypes)" />

    <GenericListPage TItem="object"
                     Provider="_provider"
                     Localizer="Localizer"
                     SearchPlaceholder="@Localizer["List_SearchPlaceholder"]"
                     RangeFromLabel="@Localizer["List_SearchFrom"]"
                     RangeToLabel="@Localizer["List_SearchTo"]"
                     LoadingText="@Localizer["General_Loading"]"
                     EmptyText="@Localizer["List_Result_NoItems"]"
                     EndOfListText="@Localizer["List_Result_EndOfList"]"
                     ItemClick="OnItemClick" />

    
    @* Generic overlay rendering for list providers *@
    @if (_overlayVisible && _overlaySpec is not null)
    {
        <div class="split-center" @onclick="(()=> CloseOverlay())">
            <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                    <h3 style="margin:0;font-size:1rem;">@GetOverlayTitle()}</h3>
                    <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=> CloseOverlay())"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
                @{ 
                    IDictionary<string, object?>? parms = null;
                    if (_overlaySpec.Parameters != null)
                    {
                        parms = _overlaySpec.Parameters.Where(kvp => !string.Equals(kvp.Key, "OverlayTitle", StringComparison.OrdinalIgnoreCase)
                                                                    && !string.Equals(kvp.Key, "Visible", StringComparison.OrdinalIgnoreCase))
                                    .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
                    }

                    Action overlayClose = CloseOverlay;
                    Action<object> overlayOnFinished = obj =>
                    {
                        CloseOverlay();
                        _ = Nav.NavigateToModelCard(obj);
                    };
                }
                <CascadingValue Name="OverlayClose" Value="@(overlayClose)">
                    <CascadingValue Name="OverlayOnFinished" Value="@(overlayOnFinished)">
                        <DynamicComponent Type="_overlaySpec.ComponentType" Parameters="parms" />
                    </CascadingValue>
                </CascadingValue>
            </div>
        </div>
    }
}

@code {
    private enum TabId { List }
    [Parameter] public string Kind { get; set; } = string.Empty;
    [Parameter] public string SubKind { get; set; } = string.Empty;
    [Parameter] public string? Id { get; set; }

    private IListProvider? _provider;

    // Overlay state
    private BaseViewModel.UiOverlaySpec? _overlaySpec;
    private bool _overlayVisible;

    // Upload result fields
    private int _uploadCreatedCount;
    private Guid? _firstCreatedDraftId;
    // Page-level upload configuration and error
    private int _maxUploadFiles = 10; // configurable limit for GetMultipleFiles
    private string? _uploadError;

    private string GetKindTitle()
    {
        var kind = (Kind ?? string.Empty).Trim().ToLowerInvariant();
        var sub = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
        if (kind == "contacts" && sub == "categories")
        {
            return Localizer["General_Title_Contact_Categories"];
        }
        if (kind == "savings-plans" && sub == "categories")
        {
            return Localizer["General_Title_SavingsPlan_Categories"];
        }
        if (kind == "securities" && sub == "categories")
        {
            return Localizer["General_Title_Securities_Categories"];
        }
        return kind switch
        {
            "accounts" => Localizer["General_Title_Account"],
            "statement-drafts" => Localizer["General_Title_StatementDrafts"],
            "contacts" => Localizer["General_Title_Contact"],
            "savings-plans" => Localizer["General_Title_SavingsPlans"],
            "postings" => Localizer["General_Title_Postings"],
            "securities" => Localizer["General_Title_Securities"],
            _ => Kind
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        var factory = ActivatorUtilities.CreateInstance<ListViewModelFactory>(Services);
        ListFactoryResult? result = factory.Create(Kind, SubKind, Id);

        // unsubscribe previous provider's UiActionRequested if applicable
        if (_provider is BaseViewModel prevVm)
        {
            prevVm.UiActionRequested -= ProviderOnUiActionRequested;
        }

        _provider = result?.Provider;
        if (_provider != null)
        {
            _provider.StateChanged += (_, __) => _ = InvokeAsync(StateHasChanged);

            if (_provider is BaseViewModel newVm)
            {
                newVm.UiActionRequested += ProviderOnUiActionRequested;
            }

            await _provider.InitializeAsync();
        }
    }

    private Task OnItemClick(object item)
    {
        if (item is IListItemNavigation nav)
        {
            var uri = nav.GetNavigateUrl();
            if (!string.IsNullOrWhiteSpace(uri))
                Nav.NavigateTo(uri);
        }
        return Task.CompletedTask;
    }

    private void ProviderOnUiActionRequested(object? sender, FinanceManager.Web.ViewModels.Common.BaseViewModel.UiActionEventArgs? e)
    {
        // If a rich object payload (e.g. UiOverlaySpec) was provided, render it generically
        if (e?.PayloadObject is BaseViewModel.UiOverlaySpec spec)
        {
            _overlaySpec = spec;
            _overlayVisible = true;
            _ = InvokeAsync(StateHasChanged);
            return;
        }

        var action = e?.Action;
        var payload = e?.Payload;
        if (string.IsNullOrWhiteSpace(action)) return;
        _ = InvokeAsync(async () => await HandleProviderActionAsync(action!, payload));
    }

    private async Task HandleProviderActionAsync(string action, string? payload = null)
    {
        switch (action)
        {
            case "New":
                var kindNorm = (Kind ?? string.Empty).Trim().ToLowerInvariant();
                var subKindNorm = string.IsNullOrWhiteSpace(SubKind) ? null : (SubKind ?? string.Empty).Trim().ToLowerInvariant();
                Nav.NavigateToModelCreate(kindNorm, subKindNorm);
                break;
            case "OpenCategories":
                Nav.NavigateToModelCategories(Kind);
                break;
            case "Back":
                // For postings lists, navigate back to card of calling dataset
                if ((Kind ?? string.Empty).Trim().ToLowerInvariant() == "postings")
                {
                    var sub = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
                    var mapped = sub switch
                    {
                        "account" => "accounts",
                        "contact" => "contacts",
                        "savings-plan" => "savings-plans",
                        "security" => "securities",
                        _ => null
                    };
                    if (mapped != null && Guid.TryParse(Id, out var gid))
                    {
                        Nav.NavigateTo($"/card/{mapped}/{gid}");
                        break;
                    }
                }
                // fallback: navigate to list root
                Nav.NavigateTo($"/list/{Kind}");
                break;
            case "Reload":
                if (_provider != null)
                {
                    _provider.ResetAndSearch();
                    await _provider.LoadAsync();
                }
                break;
            case "ClearFilter":
            case "ClearSearch":
                if (_provider != null)
                {
                    _provider.ClearSearch();
                    _provider.ClearRange();
                    _provider.ResetAndSearch();
                    await _provider.LoadAsync();
                }
                break;
            case "ExportCsv":
            case "ExportXlsx":
                // build export url for postings lists based on subkind and provider state
                if ((Kind ?? string.Empty).Trim().ToLowerInvariant() == "postings" && _provider != null)
                {
                    var sub = (SubKind ?? string.Empty).Trim().ToLowerInvariant();
                    var apiSub = sub; // account, contact, savings-plan, security
                    if (!string.IsNullOrWhiteSpace(apiSub) && Guid.TryParse(Id, out var cid))
                    {
                        var fmt = action == "ExportCsv" ? "csv" : "xlsx";
                        var parts = new List<string> { $"format={Uri.EscapeDataString(fmt)}" };
                        if (!string.IsNullOrWhiteSpace(_provider.Search)) parts.Add($"q={Uri.EscapeDataString(_provider.Search)}");
                        if (_provider.RangeFrom.HasValue) parts.Add($"from={_provider.RangeFrom.Value:O}");
                        if (_provider.RangeTo.HasValue) parts.Add($"to={_provider.RangeTo.Value:O}");
                        var qs = parts.Count > 0 ? ("?" + string.Join('&', parts)) : string.Empty;
                        var url = $"/api/postings/{apiSub}/{cid}/export{qs}";
                        var js = $"(function(){{var a=document.createElement('a'); a.href={System.Text.Json.JsonSerializer.Serialize(url)}; a.download=''; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a),200);}})()";
                        try { await JS.InvokeVoidAsync("eval", js); } catch { Nav.NavigateTo(url, forceLoad: true); }
                    }
                }
                break;
            case "Import":
                // Import handled by Ribbon FileCallback; no page-local input invocation required.
                break;
        }
    }

    private void CloseOverlay()
    {
        _overlayVisible = false;
        _overlaySpec = null;
        StateHasChanged();
    }

    private string GetOverlayTitle()
    {
        if (_overlaySpec == null) return string.Empty;
        if (_overlaySpec.Parameters != null && _overlaySpec.Parameters.TryGetValue("OverlayTitle", out var v) && v is string s && !string.IsNullOrWhiteSpace(s)) return s;
        var t = _overlaySpec.ComponentType;
        if (t == typeof(FinanceManager.Web.Components.Shared.AttachmentsPanel)) return Localizer["Attachments_Title"];
        if (t == typeof(FinanceManager.Web.Components.Shared.ContactMergePanel)) return Localizer["Merge_Title"];
        if (t == typeof(FinanceManager.Web.Components.Shared.SecurityPricesBackfillPanel)) return Localizer["SecurityPricesBackfill_Title"];
        return Localizer["Attachments_Title"];
    }
}
