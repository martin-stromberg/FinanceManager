@page "/statement-drafts/{DraftId:guid}/entries/{EntryId:guid}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IServiceProvider Services
@using FinanceManager.Domain.Statements
@using Microsoft.Extensions.Localization
@using FinanceManager.Web.Components.Shared
@using Microsoft.Extensions.DependencyInjection
@using FinanceManager.Web.ViewModels.StatementDrafts
@inject IStringLocalizer<Components.Pages.StatementDraftEntryDetail> Localizer
@using FinanceManager.Domain.Attachments
@using FinanceManager.Shared.Dtos.Statements
@using FinanceManager.Shared.Dtos.SavingsPlans
@using FinanceManager.Shared.Dtos.Contacts
@using FinanceManager.Shared.Dtos.Securities

<h3>@Localizer["Title"]</h3>

<Ribbon TTabEnum="TabId" Provider="_vm" Localizer="Localizer" />

@if (_vm.Loading)
{
    <p>@Localizer["Loading"]</p>
}
else
{    
    <p><strong>@Localizer["DraftFile"]</strong> @_vm.OriginalFileName</p>
    @if(_vm.EntryValidation != null)
    {
        <div style="margin-bottom:1rem;padding:.5rem .75rem;border:1px solid #444;border-radius:4px;background:#181818;max-width:960px;">
            <h4 style="margin:.2rem 0 .4rem 0;font-size:.8rem;">@Localizer["Validation_Header"]</h4>
            @if(!_vm.EntryValidation!.Messages.Any())
            {
                <p style="margin:0;font-size:.7rem;color:#6c6;">@Localizer["Validation_NoIssues"]</p>
            }
            else
            {
                <ul style="margin:.25rem 0 0 1rem;padding:0;font-size:.65rem;">
                    @foreach(var m in _vm.EntryValidation!.Messages)
                    {
                        var c = m.Severity=="Error"?"#e66":"#cc6";
                        <li style="margin:.2rem 0;color:@c;">@m.Message</li>
                    }
                </ul>
            }
        </div>
    }
    @if(_vm.ShowBookWarnings && _vm.LastBookingResult != null)
    {
        <div class="panel" style="margin-bottom:1rem;padding:.5rem .75rem;border:1px solid #665;border-radius:4px;background:#2a1f1f;max-width:960px;">
            <h4 style="margin:.2rem 0 .4rem 0;font-size:.8rem;">@Localizer["Warnings"]</h4>
            <ul style="margin:.25rem 0 0 1rem;padding:0;font-size:.65rem;">
                @foreach(var m in _vm.LastBookingResult.Validation.Messages.Where(m=>m.Severity=="Warning"))
                {
                    <li style="margin:.2rem 0;color:#cc6;">@m.Message</li>
                }
            </ul>
            <div style="margin-top:.5rem;display:flex;gap:.5rem;">
                <button class="icon-btn" @onclick="ConfirmBookEntry"><svg><use href="/icons/sprite.svg#check" /></svg>&nbsp;@Localizer["BtnBookAnyway"]</button>
                <button class="icon-btn" @onclick="(()=>{ _vm.ClearBookWarnings(); })"><svg><use href="/icons/sprite.svg#clear" /></svg>&nbsp;@Localizer["Cancel"]</button>
            </div>
        </div>
    }
    <div style="margin-bottom:1rem;">
        <label><input type="checkbox" @bind="_vm.EditMode" @bind:after="(()=>{})" disabled="@_vm.IsReadOnly" /> @Localizer["EditMode"]</label>
        @if (_vm.IsDuplicate)
        {
            <div style="margin-top:.3rem;color:#cc6;font-size:.75rem;">@Localizer["Msg_ReadOnlyAlreadyBooked"]</div>
        }
        @if (_vm.IsAnnounced)
        {
            <div style="margin-top:.3rem;color:#cc6;font-size:.75rem;">@Localizer["Msg_ReadOnlyAnnounced"]</div>
        }
        @if (_vm.EditMode && !_vm.IsReadOnly)
        {
            <div class="edit-core" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;margin-top:.5rem;max-width:960px;">
                <div>
                    <label>@Localizer["Label_BookingDate"]</label>
                    <InputDate @bind-Value="_editBookingDate" @bind-Value:after="MarkDirty" />
                </div>
                <div>
                    <label>@Localizer["Label_ValutaDate"]</label>
                    <InputDate @bind-Value="_editValutaDate" @bind-Value:after="MarkDirty" />
                </div>
                <div>
                    <label>@Localizer["Label_Amount"]</label>
                    <InputNumber @bind-Value="_editAmount" @bind-Value:after="MarkDirty" />
                </div>
                <div>
                    <label>@Localizer["Label_Currency"]</label>
                    <InputText @bind-Value="_editCurrency" @bind-Value:after="MarkDirty" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>@Localizer["Label_Subject"]</label>
                    <InputText @bind-Value="_editSubject" @bind-Value:after="MarkDirty" style="width:100%;" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>@Localizer["Label_Recipient"]</label>
                    <InputText @bind-Value="_editRecipient" @bind-Value:after="MarkDirty" style="width:100%;" />
                </div>
                <div style="grid-column:1/-1;">
                    <label>@Localizer["Label_Description"]</label>
                    <textarea @bind="_editDescription" @bind:after="(()=>MarkDirty())" rows="3" style="width:100%;"></textarea>
                </div>
                <div style="grid-column:1/-1;display:flex;gap:.5rem;">
                    <button class="icon-btn" disabled="@_savingCore" @onclick="SaveCoreAsync"><svg><use href="/icons/sprite.svg#save" /></svg>&nbsp;@Localizer["BtnSave"]</button>
                    <button type="button" class="icon-btn" disabled="@_savingCore" @onclick="ResetCoreEdits">@Localizer["BtnReset"]</button>
                </div>
                @if(!string.IsNullOrEmpty(_coreError))
                {
                    <div style="grid-column:1/-1;color:#f77;font-size:.8rem;">@_coreError</div>
                }
            </div>
        }
    </div>
    <table class="fm-table" style="max-width:960px;">
        <tbody>
            <tr><th style="width:180px;">@Localizer["Th_BookingDate"]</th><td>@_vm.Entry.BookingDate.ToShortDateString()</td></tr>
            <tr><th>@Localizer["Th_ValutaDate"]</th><td>@(_vm.Entry.ValutaDate?.ToShortDateString() ?? "-")</td></tr>
            <tr>
                <th>@Localizer["Th_Amount"]</th>
                <td>
                    @_vm.Entry.Amount @_vm.Entry.CurrencyCode
                    @if(_vm.SplitSum != null)
                    {
                        <span style="opacity:.7;"> (@Localizer["SplitSum"]: @_vm.SplitSum
                            @if(_vm.Difference is decimal d && d != 0)
                            {
                                <text>; @Localizer["Diff"]: @d</text>
                            }
                            )</span>
                    }
                </td>
            </tr>
            <tr><th>@Localizer["Th_Subject"]</th><td class="wrap">@_vm.Entry.Subject</td></tr>
            <tr><th>@Localizer["Th_Recipient"]</th><td class="wrap">@(_vm.Entry.RecipientName ?? "-")</td></tr>
            <tr><th>@Localizer["Th_Description"]</th><td class="wrap">@(_vm.Entry.BookingDescription ?? "-")</td></tr>
            <tr><th>@Localizer["Th_Announced"]</th><td>@(_vm.Entry.IsAnnounced ? Localizer["Yes"] : Localizer["No"])</td></tr>
            <tr><th>@Localizer["Th_Status"]</th><td>@_vm.Entry.Status</td></tr>
            @if (!_vm.IsReadOnly)
            {
            <tr>
                <th>@Localizer["Th_Contact"]</th>
                <td>
                    <div class="contact-combobox" style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:420px;margin-bottom:1rem;">
                        <div style="position:relative;min-width:0;">
                            <input type="text" style="width:95%;" @bind="_vm.ContactFilter" @bind:event="oninput" @bind:after="(()=>{OnContactFilterAfterChanged();})" placeholder='@Localizer["Placeholder_FilterContacts"]' @onfocus="ShowDropdown" />
                            <input type="hidden" value="@_selectedContactId" />
                            @if (_dropdownVisible)
                            {
                                <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                        <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectContact(null))" class="@( _selectedContactId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                    @foreach(var c in _vm.FilteredContacts)
                                    {
                                            <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectContact(c.Id))" class="@( _selectedContactId==c.Id?"active":string.Empty)" title="@c.Name">@c.Name</li>
                                    }
                                        @if (!_vm.FilteredContacts.Any())
                                    {
                                        <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                    }
                                </ul>
                            }
                            @if(!string.IsNullOrEmpty(_contactError))
                            {
                                <div style="color:#e66;font-size:.8rem;margin-top:.3rem;">@_contactError</div>
                            }
                        </div>
                        <div>
                            <button class="icon-btn" title='@Localizer["BtnNewContact"]' aria-label='@Localizer["BtnNewContact"]' @onclick="OpenCreateContact"><svg><use href="/icons/sprite.svg#plus" /></svg></button>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <th>@Localizer["Th_CostNeutral"]</th>
                <td><InputCheckbox @bind-Value="IsCostNeutral" @bind-Value:after="(()=> { MarkDirty(); })" /></td>
            </tr>
            <tr>
                <th>@Localizer["Th_SavingsPlan"]</th>
                <td>
                    <div class="savingsplan-combobox" style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:420px;margin-bottom:.75rem;">
                        <div style="position:relative;min-width:0;">
                            <input type="text" style="width:95%;" @bind="_vm.SavingsPlanFilter" @bind:event="oninput" @bind:after="(()=>{OnSavingsPlanFilterAfterChanged();})" placeholder='@Localizer["Placeholder_FilterSavingsPlans"]' @onfocus="ShowSavingsPlanDropdown" />
                            <input type="hidden" value="@_selectedSavingsPlanId" />
                            @if (_savingsPlanDropdownVisible)
                            {
                                <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                    <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectSavingsPlan(null))" class="@( _selectedSavingsPlanId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                    @foreach(var plan in _vm.FilteredSavingsPlans)
                                    {
                                        <li style="padding:.3rem .4rem;cursor:pointer;" @onclick="(()=>SelectSavingsPlan(plan.Id))" class="@( _selectedSavingsPlanId==plan.Id?"active":string.Empty)" title="@plan.Name">@plan.Name</li>
                                    }
                                    @if(!_vm.FilteredSavingsPlans.Any())
                                    {
                                        <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                    }
                                </ul>
                            }
                        </div>
                        <div style="display:flex;gap:.35rem;">
                            <button class="icon-btn" title='@Localizer["BtnNewSavingsPlan"]' aria-label='@Localizer["BtnNewSavingsPlan"]' @onclick="OpenCreateSavingsPlan" disabled="@(!CanCreateSavingsPlan)"><svg><use href="/icons/sprite.svg#plus" /></svg></button>
                        </div>
                    </div>
                    @if(_selectedSavingsPlanId != null || _vm.Entry.SavingsPlanId != null)
                    {
                        <div style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0 .5rem 0;max-width:420px;">
                            <InputCheckbox @bind-Value="_archiveSavingsPlanOnBooking" @bind-Value:after="(()=> { _vm?.MarkDirty(); })" />
                            <span>@Localizer["ArchiveSavingsPlanOnBooking"]</span>
                        </div>
                    }
                </td>
            </tr>
            @if(_vm.ShowSecuritySection)
            {
                <tr>
                    <th>@Localizer["Th_Security"]</th>
                    <td>
                        <div style="display:grid;grid-template-columns:1fr auto;align-items:start;gap:.5rem;max-width:480px;margin-bottom:.75rem;">
                            <div style="position:relative;min-width:0;">
                                <input type="text"
                                       style="width:95%;"
                                       @bind="_vm.SecurityFilter"
                                       @bind:event="oninput"
                                       @bind:after="(()=>{OnSecurityFilterChanged();})"
                                       placeholder='@Localizer["Placeholder_FilterSecurities"]'
                                       @onfocus="ShowSecurityDropdown" />
                                <input type="hidden" value="@_selectedSecurityId" />
                                @if (_securityDropdownVisible)
                                {
                                    <ul class="combo-list" style="list-style:none;margin:0;padding:.25rem .25rem;position:absolute;z-index:10;left:0;right:0;max-height:9.5rem;overflow:auto;background:#222;border:1px solid #444;border-radius:4px;box-shadow:0 3px 12px #0005;">
                                        <li style="padding:.3rem .4rem;cursor:pointer;"
                                            @onclick="(()=>SelectSecurity(null))"
                                            class="@(_selectedSecurityId==null?"active":string.Empty)">-- @Localizer["None"] --</li>
                                        @foreach(var s in _vm.FilteredSecurities)
                                        {
                                            <li style="padding:.3rem .4rem;cursor:pointer;"
                                                @onclick="(()=>SelectSecurity(s.Id))"
                                                class="@(_selectedSecurityId==s.Id?"active":string.Empty)"
                                                title="@s.Name">@s.Name (@s.Identifier)</li>
                                        }
                                        @if(!_vm.FilteredSecurities.Any())
                                        {
                                            <li style="padding:.3rem .4rem;opacity:.6;">@Localizer["NoMatches"]</li>
                                        }
                                    </ul>
                                }
                                @if(!string.IsNullOrEmpty(_securityError))
                                {
                                    <div style="margin-top:.3rem;color:#e66;font-size:.75rem;">@_securityError</div>
                                }
                            </div>
                            <div>
                                <button class="icon-btn" title='@Localizer["BtnNewSecurity"]' aria-label='@Localizer["BtnNewSecurity"]' @onclick="OpenCreateSecurity"><svg><use href="/icons/sprite.svg#plus" /></svg></button>
                            </div>
                        </div>
                        @if (_selectedSecurityId != null)
                        {
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.6rem;max-width:720px;margin-top:.25rem;">\n                                <div>
                                    <label>@Localizer["Label_TxType"]</label>
                                    <select @bind="_securityTxType" @bind:after="(()=>{MarkDirty();})">
                                        <option value="">--</option>
                                        <option value="Buy">@Localizer["Tx_Buy"]</option>
                                        <option value="Sell">@Localizer["Tx_Sell"]</option>
                                        <option value="DividendOrInterest">@Localizer["Tx_DividendOrInterest"]</option>
                                    </select>
                                </div>
                                <div>
                                    <label>@Localizer["Label_Quantity"]</label>
                                    <input type="text" @bind="_securityQuantityExpr" @bind:event="oninput" @bind:after="MarkDirty" @onblur="ParseSecurityQuantity" />
                                </div>
                                <div>
                                    <label>@Localizer["Label_Fee"]</label>
                                    <input type="text" @bind="_securityFeeExpr" @bind:event="oninput" @bind:after="MarkDirty" @onblur="ParseSecurityFee" />
                                </div>
                                <div>
                                    <label>@Localizer["Label_Tax"]</label>
                                    <input type="text" @bind="_securityTaxExpr" @bind:event="oninput" @bind:after="MarkDirty" @onblur="ParseSecurityTax" />
                                </div>
                            </div>
                            @if(!string.IsNullOrEmpty(_securityExprError))
                            {
                                <div style="margin-top:.25rem;color:#e66;font-size:.75rem;">@_securityExprError</div>
                            }
                        }
                    </td>
                </tr>
                }
            }
        </tbody>
    </table>

    @if (_vm?.ShowSplitDialog == true)
    {
        <div class="modal-backdrop split-center">
            <div class="modal split-dialog" role="dialog" aria-modal="true" aria-label='@Localizer["Split_SelectTitle"]' style="overflow-x:hidden;">
                <h3 style="margin-top:0;">@Localizer["Split_SelectTitle"]</h3>
                @if(_vm?.Entry.SplitDraftId != null)
                {
                    <p style="margin:.15rem 0 .4rem 0;font-size:.7rem;opacity:.7;">@Localizer["Split_CurrentlyLinked"] @_vm.Entry.SplitDraftId</p>
                }
                <p style="margin-top:.2rem;opacity:.8;font-size:.85rem;">@Localizer["Split_SelectHint"]</p>
                <input type="text" @bind="_vm.SplitFilter" placeholder='@Localizer["Filter"]' style="margin:.5rem 0 .75rem 0;" />
                <div class="split-scroll" style="overflow-x:hidden;">
                    @if(_vm.LoadingSplits)
                    {
                        <div class="split-hint">@Localizer["Loading"]</div>
                    }
                    else
                    {
                        @foreach(var d in _vm.FilteredSplitDrafts)
                        {
                            <div class="split-row @(d.DraftId==_vm.SelectedSplitDraftId? "active" : string.Empty)" @onclick="(()=>_vm.SelectSplit(d.DraftId))">
                                <div class="name" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">@d.OriginalFileName</div>
                                <div class="meta">@d.Entries.Count @Localizer["Entries"] · @Localizer["Total"] @d.TotalAmount</div>
                            </div>
                        }
                        @if(!_vm.FilteredSplitDrafts.Any())
                        {
                            <div class="split-hint">@Localizer["NoMatches"]</div>
                        }
                    }
                </div>
                @if(!string.IsNullOrEmpty(_vm.SplitError))
                {
                    <div class="split-error">@_vm.SplitError</div>
                }
                <div class="split-actions">
                    <button class="icon-btn" disabled="@(_vm.SelectedSplitDraftId==null)" @onclick="ConfirmSplit" title='@Localizer["Apply"]' aria-label='@Localizer["Apply"]'><svg><use href="/icons/sprite.svg#check" /></svg></button>
                    <button class="icon-btn" @onclick="(()=>_vm.CloseSplitDialog())" title='@Localizer["Cancel"]' aria-label='@Localizer["Cancel"]'><svg><use href="/icons/sprite.svg#clear" /></svg></button>
                </div>
            </div>
        </div>
    }
}

@if (_showAttachments)
{
    <div class="split-center" @onclick="(()=> _showAttachments = false)">
        <div class="split-dialog" style="max-width:90vH;" @onclick:stopPropagation="true">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem;">
                <h3 style="margin:0;font-size:1rem;">@Localizer["Attachments_Title"]</h3>
                <button class="icon-btn" title='@Localizer["Btn_Close"]' @onclick="(()=>_showAttachments=false)"><svg><use href="/icons/sprite.svg#clear" /></svg></button>
            </div>
            <AttachmentsPanel ParentKind="@AttachmentEntityKind.StatementDraftEntry" ParentId="@EntryId" />
        </div>
    </div>
}

@code {
    // Ribbon State
    private enum TabId { Entry }
    // assume VM always initialized in OnInitialized; use null-forgiving to avoid repetitive null checks
    private StatementDraftEntryDetailViewModel _vm = null!;

    protected override void OnInitialized()
    {
        if (_vm == null)
        {
            _vm = ActivatorUtilities.CreateInstance<StatementDraftEntryDetailViewModel>(Services);
            _vm.StateChanged += OnRibbonStateChanged;
            _vm.UiActionRequested += RibbonVmOnUiActionRequested;
        }
    }

    private void OnRibbonStateChanged(object? sender, EventArgs e) => _ = InvokeAsync(StateHasChanged);

    private void RibbonVmOnUiActionRequested(object? sender, string? action)
    {
        if (string.IsNullOrEmpty(action)) return;
        _ = InvokeAsync(() => HandleRibbonActionAsync(action!));
    }

    private void RebuildAfter(Action action)
    {
        action();
    }
    // Minimal implementations to satisfy shared ribbon actions used across pages.
    // These intentionally delegate to the statement-drafts listing where the real upload / dialogs live.
    private async Task TriggerFileInputAsync()
    {
        try
        {
            // Try to click the hidden input
            await JS.InvokeVoidAsync("eval", "document.getElementById('draft-upload-input')?.click();");
        }
        catch { }
    }

    private async Task OnHiddenFileChanged(InputFileChangeEventArgs e)
    {
        // Hide input again
        try
        {
            await JS.InvokeVoidAsync("eval", "(function(){var inp=document.getElementById('draft-upload-input'); if(inp){inp.style.left='-9999px';inp.style.opacity='0';inp.style.pointerEvents='none';}})()");
        }
        catch { }

        // Navigate to drafts page where uploaded files are handled centrally
        Nav.NavigateTo("/statement-drafts");
    }

    private void OpenDeleteAllDialog() => Nav.NavigateTo("/statement-drafts");
    private void OpenBookAllDialog() => Nav.NavigateTo("/statement-drafts");

    [Parameter] public Guid DraftId { get; set; }
    [Parameter] public Guid EntryId { get; set; }
    [Parameter, SupplyParameterFromQuery] public string? Src { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryDraftId { get; set; }
    [Parameter, SupplyParameterFromQuery] public Guid? FromEntryId { get; set; }
    private string ContextQuery => string.Equals(Src, "entry", StringComparison.OrdinalIgnoreCase) && FromEntryDraftId.HasValue && FromEntryId.HasValue
        ? $"?src=entry&fromEntryDraftId={FromEntryDraftId}&fromEntryId={FromEntryId}"
        : string.Empty;
    private string AppendContext(string baseUrl)
    {
        if (string.IsNullOrEmpty(ContextQuery)) { return baseUrl; }
        if (baseUrl.Contains('?')) { return baseUrl + "&" + ContextQuery.TrimStart('?'); }
        return baseUrl + ContextQuery;
    }
    private bool HasOriginEntryContext => !string.IsNullOrEmpty(ContextQuery);

    private string _contactFilter = string.Empty;
    private CancellationTokenSource? _contactFilterCts;
    private Guid? _selectedContactId;
    private string? _contactError;
    private bool _dropdownVisible;
    private bool _pendingSave;
    private bool _IsCostNeutral;
    private bool IsCostNeutral { get => _IsCostNeutral; set { if (_IsCostNeutral != value) { _IsCostNeutral = value; MarkDirty(); } } }

    private bool _hasUnsavedChanges;
    private void MarkDirty()
    {
        if (_vm != null) { _vm.MarkDirty(); }
    }
    private void ClearDirty()
    {
        if (_vm != null) { _vm.ClearDirty(); }
    }

    // Delegate contact selection to the ViewModel — do NOT persist immediately anymore
    private async Task SelectContact(Guid? id)
    {
        _selectedContactId = id;
        _dropdownVisible = false;
        _contactError = null;

        try
        {
            // update VM state only
            _vm.SelectedContactId = id;
            // reflect chosen name in input
            var contacts = await _vm.LoadContactsAsync();
            var name = id.HasValue ? contacts.FirstOrDefault(c => c.Id == id)?.Name ?? string.Empty : string.Empty;
            _vm.ContactFilter = name;
            MarkDirty();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _contactError = ex.Message;
        }
    }

    // Select a security — do NOT persist immediately; update VM state and mark dirty
    private async Task SelectSecurity(Guid? id)
    {
        _selectedSecurityId = id;
        _securityDropdownVisible = false;
        _securityError = null;

        try
        {
            _vm.SelectedSecurityId = id;
            // update filter text to selected security name
            var secs = await _vm.LoadSecuritiesIfNeededAsync();
            _securityFilter = id.HasValue ? secs.FirstOrDefault(s => s.Id == id)?.Name ?? string.Empty : string.Empty;
            MarkDirty();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _securityError = ex.Message;
        }
    }

    // Select a savings plan — do NOT persist immediately; update VM state and mark dirty
    private async Task SelectSavingsPlan(Guid? id)
    {
        _selectedSavingsPlanId = id;
        _savingsPlanDropdownVisible = false;
        _contactError = null;

        try
        {
            // update VM state only
            _selectedSavingsPlanId = id;
            var plans = await _vm.LoadUserSavingsPlansAsync();
            var name = id.HasValue ? plans.FirstOrDefault(p => p.Id == id)?.Name ?? string.Empty : string.Empty;
            _vm.SavingsPlanFilter = name;
            MarkDirty();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _contactError = ex.Message;
        }
    }

    // Debounced handler invoked after the contact filter input changes
    private async void OnContactFilterAfterChanged()
    {
        _contactFilterCts?.Cancel();
        var cts = new CancellationTokenSource();
        _contactFilterCts = cts;
        try
        {
            await Task.Delay(300, cts.Token);
        }
        catch (TaskCanceledException)
        {
            return;
        }

        try
        {
            var list = await _vm.LoadContactsAsync();
            _dropdownVisible = true;
            await InvokeAsync(StateHasChanged);
        }
        catch { /* ignore errors */ }
    }

    // Debounced handler invoked after security filter input changes
    private CancellationTokenSource? _securityFilterCts;
    private async void OnSecurityFilterChanged()
    {
        _securityFilterCts?.Cancel();
        var cts = new CancellationTokenSource();
        _securityFilterCts = cts;
        try
        {
            await Task.Delay(300, cts.Token);
        }
        catch (TaskCanceledException) { return; }

        try
        {
            await _vm.LoadSecuritiesIfNeededAsync();
            _securityDropdownVisible = true;
            await InvokeAsync(StateHasChanged);
        }
        catch { }
    }

    // Debounced handler invoked after the savings plan filter input changes
    private CancellationTokenSource? _savingsPlanFilterCts;
    private async void OnSavingsPlanFilterAfterChanged()
    {
        _savingsPlanFilterCts?.Cancel();
        var cts = new CancellationTokenSource();
        _savingsPlanFilterCts = cts;
        try
        {
            await Task.Delay(300, cts.Token);
        }
        catch (TaskCanceledException)
        {
            return;
        }

        try
        {
            var list = await _vm.LoadUserSavingsPlansAsync();
            _userSavingsPlans = list.ToList();
            _savingsPlanDropdownVisible = true;
            await InvokeAsync(StateHasChanged);
        }
        catch { /* ignore errors */ }
    }

    // Show contact dropdown and ensure contacts are loaded
    private async Task ShowDropdown()
    {
        try { await _vm.LoadContactsAsync(); } catch { }
        _dropdownVisible = true;
        await InvokeAsync(StateHasChanged);
    }

    // Show savings plan dropdown and ensure plans are loaded
    private async Task ShowSavingsPlanDropdown()
    {
        try { var plans = await _vm.LoadUserSavingsPlansAsync(); _userSavingsPlans = plans.ToList(); } catch { }
        _savingsPlanDropdownVisible = true;
        await InvokeAsync(StateHasChanged);
    }

    // Show security dropdown and ensure securities are loaded
    private async Task ShowSecurityDropdown()
    {
        try { await _vm.LoadSecuritiesIfNeededAsync(); } catch { }
        _securityDropdownVisible = true;
        await InvokeAsync(StateHasChanged);
    }

    private Guid? _selectedSavingsPlanId;
    private string _savingsPlanFilter = string.Empty;
    private bool _savingsPlanDropdownVisible;
    private List<SavingsPlanDto> _userSavingsPlans = new();
    private bool _archiveSavingsPlanOnBooking;

    // Core edit
    private bool _editMode; private bool _savingCore; private string? _coreError;
    private DateTime _editBookingDate; private DateTime? _editValutaDate; private decimal _editAmount; private string _editSubject=""; private string? _editRecipient; private string? _editDescription; private string _editCurrency="EUR";

    // Securities UI State
    private List<SecurityDto> _securities = new();
    private string _securityFilter = string.Empty;
    private bool _securityDropdownVisible;
    private Guid? _selectedSecurityId;
    private string? _securityError;
    private SecurityTransactionType? _securityTxType;
    private decimal? _securityQuantity;
    private decimal? _securityFee;
    private decimal? _securityTax;

    // Expression inputs + error
    private string _securityQuantityExpr = string.Empty;
    private string _securityFeeExpr = string.Empty;
    private string _securityTaxExpr = string.Empty;
    private string? _securityExprError;

    private IEnumerable<SecurityDto> FilteredSecurities => string.IsNullOrWhiteSpace(_securityFilter)
        ? _securities
        : _securities.Where(s => s.Name.Contains(_securityFilter, StringComparison.OrdinalIgnoreCase) || s.Identifier.Contains(_securityFilter, StringComparison.OrdinalIgnoreCase));

    private bool ShowSecuritySection => _vm?.ShowSecuritySection ?? false;

    private void InitCoreEdit()
    {
        if (_vm == null) { return; }
        _editBookingDate = _vm.Entry.BookingDate;
        _editValutaDate = _vm.Entry.ValutaDate;
        _editAmount = _vm.Entry.Amount;
        _editSubject = _vm.Entry.Subject;
        _editRecipient = _vm.Entry.RecipientName;
        _editDescription = _vm.Entry.BookingDescription;
        _editCurrency = _vm.Entry.CurrencyCode;
    }

    private async Task SaveCoreAsync()
    {
        if (_vm == null) return;
        _savingCore = true;
        _coreError = null;
        try
        {
            var ok = await _vm.UpdateEntryCoreAsync(DraftId, EntryId, _editBookingDate, _editValutaDate, _editAmount, _editSubject, _editRecipient, _editCurrency, _editDescription);
            if (!ok)
            {
                _coreError = _vm.LastError ?? Localizer["Err_SaveCore"];
            }
            else
            {
                // reflect loaded values
                InitCoreEdit();
                if (_vm != null) { _vm.ClearDirty(); }
            }
        }
        finally
        {
            _savingCore = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ResetCoreEdits()
    {
        InitCoreEdit();
        if (_vm != null) { _vm.ClearDirty(); }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_vm != null)
        {
            await _vm.LoadAsync(DraftId, EntryId);
        }
        // Load contacts via VM and initialize filter/ids
        var contacts = await _vm.LoadContactsAsync();
        var contactName = _vm.Entry.ContactId != null ? contacts.FirstOrDefault(c => c.Id == _vm.Entry.ContactId)?.Name ?? string.Empty : string.Empty;
        _vm.ContactFilter = contactName;
        _selectedContactId = _vm.Entry.ContactId;

        // Load savings plans via VM
        var plans = _vm != null ? await _vm.LoadUserSavingsPlansAsync() : Array.Empty<FinanceManager.Shared.Dtos.SavingsPlans.SavingsPlanDto>();
        _userSavingsPlans = plans.ToList();
        var planName = _vm?.Entry.SavingsPlanId != null ? _userSavingsPlans.FirstOrDefault(p => p.Id == _vm.Entry.SavingsPlanId)?.Name ?? string.Empty : string.Empty;
        if (_vm != null) { _vm.SavingsPlanFilter = planName; }
        _archiveSavingsPlanOnBooking = _vm?.Entry.ArchiveSavingsPlanOnBooking ?? false;
        _selectedSavingsPlanId = _vm.Entry.SavingsPlanId;

        if (_vm?.Entry != null)
        {
            _selectedSecurityId = _vm.Entry.SecurityId;
            _securityTxType = _vm.Entry.SecurityTransactionType;
            _securityQuantity = _vm.Entry.SecurityQuantity;
            _securityFee = _vm.Entry.SecurityFeeAmount;
            _securityTax = _vm.Entry.SecurityTaxAmount;
            _securityQuantityExpr = _securityQuantity?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty;
            _securityFeeExpr = _securityFee?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty;
            _securityTaxExpr = _securityTax?.ToString(System.Globalization.CultureInfo.CurrentCulture) ?? string.Empty;
        }

        // Load securities via VM
        var secs = _vm != null ? await _vm.LoadSecuritiesIfNeededAsync() : Array.Empty<FinanceManager.Shared.Dtos.Securities.SecurityDto>();
        _securities = secs.Select(s => new SecurityDto { Id = s.Id, Name = s.Name, Identifier = s.Identifier }).OrderBy(s => s.Name).ToList();

        if (_selectedSecurityId != null && string.IsNullOrEmpty(_securityFilter))
        {
            _securityFilter = _securities.FirstOrDefault(s => s.Id == _selectedSecurityId)?.Name ?? string.Empty;
        }

        InitCoreEdit();
        ClearDirty();
    }

    private async Task<bool> ConfirmIfDirtyAsync()
    {
        if (!(_vm?.HasUnsavedChanges ?? false)) { return true; }
        try
        {
            return await JS.InvokeAsync<bool>("confirm", Localizer["ConfirmUnsavedChanges"].Value);
        }
        catch { return true; }
    }

    private Task LoadEntryAsync() => _vm != null ? _vm.LoadAsync(DraftId, EntryId) : Task.CompletedTask;

    private async Task DeleteEntry()
    {
        if (_vm == null) return;
        var ok = await _vm.DeleteEntryAsync(DraftId, EntryId);
        if (ok)
        {
            Nav.NavigateTo(AppendContext($"/statement-drafts/{DraftId}"));
        }
    }


    private bool _showBookWarnings;
    private StatementDraftBookingResultDto? _lastBookingResult;

    private async Task BookEntry()
    {
        if (_vm?.HasUnsavedChanges ?? false) { return; }
        _contactError = null;

        var ok = await _vm.BookEntryAsync(DraftId, EntryId, false);
        if (!ok)
        {
            if (_vm != null && _vm.ShowBookWarnings)
            {
                StateHasChanged();
                return;
            }
            _contactError = _vm?.LastError ?? Localizer["Err_Book"];
            return;
        }

        // success - reload entry to check if we stayed on same draft/entry
        await LoadEntryAsync();
        if (_vm != null && _vm.Entry != null && _vm.Entry.Id == EntryId)
        {
            StateHasChanged();
        }
        else
        {
            Nav.NavigateTo(AppendContext($"/statement-drafts/{DraftId}"), true);
        }
    }

    private async Task ConfirmBookEntry()
    {
        var ok = await _vm.BookEntryAsync(DraftId, EntryId, true);
        if (!ok)
        {
            _contactError = _vm?.LastError ?? Localizer["Err_Book"]; return;
        }
        // proceed to list
        _vm.ClearBookWarnings();
        await LoadEntryAsync();
        Nav.NavigateTo(AppendContext($"/statement-drafts/{DraftId}"), true);
    }


    private async Task ResetDuplicateWithConfirm()
    {
        try
        {
            var ok = await JS.InvokeAsync<bool>("confirm", Localizer["Confirm_ResetDuplicate"].Value);
            if (!ok) { return; }
        }
        catch { }

        var resp = await _vm.ResetDuplicateEntryAsync(DraftId, EntryId);
        if (resp)
        {
            await LoadEntryAsync();
            _editMode = false;
            if (_vm != null) { _vm.ClearDirty(); }
            StateHasChanged();
        }
        else
        {
            var msg = _vm?.LastError;
            _contactError = string.IsNullOrWhiteSpace(msg) ? Localizer["Err_ResetDuplicate"] : msg;
        }
    }

    private void SelectSplit(Guid draftId)
    {
        _vm.SelectSplit(draftId);
    }

    private async Task ConfirmSplit()
    {
        if (_vm.SelectedSplitDraftId == null) return;
        // Call API to assign split via VM
        var ok = await _vm.SetEntrySplitDraftAsync(DraftId, EntryId, _vm.SelectedSplitDraftId);
        if (ok)
        {
            _vm.CloseSplitDialog();
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            _vm.OpenSplitDialog();
        }
    }

    private void CloseSplitDialog()
    {
        _vm.CloseSplitDialog();
        StateHasChanged();
    }

    private void OpenCreateSavingsPlan()
    {
        var q = $"?draftId={DraftId}&entryId={EntryId}";
        Nav.NavigateTo($"/savings-plans/new{q}");
    }

    private void OpenCreateSecurity()
    {
        var q = $"?returnUrl={Uri.EscapeDataString($"/statement-drafts/{DraftId}/entries/{EntryId}")}";
        Nav.NavigateTo($"/securities/new{q}");
    }

    private void OpenCreateContact()
    {
        var name = _vm?.ContactFilter ?? string.Empty;
        var q = $"?prefillName={Uri.EscapeDataString(name)}&draftId={DraftId}&entryId={EntryId}";
        Nav.NavigateTo($"/contacts/new{q}");
    }

    private Task ParseSecurityQuantity(FocusEventArgs args)
    {
        _securityExprError = null;
        if (StatementDraftEntryDetailViewModel.TryEvalDecimal(_securityQuantityExpr, out var val))
        {
            _securityQuantity = val;
        }
        else
        {
            _securityExprError = Localizer["Err_InvalidExpression"];
        }
        return Task.CompletedTask;
    }

    private Task ParseSecurityFee(FocusEventArgs args)
    {
        _securityExprError = null;
        if (StatementDraftEntryDetailViewModel.TryEvalDecimal(_securityFeeExpr, out var val))
        {
            _securityFee = val;
        }
        else
        {
            _securityExprError = Localizer["Err_InvalidExpression"];
        }
        return Task.CompletedTask;
    }

    private Task ParseSecurityTax(FocusEventArgs args)
    {
        _securityExprError = null;
        if (StatementDraftEntryDetailViewModel.TryEvalDecimal(_securityTaxExpr, out var val))
        {
            _securityTax = val;
        }
        else
        {
            _securityExprError = Localizer["Err_InvalidExpression"];
        }
        return Task.CompletedTask;
    }

    private bool CanCreateSavingsPlan => _vm?.Entry.ContactId != null;

    private IEnumerable<SavingsPlanDto> FilteredSavingsPlans => _vm?.FilteredSavingsPlans ?? Array.Empty<SavingsPlanDto>();

    private bool _showAttachments;

    private async Task OpenSplitDialogAsync()
    {
        await _vm.OpenSplitDialogAsync();
    }

    private async Task HandleRibbonActionAsync(string action)
    {
        switch (action)
        {
            // Navigation
            case "Back":
                Nav.NavigateTo(AppendContext($"/statement-drafts/{DraftId}"));
                break;
            case "Prev":
                if (_vm?.PrevEntryId != null)
                {
                    Nav.NavigateTo(AppendContext($"/statement-drafts/{DraftId}/entries/{_vm.PrevEntryId}"));
                }
                break;
            case "NextOpen":
                if (_vm?.NextOpenEntryId != null)
                {
                    Nav.NavigateTo(AppendContext($"/statement-drafts/{DraftId}/entries/{_vm.NextOpenEntryId}"));
                }
                break;

            // Edit
            case "Save":
                // Persist all current VM/page state in one call
                var payload = new StatementDraftSaveEntryAllRequest(
                    ContactId: _selectedContactId ?? _vm.Entry.ContactId,
                    IsCostNeutral: IsCostNeutral,
                    SavingsPlanId: _selectedSavingsPlanId ?? _vm.Entry.SavingsPlanId,
                    ArchiveOnBooking: _archiveSavingsPlanOnBooking,
                    SecurityId: _selectedSecurityId ?? _vm.Entry.SecurityId,
                    TransactionType: _securityTxType,
                    Quantity: _securityQuantity,
                    FeeAmount: _securityFee,
                    TaxAmount: _securityTax
                );
                var okSaveAll = await _vm.SaveEntryAllAsync(DraftId, EntryId, payload);
                if (!okSaveAll)
                {
                    _contactError = _vm.LastError ?? Localizer["Err_SaveAll"];
                }
                else
                {
                    // clear dirty and refresh name filters to reflect committed state
                    ClearDirty();
                    await OnParametersSetAsync();
                }
                break;
            case "DeleteEntry":
                try
                {
                    var ok = await JS.InvokeAsync<bool>("confirm", Localizer["BtnDelete"].Value);
                    if (!ok) break;
                }
                catch { }
                await DeleteEntry();
                break;
            case "Reclassify":
                if (_vm != null)
                {
                    var ok = await _vm.ReclassifyAsync(DraftId, EntryId);
                    if (ok) { await LoadEntryAsync(); }
                }
                break;
            case "AssignSplit":
                await _vm.OpenSplitDialogAsync();
                 break;
            case "OpenAttachments":
                _showAttachments = true;
                StateHasChanged();
                break;

            // Book
            case "Validate":
                await _vm.ValidateEntryAsync(DraftId, EntryId);
                break;
            case "Book":
                await BookEntry();
                break;

            // Related
            case "OpenContact":
                if (_vm?.Entry.ContactId != null) { Nav.NavigateTo($"/contacts/{_vm.Entry.ContactId}"); }
                break;
            case "OpenSavingsPlan":
                if (_vm?.Entry.SavingsPlanId != null) { Nav.NavigateTo($"/savings-plans/{_vm.Entry.SavingsPlanId}"); }
                break;
            case "OpenSecurity":
                if (_vm?.Entry.SecurityId != null) { Nav.NavigateTo($"/securities/{_vm.Entry.SecurityId}"); }
                break;
            case "ResetDuplicate":
                await ResetDuplicateWithConfirm();
                break;
            case "OpenSplitDraft":
                if (_vm?.Entry?.SplitDraftId != null)
                {
                    // Eintragskontext (aktueller Draft + Entry) beim Navigieren mitgeben,
                    // damit der Ziel-Auszug zurück zum Eintrag springen kann
                    var q = $"?src=entry&fromEntryDraftId={DraftId}&fromEntryId={EntryId}";
                    Nav.NavigateTo($"/statement-drafts/{_vm.Entry.SplitDraftId}{q}");
                }
                break;
            case "RemoveSplitLink":
                if (_vm != null)
                {
                    // remove link by setting null split draft
                    var ok = await _vm.SetEntrySplitDraftAsync(DraftId, EntryId, null);
                    if (!ok)
                    {
                        // optional: show error via _contactError reuse
                        _contactError = _vm.LastError ?? Localizer["Err_AssignSplit"];
                    }
                }
                break;

            default:
                break;
        }
    }
}
<!-- Single always-present file input for iOS Safari: off-screen but not display:none/visibility:hidden -->
<InputFile id="draft-upload-input" OnChange="OnHiddenFileChanged" style="position:fixed; left:-9999px; width:1px; height:1px; opacity:0;" />

@implements IAsyncDisposable

@code {
    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_vm != null)
            {
                _vm.StateChanged -= OnRibbonStateChanged;
                _vm.UiActionRequested -= RibbonVmOnUiActionRequested;
                await _vm.DisposeAsync();
            }
        }
        catch { }
    }
}
